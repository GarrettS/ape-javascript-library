<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
    <title>Sortable List</title>
    <link rel="stylesheet" type="text/css" 
        href="">
        
<style type="text/css">
#sortList, #sortList li {
    margin: 0;
    padding: 0;
    position: relative;
}

#sortList {
    width: 200px;
}

#sortList div {
    padding: .1em 1em;
}

.drag-selected {
    background: #FFC;
}

.hiddenSelection .drag-selected {
    visibility: hidden;
}
</style>
</head>
<body>
    <ul id="sortList">
        <li><div>item 0</div></li>
        <li><div>item 1</div></li>
        <li><div>item 2</div></li>
        <li><div>item 3</div></li>
        <li><div>item 4</div></li>
        <li><div>item 5</div></li>
        <li><div>item 6</div></li>
        <li><div>item 7</div></li>
        <li><div>item 8</div></li>
        <li><div>item 9</div></li>
    </ul>
    
<div id="listProxyEl"></div>
<script src="../../../build/ape-ep-dom.js" type="text/javascript"></script>
<script src="../../../build/dom/getContainingBlock.js" type="text/javascript"></script>
<script src="../../../build/dom/getPixelCoords.js" type="text/javascript"></script>
<script src="../../../build/anim/Animation.js" type="text/javascript"></script>
<script src="../../../build/drag/Draggable.js" type="text/javascript"></script>
<script type="text/javascript">
    var sortList = document.getElementById("sortList");
    sortList.onmousedown = sortListMousedownHandler;

    var dom = APE.dom,
        Draggable = APE.drag.Draggable,
        dragOptions = { 
            proxyId : "listProxyEl",
            dragMultiple : true,
            selectedClassName : "drag-selected",
            constraint : "y"
        };
    function sortListMousedownHandler(ev){
        var target = dom.Event.getTarget(ev),
            li = target.tagName === "LI" ? target : 
	           dom.findAncestorWithTagName(target, "LI");
        var dli = Draggable.getByNode(li, dragOptions);
        dli.ondragend = dliDragEndHandler;
    }

    function dliDragEndHandler(dragEvent) {
        var style = this.el.style,
            coords = dom.Event.getCoords(dragEvent.domEvent),
            draggableList = dragEvent.draggableList,
            id, el, dt, i, insertItems = [];
        
        dom.addClass(sortList, "hiddenSelection");
        dt = getElementFromY(sortList, draggableList, coords.y);
        for(id in draggableList) {
            var el = draggableList[id].el;
            el.style.top = "";
            insertItems[insertItems.length] = el;
        }
        insertItems.sort(sortBySourceOrder);
        for(i = 0; i < insertItems.length; i++) {
            sortList.insertBefore(insertItems[i], dt);
        }
        dom.removeClass(sortList, "hiddenSelection");
    }

    function getElementFromY(list, excludeList, y){
        var lis = list.getElementsByTagName("li"),
            li,
            liY,
            listY = dom.getOffsetCoords(list).y;
        for(var i = 0; i < lis.length; i++) {
            li = lis[i];
            if(!(li.id in excludeList)) {
                liY = dom.getOffsetCoords(li).y;
                if(liY + listY > y) {
                    return li;
                }
            }
        }
        return null;
    }

    var sortBySourceOrder = function(a, b) {
        var node = document.documentElement,
            f;
        if(typeof node.sourceIndex == "number") {
            f = function(a, b){
                return a.sourceIndex - b.sourceIndex;
            };
    	} else if("compareDocumentPosition" in node) {
    		f = function (a, b) {
                //http://www.w3.org/TR/DOM-Level-3-Core/core.html#Node-DOCUMENT_POSITION_PRECEDING
                //  DOCUMENT_POSITION_PRECEDING - 2
                //    2. The second node precedes the reference node.
    				return b.compareDocumentPosition(a) - 3;
    		};
    	}
        node = null;
        return (sortBySourceOrder = f)(a, b);
    };
</script>
</body>
</html>