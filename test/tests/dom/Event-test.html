<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
    <title>DOM Event Test</title>

    <link rel="stylesheet" type="text/css" href="../../yui-test/build/logger/assets/logger.css">
    <link rel="stylesheet" type="text/css" href="../../yui-test/build/yuitest/assets/yuitest.css">
    <link rel="stylesheet" type="text/css" href="../../yui-test/assets/testlogger.css">

    <script type="text/javascript" src="../../yui-test/build/yahoo-dom-event/yahoo-dom-event.js"></script>
    <script type="text/javascript" src="../../yui-test/build/logger/logger.js"></script>
    <script type="text/javascript" src="../../yui-test/build/yuitest/yuitest-beta.js"></script>

    <script type="text/javascript" src="../../../build/APE.js"></script>
    <script type="text/javascript" src="../../../build/dom/Event.js"></script>
    <script type="text/javascript" src="../../../build/dom/viewport-f.js"></script>

</head>
<body style="position:relative;top: 10px">
<div id="template">
    <div id="testNode"><input id="testInp"><input id="testInp2"></div>
</div>
<div id="testLogger"></div>

<script type="text/javascript">
setTimeout(function(){

var dom = APE.dom,
    Event = dom.Event,
    Assert = YAHOO.util.Assert,
    Action = YAHOO.util.UserAction,
    testNode,
    testInp,
    template = document.getElementById("template"),
    templateHTML = template.innerHTML;
    

var eventTestCase = new YAHOO.tool.TestCase({
    name : "Event Test Case",

    setUp : function() {
        testNode = document.getElementById("testNode");
        testInp = document.getElementById("testInp");
    },

    tearDown : function() {
        template.innerHTML = templateHTML;
        testNode = testInp = null;
    },
    
    testGetTarget : function() {
        var target;
        if(testNode.addEventListener) {
            testNode.addEventListener("click", gotTarget, false);
        } else {
            testNode.onclick = gotTarget;
        }
        Action.click(testNode);
        function gotTarget(e){
            target = dom.Event.getTarget(e);
        }
        this.wait(function() {
            Assert.areEqual(testNode, target);
        }, 10);
    },

    testEventPayload : function() {
        // IE doesn't pass event to callbacks, so this mainly verifies 
        // that the API takes care of that.
        var isClick;

        function cb(ev) {
            isClick = ev.type === "click";
        }

        dom.Event.addCallback(document.body, "click", cb);
        Action.click(document.body);
        Assert.isTrue(isClick);
    },
    
    testAddCallback : function() {
        var context;
        dom.Event.addCallback(document.body, "click", bodyClicked);
        Action.click(document.body);

        this.wait(function() {
            Assert.areSame(document.body, context, "context was wrong");
        }, 50);

        function bodyClicked() {
            context = this;
        }
    },

    testRemoveCallback : function() {
        var called = false;
        dom.Event.addCallback(document.body, "click", bodyClicked);
        dom.Event.removeCallback(document.body, "click", bodyClicked);
        
        Action.click(document.body);
        
        this.wait(function() {
            Assert.isFalse(called, "removed function should not have been called.");
        }, 50);
        
        function bodyClicked() {
            called = true;
        }
    },

    testAddDelegatedFocus : function(){
        var called = false,
            testNode = document.getElementById("testNode");

        dom.Event.addCallback(testNode, "focus", tnFocused);
        Action.focus(document.getElementById("testInp"));
        Assert.isTrue(called, "focus handler was not called.");
        function tnFocused() {
            called = true;
        }
    },

    testRemoveDelegatedFocus : function(){
        var called = false;
        dom.Event.addCallback(testNode, "focus", tnFocused);

        dom.Event.removeCallback(testNode, "focus", tnFocused);
        Action.focus(testInp);
        this.wait(function(){
            Assert.isFalse(called, 
                 "focus handler was called, but should not have been");
        }, 100);
        function tnFocused() {
            called = true;
        }
    },

    testAddDelegatedBlur : function(){
        var called = false;

        dom.Event.addCallback(testNode, "blur", tnBlurHandler);

        Action.focus(testInp);
        testInp.focus();

        // Opera needs this.
        Action.blur(testInp);

        // IE needs this.
        testInp.blur();
        
        Action.focus(document.getElementById("testInp2"));
        Assert.isTrue(called, "blur handler was not called.");
        function tnBlurHandler() {
            called = true;
        }
    },

    testRemoveDelegatedBlur : function(){
        var called = false;

        dom.Event.addCallback(testNode, "blur",tnBlurHandler);

        dom.Event.removeCallback(testNode, "blur",tnBlurHandler);
        Action.focus(testInp);
        Action.blur(testInp);
        this.wait(function(){
            Assert.isFalse(called, 
                 "blur handler was called, but should not have been.");
        }, 100);
        function tnBlurHandler() {
            called = true;
        }
    },

    testStopPropagation : function(){
        var called = false;

        Event.addCallback(testNode, "click", tnClick);
        Event.addCallback(testInp, "click", inpClick);
        function tnClick() { called = true;  }
        function inpClick(ev){ Event.stopPropagation(ev); }
        
        Action.click(testInp);
        this.wait(function(){
            Assert.isFalse(called, 
                 "click handler bubbled up to testInp, but should not have.");
        }, 100);
    },

    testAddMultiple : function() {
        var pub = Event.get(testNode, "click"),
            called1, called2;
        
        pub.add(tnClick);
        pub.add(tnClick2);
        function tnClick() { called1 = true;  }
        function tnClick2(ev){ called2 = true;  }
        Action.click(testNode);
        Assert.isTrue(called1, "first was not called");
        Assert.isTrue(called2, "second was not called");
    },

    testPurge : function() {
        var pub = Event.get(testNode, "click"),
            calls = 0;
        
        Event.add(testNode, "click", tnClick);
        Event.add(testNode, "click", tnClick2);
        Event.add(testNode, "mousedown", tnClick3);
        Event.add(testNode, "mouseup", tnClick4);
        
        function tnClick() { calls++;  }
        function tnClick2(ev){ calls++;  }
        function tnClick3(ev){ calls++;  }
        function tnClick4(ev){ calls++;  }

        Event.purgeEvents(testNode, ["click", "mousedown", "mouseup"]);
        
        Action.mousedown(testNode);
        Action.mouseup(testNode);
        Action.click(testNode);
        
        Assert.areSame(0, calls, "calls was not 0");
    },
    
    testGetDomEventPublisher : function(){
        var dep = Event.get(testNode, "click");
    }
});

var logger = new YAHOO.tool.TestLogger("testLogger");
YAHOO.tool.TestRunner.add( eventTestCase );

// run the tests, or put them in the TestRunner.
if (parent && parent != window) {
    YAHOO.tool.TestManager.load();
} else {
    YAHOO.tool.TestRunner.run();
}
}, 100);</script>
</body>
</html>