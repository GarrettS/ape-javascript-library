<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
        "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
    <title>Calendar Test</title>
    <link rel="stylesheet" type="text/css" href="../../yui-test/build/logger/assets/logger.css" />
    <link rel="stylesheet" type="text/css" href="../../yui-test/build/yuitest/assets/yuitest.css" />
    <link rel="stylesheet" type="text/css" href="../../yui-test/assets/testlogger.css" />

    <script type="text/javascript" src="../../yui-test/build/yahoo-dom-event/yahoo-dom-event.js"></script>
    <script type="text/javascript" src="../../yui-test/build/logger/logger.js"></script>
    <script type="text/javascript" src="../../yui-test/build/yuitest/yuitest-beta.js"></script>

    <script type="text/javascript" src="../../../build/ape-ep-dom.js"></script>
    <script type="text/javascript" src="../../../build/widget/calendar/Calendar_en.js"></script>
    <script type="text/javascript" src="../../../build/widget/calendar/Calendar.js"></script>
</head>
<body>

<div id='template'>
    <label for="start" id='sf'>Start <input id="start" type="date" size="18"/></label>

    <input id='blah'/>
</div>

<div id="testLogger"></div>
<script type="text/javascript">
setTimeout(function(){
    var Calendar = APE.widget.Calendar,
        Assert = YAHOO.util.Assert,
        DateAssert = YAHOO.util.DateAssert,
        ArrayAssert = YAHOO.util.ArrayAssert,
        sf, start,
        Action = YAHOO.util.UserAction,
        template = document.getElementById('template'),
        templateHTML = template.innerHTML;
 
    var calendarTest = new YAHOO.tool.TestCase({
 
        //name of the test case - if not provided, one is auto-generated
        name : "Calendar test",
        
 
        setUp : function () {
            template.innerHTML = templateHTML;
            sf = document.getElementById('sf');
            start = document.getElementById('start');
            self.focus();
        },
 
        tearDown : function () {
            template.innerHTML = "";
            start = sf = null;
            var instances = Calendar.instances;
            for(var x in instances) {
                var instance = instances[x], calendarId = instance.calendarId;
                if(!calendarId) continue;
                var c = document.getElementById(calendarId);
                c.parentNode.removeChild(c);
            }
            Calendar.instances = {};
        },

        _should : {
            ignore : {
                testFocusHandler : Calendar.IS_NATIVE,
                testCalendarStaysVisible : Calendar.IS_NATIVE,
                testSelectDateInFuture : Calendar.IS_NATIVE,
                testGetDateFromInput : Calendar.IS_NATIVE,
                testTodaySelected :  Calendar.IS_NATIVE
                
            }
        },
        
        testGetById: function() {
            var c = Calendar.getById("start");
            Assert.isNotNull(c);
        },
 
        testFocusHandler : function() {
            var c = Calendar.getById("start");
            start.focus();
            this.wait(function(){
                var calendarEl = document.getElementById(c.calendarId);
                Assert.areEqual("visible", calendarEl.style.visibility, "calendar visiblity wrong.");
                start.blur();
                document.getElementById('blah').focus();
                this.wait(function(){
                    Assert.areEqual("hidden", calendarEl.style.visibility, "calendar visiblity not hidden.");
                }, 30);
            }, 30);
        },
 
        testCalendarStaysVisible : function() {
            var c = Calendar.getById("start");
            start.focus();
            this.wait(function(){
                Assert.isFalse(c._isHidden);
                var calendarEl = document.getElementById(c.calendarId);

                // Transfer focus to the calendar widget. 
                // Calendar must still be visible.
                start.blur();
                
                Action.mousedown(calendarEl);
                // next month.
                Action.mousedown(document.getElementById("start-next-month"));
                // prev year.
                Action.mousedown(document.getElementById("start-prev-year"));
                
                this.wait(function(){
                    Assert.areEqual("visible", calendarEl.style.visibility, "calendar visiblity wrong.");
                    Assert.isFalse(c._isHidden, "c._isHidden");
                }, 170);
            }, 270);
        },
 
        testSelectDateInFuture : function() {
            var c = Calendar.getById("start");

            var initial = "2010-09-24";
            var expected = "2011-10-10",
                expectedSplit = expected.split("-");
            
            var expectedDate = new Date(0);
            expectedDate.setFullYear(expectedSplit[0], expectedSplit[1]-1, expectedSplit[2]);

            // Set start value for calendar to read.
            start.value = initial;
            start.focus();
            this.wait(function(){
                var calendarEl = document.getElementById(c.calendarId);

                // +1 month.
                Action.mousedown(document.getElementById("start-next-month"));
                // +1 year.
                Action.mousedown(document.getElementById("start-next-year"));

                // Find 10th day on calendar.
                var daySelected = findDayElement(calendarEl, 10);
                Action.mousedown(daySelected);
 
                Action.mousedown(document);
                this.wait(function(){
                    Assert.isTrue(c._isHidden, "c._isHidden");
                    var split = start.value.split("-");
                    var actualDate = new Date(0);
                    var split = start.value.split("-");
                    actualDate.setFullYear(split[0], split[1]-1, split[2]);
                    DateAssert.datesAreEqual(expectedDate, actualDate);
                }, 20);
            }, 20);

            // Find the B element that has |dayIndex| for data.
            // @param {uint} desiredDate.
            function findDayElement(calendarEl, desiredDate) {
                var dayElements = calendarEl.getElementsByTagName("tbody")[0].
                    getElementsByTagName("b");
                var j = desiredDate-1;
                var daySelected = dayElements[j];
                var dayValue = daySelected.firstChild.data;
                while(dayValue < desiredDate) {
                    daySelected = dayElements[j++];
                    var data = daySelected.firstChild.data;
                    if(!/\d/.test(data)) continue;
                    dayValue = +daySelected.firstChild.data;
                }
                return daySelected;
            }
        },
 
        testGetDateFromInput : function() {
            
            var c = Calendar.getById("start");

            var expected = "1999-11-24",
                expectedSplit = expected.split("-");

            var expectedDate = new Date(0);
            expectedDate.setFullYear(expectedSplit[0], expectedSplit[1]-1, expectedSplit[2]);

            start.value = expected;
            start.focus();

            this.wait(function(){
                var id = "start-selected-day",
                    selected = document.getElementById(id);
 
                Assert.areEqual(selected.innerHTML, expectedDate.getDate().toString());
                var actualYearMonthString = document.getElementById(c.calendarId + "-header").innerHTML,
                    parts = actualYearMonthString.split(", "),
                    actualMonth = parts[1],
                    actualYear = parts[0],
                    actualMonthNumber = new Date(actualMonth + " 11, "+actualYear).getMonth();
 
                Assert.areEqual(expectedDate.getFullYear(), actualYear);
                Assert.areEqual(expectedDate.getMonth(), actualMonthNumber);
            },20);
        },
 
        testSetGetDate : function() {
            var c = Calendar.getById("start");
            var inp = new Date("January 12, 2004");
            c.setDate(inp);
            var actual = c.getDate();
            DateAssert.datesAreEqual( inp, actual, "actual date wrong." );
            var copy = new Date(inp);
            inp.setMonth(10);
            DateAssert.datesAreEqual( copy, actual, "better handle mutability." );
        },
 
        testTodaySelected : function() {
            var c = Calendar.getById("start");
            start.focus();
 
            DateAssert.datesAreEqual(c.getDate(), new Date);
            this.wait(function(){
                var id = "start-selected-day",
                    selected = document.getElementById(id);
                ArrayAssert.contains(c.calendarClass+ "-today", selected.className.split(" "));
            }, 20);
        }
    });
 
    //create the logger
    new YAHOO.tool.TestLogger("testLogger");
 
    //run the tests
    YAHOO.tool.TestRunner.add( calendarTest );
     //run the tests
    if (parent && parent != window) {
        YAHOO.tool.TestManager.load();
    } else {
        YAHOO.tool.TestRunner.run();
    }
 
}, 20);</script>

 
</body>