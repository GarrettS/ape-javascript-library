APE.namespace("APE.widget").defineCustomFactory("Autocomplete",function(M){var O=window.APE,P=O.dom,S=P.key,N=O.anim,R=P.Event,E=O.widget.DelegateFactory,F="ape-autocomplete-item-selected",C="ape-autocomplete-item-hover",B,D=Q(),K={jsonpParamName:"{string} - param name - required for jsonp REST-based APIs.",onhighlight:"{Function} Event Fires when an item is hilighted.",onchange:"{Function} Event Fires when an item has been selected (click or Enter).",onrender:"{Function} Event fires when list is populated with data.",requestInputPattern:"{Function} text to match on input before sending a request."},A=Function.prototype;E.create(M,R,"focus",E.descendantMatcher);M.textMatcher=A;M.showUsage=H;M.getRequiredFields=Q;M.toString=function(){return"Autocomplete Widget Factory: for help, call Autocomplete.showUsage()"};function Q(){return{dataSource:"{string} URI, e.g. 'myService.jsp'",paramName:"{string} query param for input value",getListData:"{Function} function must return array from the response object. default: Autocomplete.prototype.getListData(rawObject)",itemRenderer:"{Function} renders each item in the list default: Autocomplete.prototype.itemRenderer(itemData)",getInputValueFromSelectedItem:"{Function} default: Autocomplete.prototype.getInputValueFromSelectedItem()",loader:"{Object} APE.ajax.AsyncRequest (default) or APE.ajax.ScriptLoader",matcher:"{Function} [optional] Do something to each LI based on input value.default: noop. Try: Autocomplete.textMatcher(listItemElement, value)"}}function H(){var T=[],U;for(U in D){T[T.length]=U+" : "+D[U]}T[T.length]="\nOptional:";for(U in K){T[T.length]=U+" : "+K[U]}return"Usage:\n\nvar config = {\n  "+T.join("\n  ")+"\n};\nAutocomplete.addDelegateFor('myWidget-input', config);\n\n"}function G(W,U){var V=W.firstChild,X=V.data.toLowerCase().indexOf(U.toLowerCase()),T=U.length-X;if(X!==-1&&T>0){I(W.firstChild,"b",X,T)}}function I(V,T,W,U){(I=document.createRange?function(Z,X,a,Y){range=document.createRange();range.setStart(Z,a);range.setEnd(Z,Y);range.surroundContents(document.createElement(X))}:function(Z,g,X,Y){var c=document.createDocumentFragment(),a=Z.data,b=document.createElement(g),d=Z.parentNode,f=document.createTextNode(a.substring(X+Y)),e=a.substring(X,X+Y);b[P.TEXT_CONTENT]=e;c.appendChild(b);c.appendChild(f);d.replaceChild(c,Z)})(V,T,W,U)}function L(U){var V="";if(!U||(V=T(U))){return M.toString()+V&&"\n(missing: "+V+")"}function T(W){for(var X in D){if(!(X in W)){return X}}}}return J;function J(x){function V(AH,AE){var AG,AF,AD;AF=L(AE);if(AF){throw new Error(AH+", "+AF)}this.id=AH;for(AG in AE){this[AG]=AE[AG]}y(this)}V.prototype={getValueForServer:function(){return this.value?this.value.replace(/^ +| +$/g,""):""},data:"",requestInputPattern:/\S/,itemRenderer:function(AD){return AD},onchange:A,onhighlight:A,onrender:A,onrequest:A,getListData:function(AD){return AD},getInputValueFromSelectedItem:function(){return this.data[this.getSelectedIndex()]},getSelectedIndex:function(){if(!this.selectedItem){return -1}var AE=this.selectedItem.parentNode.childNodes,AF,AD;for(AF=0,AD=AE.length;AF<AD;AF++){if(AE[AF]===this.selectedItem){return AF}}return -1},getSelectedDataItem:function(){return this.data[this.getSelectedIndex()]}};return V;function y(AE){var AD=document.getElementById(AE.id+"-input");R.addCallback(AD,"keyup",i);R.addCallback(AD,"keydown",o);AE.selectedItem=null;AE.value=AD.value||null}function i(AE){if(S.ARROW_KEY_EXP.test(AE.keyCode)||AE.keyCode===S.ENTER){return w&&w.stop()}var AF=this.id.replace(/-input$/,""),AD=x.getById(AF);this.defaultValue=this.value;if(!AD.requestInputPattern.test(this.value)){s(AD);r(AD)}else{if(!h(AD,this.defaultValue)){s(AD);X(AD)}}}function o(AE){var AF=AE.keyCode,AD=x.getById(this.id.replace("-input",""));if(!h(AD,this.defaultValue)){return}if(!w||!w.playing){if(AF===S.UP){return T(AD)}else{if(AF===S.DOWN){return n(AD)}}}if(AF===S.ESC&&p(AD)){t(AD)}else{if(AF===S.ENTER&&p(AD)){t(AD);R.preventDefault(AE)}}}function t(AD){s(AD);if(AD.onchange()!==false){r(AD)}}function r(AE){var AD=document.getElementById(AE.id+"-input");AE.value=AD.value}function p(AD){var AE=document.getElementById(AD.id+"-list");return AE.style.display!=="none"}function s(AD){var AE=document.getElementById(AD.id+"-list");if(AE){AE.style.display="none"}}function h(AE,AD){return AD===AE.listValue&&AE.data.length>0&&document.getElementById(AE.id+"-list")!==null}function T(AD){var AE=AD.selectedItem;if(!AE){AE=document.getElementById(AD.id+"-list").lastChild}else{AE=AE.previousSibling}if(AE){k(AD,AE);AB(AD,"prev")}}function n(AD){var AE=AD.selectedItem;if(!AE){AE=document.getElementById(AD.id+"-list").firstChild}else{AE=AE.nextSibling}if(AE){k(AD,AE);AB(AD,"next")}}var w,e;function AB(AE,AD){c();e=AD;if(w){w.run=function(AF){if(e==="next"){n(AE)}else{if(e==="prev"){T(AE)}}};if(!w.playing){w.startAfter(400)}}}function c(){if(!w&&N){w=new N.Animation(3000)}}function k(AF,AE){if(p(AF)){u(AF);AF.selectedItem=AE;if(B){AE.scrollIntoView(false)}if(AF.onhighlight()!==false){var AD=document.getElementById(AF.id+"-input");AD.value=AF.getInputValueFromSelectedItem()}}else{d(AF)}b(AF)}function u(AD){if(AD.selectedItem===null){return}P.removeClass(AD.selectedItem,F)}function b(AD){P.addClass(AD.selectedItem,F)}function X(AF){var AG=q(AF),AE=document.getElementById(AF.id+"-input"),AD;AF.value=AE.value;AD=AF.paramName+"="+AF.getValueForServer()+a(AF);if(AG.post){AG.onsucceed=m;AF.callback=v}else{AF.callback=U}AG.abort();AG.get(AD);AF.onrequest()}function v(AD){return AD}function U(AD){this.responseObject=AD;this.data=this.getListData(AD)}function a(AD){return AD.jsonpParamName?"&"+AD.jsonpParamName+"="+l(AD):""}function l(AD){return encodeURIComponent("APE.widget.Autocomplete.instances."+AD.id+".callback")}function q(AD){return(AD.loader||O.ajax.AsyncRequest).getById(AD.id,AD.dataSource)}function m(){var AF=x.getById(this.id),AD=document.getElementById(AF.id+"-input"),AE=j(AF,this.req.responseText);AF.data=AF.getListData(AE);AF.responseObject=AE;AF.selectedItem=null;AF.listValue=AD.defaultValue=AF.value;if(AF.data&&AF.data.length>0){Y(AF,z(AF));AF.onrender();d(AF);AA(AF)}}function j(AE,AF){if(AF){var AD=new Function("return("+AF+");");return AD()}return""}function d(AD){var AF=z(AD),AE=AD.selectedItem;AF.style.display="block";if(AE&&B){AE.scrollIntoView(false)}}function AA(AG){if(AG.matcher){var AF,AH=document.getElementById(AG.id+"-list"),AD=AH.getElementsByTagName("li"),AE=[];for(AF=0;AF<AD.length;AF++){Z(AG,AD[AF],AE)}}}function Z(AG,AF,AE){try{AG.matcher(AF,AG.value,AF[P.TEXT_CONTENT])}catch(AD){len=AE[AE.length]=AD.message}if(AE.length){setTimeout(function(){throw AE},1)}}function z(AE){var AG=AE.id,AD=AE.id+"-list",AF=document.getElementById(AD);if(!AF){AF=document.createElement("ul");AF.id=AD;AF.className="ape-autocomplete-list"}return AF}function Y(AH,AI){var AE=AH.data,AD=AE.length,AG=[],AF;AG.length=AD;AI.id=AH.id+"-list";for(AF=0;AF<AD;AF++){AG[AF]="<li>"+AH.itemRenderer(AE[AF])+"</li>"}AI.innerHTML=AG.join("");document.getElementById(AH.id).appendChild(AI);B=!!AI.childNodes[0].scrollIntoView;R.addCallback(AI,"click",f);R.addCallback(AI,"mouseover",W);return AI}function f(AF){var AE,AD=g(AF,this);if(AD){AE=x.getById(this.id.replace(/-list$/,""));k(AE,AD);setTimeout(function(){t(AE);document.getElementById(AE.id+"-input").focus()},140);AD=null}}function W(AE){var AD=g(AE,this);if(AD){AD.onmouseout=AC;P.addClass(AD,C)}}function AC(AE){var AD=R.getRelatedTarget(AE);if(!P.contains(this,AD)){P.removeClass(this,C)}}function g(AE,AF){var AD=R.getTarget(AE);if(AD.tagName!=="LI"){AD=P.findAncestorWithTagName(AD,"LI",AF)}return AD}}});