APE.namespace("APE.widget");(function(){var E=APE.widget;E.Calendar=APE.createFactory(B,H);function B(J){this.id=J;if(E.Calendar.IS_NATIVE){return}I[J]={};F(this);this.initEvents()}var I={};var D=document.createElement("input");D.setAttribute("type","date");var G=E.Calendar.IS_NATIVE=/date/i.test(D.type);D=null;var A=[31,28,31,30,31,30,31,31,30,31,30,31],C=null;function H(){return{hideOnSelect:true,initEvents:function(){if(G){return}var Y=document,W=Y.getElementById(this.id),X=APE.EventPublisher;X.add(W,"onfocus",O);X.add(W,"onblur",N);if(!G){X.add(W,"onclick",O);X.add(Y,"onmousedown",L)}},calendarId:"",hiddenDayClass:"ape-calendar-empty-day",calendarClass:"ape-calendar",_isHidden:undefined,position:function(Y){var W=document.getElementById(this.id),X=APE.dom.getOffsetCoords(W);Y.left=X.x+"px";Y.top=X.y+W.offsetHeight+"px"},show:function(W){F(this);W.visibility="visible"},hide:function(W){W.visibility="hidden"},onshow:function(){},onhide:function(){},onselect:function(){},getDate:function(){return new Date(this.displayDate)},setDate:function(W){this.displayDate=new Date(W);if(G){document.getElementById(this.id).value=T(this.displayDate);return}U(this,W)}};function U(h,u){var l=window.APE,a=l.widget.CalendarLocale;if(!a){throw Error("Missing Resource: APE.widget.CalendarLocale")}P(h);var x=new Date,s=document,g=u.getFullYear(),v=u.getMonth(),e=a.months.full[v],t=A[v],m,q=0,n=0,b=(0==(g%4))&&((0!=(g%100))||(0==(g%400))),f=s.getElementById(h.calendarId),W=f.getElementsByTagName("table")[0].tBodies[0],Z=W.getElementsByTagName("b"),w="textContent" in f?"textContent":"innerText",p=s.getElementById(h.calendarId+"-header"),r=l.dom,Y;m=new Date(u);m.setDate(1);m=m.getDay();p.firstChild.data=g+", "+e;if(v===1&&b){t+=1}while(q<m){Y=Z[q++];Y[w]=" ";Y.className=h.hiddenDayClass}while(n++<t){Y=Z[q++];Y[w]=n;Y.className=""}for(q=m+t,n=Z.length;q<n;q++){Y=Z[q];Y[w]=" ";Y.className=h.hiddenDayClass}var k=s.getElementById(h.id+"-selected-day");if(k){k.id=""}if(x.getYear()==u.getYear()&&x.getMonth()==u.getMonth()){var c=m+x.getDate()-1;h.currentDayIndex=c;var o=Z[c];r.addClass(o,h.calendarClass+"-today")}if(u.getYear()==u.getYear()&&u.getMonth()==u.getMonth()){var X=m+u.getDate();Y=Z[X-1];r.addClass(Y,h.calendarClass+"-selected-day");Y.id=h.id+"-selected-day"}}function P(b){if(!b.calendarId){b.calendarId=b.id+"-calendar"}var g=document;if(g.getElementById(b.calendarId)!==null){return}var h=g.createElement("div"),Y=Array.prototype.join,Z=Y.call({length:7+1},"<td><b>&nbsp;</b></td>"),e=Y.call({length:6+1},"<tr>"+Z+"</tr>\n"),c=APE.widget,W=c.CalendarLocale,X=W.days.abbr,a="<tbody>"+e+"</tbody>",f="<thead><tr class='calendar-button-row'><th id='"+b.id+"-prev-year' title='"+W.previousYear+"'>&#x00ab;</th><th id='"+b.id+"-prev-month' title='"+W.previousMonth+"'>&#x2039;</th><th colspan='3' class='ape-calendar-header'><div id='"+b.calendarId+"-header'>&nbsp;</div></th><th id='"+b.id+"-next-month' title='"+W.nextMonth+"' class='"+b.calendarClass+"-days'>&#x203A;</th><th id='"+b.id+"-next-year' title='"+W.nextYear+"'>&#x00bb;</th></tr><tr><th>"+X.join("</th><th>")+"</th></tr></thead>";h.onselectstart=J;h.innerHTML="<table>"+f+a+"</table>";h.id=b.calendarId;h.className=b.calendarClass;h.onmousedown=h.onfocus=R;g.body.appendChild(h)}function O(X){var W=E.Calendar.getById(this.id);V(W,X)}function V(X,W){if(G){X.onshow(W);return}P(X);var Y=document.getElementById(X.calendarId).style;X._isHidden=false;if(C!==null){if(C===X){return}else{Q(C,W)}}M(X,Y);C=X;X.onshow(W);X.show(Y);X.setDate(X.displayDate)}function M(Y,Z){var W=document.getElementById(Y.id),X=APE.dom.getOffsetCoords(W);Z.left=X.x+"px";Z.top=X.y+W.offsetHeight+"px"}function Q(X,W){if(X._isHidden||X._hasFocus){return}X.onhide(W);if(G){return}if(C===X){C=null}X.hide(document.getElementById(X.calendarId).style);X._isHidden=true}function R(b){b=b||event;var Z=APE.dom,c=Z.Event.getTarget(b),g=this,h,f,a,X;h=E.Calendar.getById(g.id.replace(/-calendar$/,""));f=h.id;window.clearTimeout(h.hideTimer);X=f+"-selected-day";h._hasFocus=true;if(/^b$/i.test(c.tagName)){if(c.id!==X){var W=+c.firstChild.data,Y;if(!W){return}h._hasFocus=!h.hideOnSelect;Y=document.getElementById(X);if(Y){Z.removeClass(Y,"ape-calendar-selected-day");Y.id=""}c.id=X;Z.addClass(c,"ape-calendar-selected-day");S(h,W);h.onselect();if(h.hideOnSelect){setTimeout(function(){Q(h,b);h._hasFocus=false;h=null},115)}}}else{var d=new Date(h.displayDate);if(c.id===f+"-next-year"){d.setFullYear(d.getFullYear()+1);h.setDate(d)}else{if(c.id===f+"-prev-year"){d.setFullYear(d.getFullYear()-1);h.setDate(d)}else{if(c.id===f+"-next-month"){d.setMonth(d.getMonth()+1);h.setDate(d)}else{if(c.id===f+"-prev-month"){d.setMonth(d.getMonth()-1);h.setDate(d)}}}}}}function S(Y,W){Y.displayDate.setDate(W);var X=T(Y.displayDate);document.getElementById(Y.id).value=X}function J(){return false}function T(X){var Z=K(X.getFullYear(),4,"0"),Y=K(X.getMonth()+1,2,"0"),W=K(X.getDate(),2,"0");return Z+"-"+Y+"-"+W}function K(Z,X,Y){Z+="";for(var W=Z.length;W++<X;Z=Y+Z){}return Z}function N(Y){var X=E.Calendar.getById(this.id);X.hideTimer=window.setTimeout(W,10);function W(){Q(X,Y||window.event)}}function L(Y){var Z=APE.dom,X=Z.Event.getTarget(Y),W;if(C!==null){W=document.getElementById(C.calendarId);if(!W){C=null;return}if(Z.contains(W,X)||X===W){return}C._hasFocus=false;Q(C,Y)}}}function F(M){var J=document.getElementById(M.id),L=/(?:^|\s+)(\d{4})-(\d\d)-(\d\d)(?:$|\s+)/,K=L.exec(J.value);if(!K){M.displayDate=new Date}else{M.displayDate=new Date(0);M.displayDate.setFullYear(K[1],K[2]-1,K[3])}}})();