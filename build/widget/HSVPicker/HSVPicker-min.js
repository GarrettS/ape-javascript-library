APE.namespace("APE.widget");
(function(){function g(){}function j(b){this.id=b;b=document.getElementById(this.id+"-hue-slider");var a=document.getElementById(this.id+"-saturation-value-selector");this.hueSlider=k.getByNode(b);this.hueSlider.moveToX=g;this.hueSlider.keepInContainer=true;this.bgSelector=k.getByNode(a);this.bg=b=a.parentNode.parentNode;this.bgSelector.container=b;this.bgSelector.keepInContainer=true;this.textInput=document.getElementById(this.id+"-color-input");this.displayStyle=document.getElementById(this.id+"-color-preview").style;
this.bgClipLeft=this.bgClipTop=6;this.enabled=true;this.prevValue=this.textInput.value}function p(b){var a=c.getById(this.id.split("-")[0]);if(a.enabled){a.onbeforechange();a.h=360*a.hueSlider.el.offsetTop/128;a.bg.style.background=a.rgbForHue(a.h);a.updateDisplay();a.onchange(b)}}function q(b){var a=c.getById(this.id.split("-")[0]);if(a.enabled){a.hueSlider.grab(b);a.updateDisplay();a.onchange(b);a.onchangecomplete(b)}}function r(b){var a=c.getById(this.id.split("-")[0]);if(a.enabled)return a.trySetValue(this.value,
b||event)}function s(){return c.getById(this.id.split("-")[0]).enabled}function t(b){b=b||self.event;var a=b.keyCode==9,d=b.keyCode==13;if(a||d)c.getById(this.id.split("-")[0]).trySetValue(this.value,b||event);d&&this.focus()}function u(b){var a=c.getById(this.id.split("-")[0]);if(a.enabled){a.onbeforechange();a.bgSelector.grab(b);a.bg.style.background=a.rgbForHue(a.h);a.updateDisplay();a.onchange(b);a.onchangecomplete(b)}}function l(b){var a=c.getById(this.id.split("-")[0]);if(a.enabled){a.v=(127-
(this.el.offsetTop+a.bgClipTop))/127;a.s=(this.el.offsetLeft+a.bgClipLeft)/127;a.updateDisplay();a.onchange(b)}}function v(){if(this.textInput.value)this.prevValue=this.textInput.value}function m(b){var a=c.getById(this.id.split("-")[0]);a.onbeforechange();if(this.checked){a.prevValue=a.textInput.value;a.setEnabled(false);a.setValue("transparent")}else{a.setValue(a.prevValue||(new n(255,255,255)).toString());a.prevValue="";a.setEnabled(true);a.hueSlider.ondrag(b);a.bgSelector.ondrag(b)}a.onchange(b);
a.onchangecomplete(b)}var e=self.APE,k=e.drag.Draggable,f=e.EventPublisher,h=e.color,n=h.ColorRGB,i=h.ColorHSV,c,w="Please enter a valid color value.";h=null;e.widget.HsvPicker=c=e.createFactory(j);j.prototype={rgbForHue:i.rgbForHue,rgbFromString:n.fromString,init:function(){function b(d){this.onchangecomplete(d)}this.textInput.value?this.setValue(this.textInput.value):this.setValue("#ff0000");this.bgSelector.onbeforedragstart=this.bgSelector.ondrag=this.bgSelector.onglide=l;this.hueSlider.onbeforedragstart=
this.hueSlider.ondrag=this.hueSlider.onglide=p;this.hueSlider.container.onmousedown=q;this.bgSelector.onglide=l;this.bgSelector.onfocus=this.hueSlider.onfocus=s;f.add(this.textInput,"onblur",r);f.add(this.textInput,"onkeydown",t);f.add(this,"onbeforechange",v);f.add(this.bgSelector.el.parentNode,"onmousedown",u);f.add(this.bgSelector,"ondragend",b,this);f.add(this.hueSlider,"ondragend",b,this);var a=document.getElementById(this.id+"-transparent-checkbox");f.add(a,"onclick",m);a.checked&&m.call(document.getElementById(this.id+
"-transparent-checkbox"))},getHexValue:function(){if(this.textInput.value=="")return"";return(new i(this.h,this.s,this.v)).toRGB().toHexString()},onbeforechange:g,onchange:g,onchangecomplete:g,setEnabled:function(b){this.enabled=b},setValue:function(b){var a="transparent",d=document.getElementById(this.id),o=document.getElementById(this.id+"-transparent-checkbox"),x=document.getElementById(this.id+"-color-preview");if(b==a){e.dom.addClass(d,"ape-hsv-transparent");x.style.backgroundColor=a;this.setEnabled(false);
this.textInput.value="";o.checked=true}else{e.dom.removeClass(d,"ape-hsv-transparent");this.setEnabled(true);o.checked=false;b=this.rgbFromString(b);isInputValid=b.isValid();if(!isInputValid)b=this.rgbForHue(this.h=0,this.s=1,this.v=1);a=b.toHSV();this.h=a.h;this.s=a.s;this.v=a.v;this.hueSlider.el.style.top=a.h/360*128+"px";this.bgSelector.moveToX(a.s*127-this.bgClipLeft);this.bgSelector.moveToY(127-a.v*127-this.bgClipTop);this.bg.style.backgroundColor=this.rgbForHue(a.h,1,1).toHexString();this.updateDisplay(b,
isInputValid)}},updateDisplay:function(b,a){b=b||(new i(this.h,this.s,this.v)).toRGB();if(b.isValid()&&a!=false)this.displayStyle.backgroundColor=this.textInput.value=b.toHexString();else this.textInput.value=""},trySetValue:function(b,a){if(this.rgbFromString(b).isValid()){this.setValue(b);this.onchange(a);this.onchangecomplete(a);return true}else{self.alert(w);return false}}}})();
