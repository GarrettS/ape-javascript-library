APE.namespace("APE.widget").createCustomFactory("Calendar",function(C){var F=document.createElement("input"),D=window.APE,E=D.dom,I=E.Event,J={},K="ape-calendar-input";F.setAttribute("type","date");D.createMixin(C,{IS_NATIVE:/date/i.test(F.type),registerDelegateFor:H});return A;function H(N,L,M){J[N]=J[N]||I.addDelegatedFocus(document.documentElement,B(N,L,M))}function B(N,L,M){return function(O){G(O,N,L,M)}}function G(N,P,L,M){var O=I.getTarget(N);if(O.id===P&&(!M||M(O)!=false)){I.removeDelegatedFocus(document.documentElement,J[P]);delete J[P];C.getById(P,L)}}function A(Z){function b(AS,AR){this.id=AS;if(l){return}AR&&D.createMixin(this,AR);if(this.useAnim){this.hide=m}this._isHidden=true;this.initEvents()}function AB(AS){var AR=document.getElementById(AS.id);return V(AR.value)}function V(AT){var AS=/^\s*(\d{4})-(\d\d)-(\d\d)\s*$/,AR=null,AV,AU=AS.exec(AT);if(AU){AR=new Date(0);AV=+AU[2];AR.setFullYear(AU[1],AV-1,AU[3]);if(AV===AR.getMonth()+1){AR.setHours(0,0,0,0)}else{AR=null}}return AR}var AI=Function.prototype,P=D.EventPublisher,AP=P.add,AJ=P.remove,c=document.body,a=null,AH=typeof c.focus!=="undefined",AG="ape-calendar-focused-el",M="ape-calendar-selected-day",U=/-((?:next|prev)-(?:month|year))$/,p=/-next-|-prev-|-day\d/,z=/-day(\d+)$/,e=E.key,l=Z.IS_NATIVE,S=[31,28,31,30,31,30,31,31,30,31,30,31],q=D.anim,O=q.StyleTransition,j=0.1,AN={},d={opacity:0.98,width:"14.4em",height:"14.4em",visibility:"visible"};function t(AT,AY){var AS=D.widget.CalendarLocale,Ac=AT.displayDate;if(!AS){throw Error("Missing Resource: APE.widget.CalendarLocale")}u(AT);var AV=document,AW=Ac.getFullYear(),AU=Ac.getMonth(),Aa=AS.months.abbr[AU],AX=s(Ac),Ab=AV.getElementById(AT.calendarId),AZ=Ab.getElementsByTagName("tbody")[0].getElementsByTagName("b"),AR=AV.getElementById(AT.calendarId+"-header");AR.firstChild.data=AW+", "+Aa;AC(AT,AW,AU,AX,AZ);AM(AT,AX,AZ);if(AY){R(AT,AX+Ac.getDate(),AZ)}}function s(AR){AR=new Date(AR);AR.setDate(1);return AR.getDay()}function AC(AU,AZ,AY,Aa,Ab){var AV=0,AT=0,AW=S[AY],AS,AX=AU.id+"-day",AR=(0==(AZ%4))&&((0!=(AZ%100))||(0==(AZ%400)));if(AY===1&&AR){AW+=1}while(AV<Aa){AS=Ab[AV++];AS[E.TEXT_CONTENT]=" ";AS.className=AU.hiddenDayClass;AS.id=""}while(AT++<AW){AS=Ab[AV++];AS.id=AX+(AT-1);AS[E.TEXT_CONTENT]=AT+"";AS.tabIndex=-1;AS.className=""}for(AV=Aa+AW,AT=Ab.length;AV<AT;AV++){AS=Ab[AV];AS[E.TEXT_CONTENT]=" ";AS.className=AU.hiddenDayClass}}function AM(AU,AR,AT){if(Q(AU)){var AS=AR+new Date().getDate()-1;E.addClass(AT[AS],AU.calendarClass+"-today")}}function R(AU,AT,AS){if(Q(AU)&&!AU.selectedId){var AR=AS[AT-1];E.addClass(AR,M);AU.selectedId=AR.id}}function Q(AS){var AR=AB(AS)||new Date;return AR!=null&&AS.displayDate.getYear()==AR.getYear()&&AS.displayDate.getMonth()==AR.getMonth()}function u(AU){if(!AU.calendarId){AU.calendarId=AU.id+"-calendar"}var AX=document;if(AX.getElementById(AU.calendarId)!==null){return}var Aa=AX.createElement("div"),AZ,AY=AX.getElementById(AU.id),AS=AY.parentNode,AV=w(),AR=D.widget.CalendarLocale,AT=AR.days.abbr,AW="<thead><tr class='calendar-button-row'><th id='"+AU.id+"-prev-year' tabindex='0' title='"+AR.previousYear+"'>&#x00ab;</th><th id='"+AU.id+"-prev-month' tabindex='0' title='"+AR.previousMonth+"'>&#x2039;</th><th colspan='3' class='ape-calendar-header'><div id='"+AU.calendarId+"-header'>-</div></th><th id='"+AU.id+"-next-month' tabindex='0' title='"+AR.nextMonth+"' class='"+AU.calendarClass+"-days'>&#x203A;</th><th id='"+AU.id+"-next-year' tabindex='0' title='"+AR.nextYear+"'>&#x00bb;</th></tr><tr><th>"+AT.join("</th><th>")+"</th></tr></thead>";Aa.onselectstart=AO;Aa.innerHTML="<table>"+AW+AV+"</table>";Aa.id=AU.calendarId;Aa.className=AU.calendarClass;if(AU.useAnim){E.addClass(Aa,"ape-calendar-anim-start")}Aa.tabIndex=0;Aa.onmousedown=AF;Aa.onkeydown=Y;AZ=Aa.firstChild;if("onfocusin" in AZ){AZ.onfocusin=g;AZ.onfocusout=AK}AS.insertBefore(Aa,AY.nextSibling)}function w(){var AU=[],AT=6,AR=[],AS;AU.length=8;AR.length=AT;AU=AU.join("<td><b>&nbsp;</b></td>");for(AS=0;AS<AT;AS++){AR[AS]="<tr id='w"+AS+1+"'>"+AU+"</tr>\n"}return"<tbody>"+AR.join("")+"</tbody>"}function g(AR){var AS=I.getTarget(AR);if(p.test(AS.id)&&AS!==null){E.addClass(AS,AG)}}function AK(AR){var AS=I.getTarget(AR);if(AS!==null){E.removeClass(AS,AG)}}function y(AS){AS=AS||window.event;var AT=Z.getById(this.id),AR=document.getElementById(AT.id),AU=AS.relatedTarget||AS.fromElement;if(AT._isHidden&&(!AU||(AU!==AR&&!E.contains(AR,AU)))){L(AT,AS)}}function Y(AS){AS=AS||window.event;var AV=AS.keyCode,AR=this.id.replace(/-calendar$/,""),AU=Z.getById(AR),AT;if(AV===e.ESC){if(!AU._isHidden){document.getElementById(AR).focus();o(AU)}}else{if(AV===e.ENTER){AT=I.getTarget(AS);N(this,AT)}else{if(AV===e.TAB){AA(AU,AS)}else{if(e.ARROW_KEY_EXP.test(AV)){i(AU,AS,AV)}}}}}function AA(AW,AT){if(!AH){return}var AV=I.getTarget(AT),AR=AT.shiftKey,AS=AW.id+"-prev-year",AX=AV.id===AS,AU=AV.id===AW.id+"-next-year";if(AR&&AX||!AR&&AU){I.preventDefault(AT)}else{if(AV.tabIndex===-1&&AH){I.preventDefault(AT);document.getElementById(AS).focus()}}}function i(AX,AT,AW){var AV=I.getTarget(AT),AU=AV.id.match(z),AS,AR;if(AU){if(AW===e.LEFT){AS=-1}else{if(AW===e.RIGHT){AS=1}else{if(AW===e.UP){AS=-7}else{if(AW===e.DOWN){AS=7}}}}if(AS){AS=+AU[1]+AS}}else{AS=0}AR=document.getElementById(AX.id+"-day"+AS);if(AR){k(AR)}}function k(AR){if(AH){AR.tabIndex=0;AR.focus();AR.tabIndex=-1}}function L(AS){if(l){AS.onshow();return}AP(document,"onmousedown",n);AP(document,"onmouseup",AL);if(!AS._isHidden){return}if(a){o(a)}u(AS);AS._isHidden=false;var AR=document.getElementById(AS.calendarId),AT=AR.style;v(AS.id,AT);if(AS.useAnim){f(AS)}AS.onshow(AS);AS.show(AT);a=AS;AS.setDate(AB(AS));T(AS,AR);AR.parentNode.style.zIndex="100"}function T(AS,AR){if(AH){if(AS.selectedId){setTimeout(function(){var AU=document.getElementById(AS.selectedId);try{AU.focus()}catch(AT){}finally{AS=AR=AU=null}},120)}else{AR.focus()}}}function v(AT,AV){var AS=document.getElementById(AT),AR=AS.parentNode,AU=E.getOffsetCoords(AS,AR);AV.left=AU.x+"px";AV.top=AU.y+AS.offsetHeight+"px"}function o(AS){if(AS._isHidden){return}AS.onhide();if(l){return}var AR=document.getElementById(AS.calendarId);if(AR!==null){AS.hide(AR.style);AR.parentNode.style.zIndex=""}AS._isHidden=true}var W;function AF(AS){AS=AS||window.event;if(AS.button>1){return}var AT=I.getTarget(AS),AR=AT.id;if(p.test(AR)){N(this,AT);if(U.test(AR)){W=r(this,AR);if(W){W.startAfter(400)}}}}function r(AU,AR){var AS,AT=Z.getById(AU.id.replace(/-calendar$/,""));if(q){if(!W){W=new q.Animation(3000)}W.run=function AS(){AE(AT,AR)};AS=null}return W}function N(AV,AU){var AS,AT=AU.id,AR;AS=Z.getById(AV.id.replace(/-calendar$/,""));if(z.test(AT)){if(AS.hideOnSelect||AT!==AS.selectedId){AR=+AU.firstChild.data;if(AR){h(AS,AR,AU,AT)}}}else{if(U.test(AT)){AE(AS,AT)}}}function h(AT,AR,AX,AS,AW){var AV=document.getElementById(AT.selectedId),AU=M;if(AV){E.removeClass(AV,AU)}E.addClass(AX,AU);AT.selectedId=AX.id;AQ(AT,AR);AT.onselect();if(AT.hideOnSelect){document.getElementById(AT.id).focus();setTimeout(function(){o(AT,AW);AT=AX=AV=null},150)}}function AE(AS,AU){var AR=new Date(AS.displayDate),AT=U.exec(AU)[1];if(AT==="next-year"){AR.setFullYear(AR.getFullYear()+1)}else{if(AT==="prev-year"){AR.setFullYear(AR.getFullYear()-1)}else{if(AT==="next-month"){AR.setMonth(AR.getMonth()+1)}else{if(AT==="prev-month"){AR.setMonth(AR.getMonth()-1)}}}}AS.setDate(AR)}function AQ(AU,AR){var AS=AU.displayDate||new Date,AT;AS.setDate(AR);AT=x(AS);document.getElementById(AU.id).value=AT}function AO(){return false}function x(AS){var AU=("000"+AS.getFullYear()).slice(-4),AT=("0"+(AS.getMonth()+1)).slice(-2),AR=("0"+(AS.getDate())).slice(-2);return AU+"-"+AT+"-"+AR}function AD(AR){AR=AR||window.event;var AT=AR.keyCode,AS;if(AT===e.ESC||AT===e.ENTER){I.preventDefault(AR);AS=Z.getById(this.id);if(AT===27){o(AS)}else{if(AT===e.ENTER){if(AS._isHidden){L(AS)}else{o(AS)}}}}}function n(AS){if(!a){return}var AT=E.Event.getTarget(AS),AU=document,AR=AU.getElementById(a.calendarId);if(AT&&AT.id!==a.id&&!AR||!E.contains(AR,AT,true)){o(a);a=null;AJ(AU,"onmousedown",n);AJ(AU,"onmouseup",AL)}}function AL(AR){W&&W.stop()}function X(AS){var AR=AN[AS];if(!AR){AR=AN[AS]=new O(AS,d,j,q.Transitions.getSigmoid(3))}return AR}function f(AR){if(AR.useAnim){X(AR.calendarId).seekTo(1)}}function m(){if(this.useAnim){X(this.calendarId).seekTo(0)}}b.prototype={hideOnSelect:true,useAnim:true,initEvents:function(){if(l){return}var AS=document,AR=AS.getElementById(this.id);AP(AR,"onfocus",y);AP(AR,"onkeydown",AD);AP(AR,"onclick",y)},purgeEvents:function(){var AS=document,AR=AS.getElementById(this.id);if(AR){AJ(AR,"onfocus",y);AJ(AR,"onkeydown",AD);AJ(AR,"onclick",y)}AJ(AS,"onmousedown",n);AJ(AS,"onmouseup",AL)},calendarId:"",hiddenDayClass:"ape-calendar-empty-day",calendarClass:"ape-calendar",show:function(AR){AR.visibility="visible"},hide:function(AR){AR.visibility="hidden"},isShown:function(AR){return AR.visibility==="visible"},onshow:AI,onhide:AI,onselect:AI,getDate:function(){return this.displayDate||AB(this)},setDate:function(AS){if(l){document.getElementById(this.id).value=x(AS);return}var AR=AS!=null,AT=1000*60*60*24;AS=AR?new Date(AS):new Date;if(!this.displayDate||!this.selectedId||Math.abs(this.displayDate-AS.getTime())>AT){this.displayDate=AS;t(this,AR)}}};return b}});