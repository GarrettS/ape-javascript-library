APE.namespace("APE.widget");(function(){var C=self.APE,F=C.widget,D=C.dom;F.Calendar=C.createFactory(B,J);function B(K){this.id=K;if(G){return}this._isHidden=true;this.initEvents()}var E=document.createElement("input");E.setAttribute("type","date");var G=F.Calendar.IS_NATIVE=/date/i.test(E.type),A=[31,28,31,30,31,30,31,31,30,31,30,31];E=null;function H(L){var K=document.getElementById(L.id);return I(K.value)}function I(M){var L=/^\s*([\d]{4})-(\d\d)-(\d\d)\s*$/,K=null,O,N=L.exec(M);if(N){K=new Date(0);O=+N[2];K.setFullYear(N[1],O-1,N[3]);if(O===K.getMonth()+1){K.setHours(0,0,0,0)}else{K=null}}return K}function J(){var j=D.Event,N=C.EventPublisher,AB=N.add,w=N.remove,V=document.body,U=null,e=typeof V.textContent==="string"?"textContent":"innerText",u=typeof V.focus!=="undefined",t="ape-calendar-focused-el",K="ape-calendar-selected-day",R=/-((?:next|prev)-(?:month|year))$/,d=/-next-|-prev-|-day\d/,W=D.key,v=Function.prototype;V=null;function h(AF,AK){var AE=F.CalendarLocale,AO=AF.displayDate;if(!AE){throw Error("Missing Resource: APE.widget.CalendarLocale")}i(AF);var AH=document,AI=AO.getFullYear(),AG=AO.getMonth(),AM=AE.months.abbr[AG],AJ=g(AO),AN=AH.getElementById(AF.calendarId),AL=AN.getElementsByTagName("tbody")[0].getElementsByTagName("b"),AD=AH.getElementById(AF.calendarId+"-header");AD.firstChild.data=AI+", "+AM;p(AF,AI,AG,AJ,AL);z(AF,AJ,AL);if(AK){P(AF,AJ+AO.getDate(),AL)}}function g(AD){AD=new Date(AD);AD.setDate(1);return AD.getDay()}function p(AG,AL,AK,AM,AN){var AH=0,AF=0,AI=A[AK],AE,AJ=AG.id+"-day",AD=(0==(AL%4))&&((0!=(AL%100))||(0==(AL%400)));if(AK===1&&AD){AI+=1}while(AH<AM){AE=AN[AH++];AE[e]=" ";AE.className=AG.hiddenDayClass;AE.id=""}while(AF++<AI){AE=AN[AH++];AE.id=AJ+(AF-1);AE[e]=AF+"";AE.tabIndex=-1;AE.className=""}for(AH=AM+AI,AF=AN.length;AH<AF;AH++){AE=AN[AH];AE[e]=" ";AE.className=AG.hiddenDayClass}}function z(AG,AD,AF){if(O(AG)){var AE=AD+new Date().getDate()-1;D.addClass(AF[AE],AG.calendarClass+"-today")}}function P(AG,AF,AE){if(O(AG)&&!AG.selectedId){var AD=AE[AF-1];D.addClass(AD,K);AG.selectedId=AD.id}}function O(AE){var AD=H(AE)||new Date;return AD!=null&&AE.displayDate.getYear()==AD.getYear()&&AE.displayDate.getMonth()==AD.getMonth()}function i(AG){if(!AG.calendarId){AG.calendarId=AG.id+"-calendar"}var AJ=document;if(AJ.getElementById(AG.calendarId)!==null){return}var AM=AJ.createElement("div"),AL,AK=AJ.getElementById(AG.id),AE=AK.parentNode,AH=l(),AD=F.CalendarLocale,AF=AD.days.abbr,AI="<thead><tr class='calendar-button-row'><th id='"+AG.id+"-prev-year' tabindex='0' title='"+AD.previousYear+"'>&#x00ab;</th><th id='"+AG.id+"-prev-month' tabindex='0' title='"+AD.previousMonth+"'>&#x2039;</th><th colspan='3' class='ape-calendar-header'><div id='"+AG.calendarId+"-header'>-</div></th><th id='"+AG.id+"-next-month' tabindex='0' title='"+AD.nextMonth+"' class='"+AG.calendarClass+"-days'>&#x203A;</th><th id='"+AG.id+"-next-year' tabindex='0' title='"+AD.nextYear+"'>&#x00bb;</th></tr><tr><th>"+AF.join("</th><th>")+"</th></tr></thead>";AM.onselectstart=AA;AM.innerHTML="<table>"+AI+AH+"</table>";AM.id=AG.calendarId;AM.className=AG.calendarClass;AM.tabIndex=0;AM.onmousedown=s;AM.onkeydown=T;AL=AM.firstChild;if("onfocusin" in AL){AL.onfocusin=X;AL.onfocusout=x}AE.insertBefore(AM,AK.nextSibling)}function l(){var AG=[],AF=6,AD=[],AE;AG.length=8;AD.length=AF;AG=AG.join("<td><b>&nbsp;</b></td>");for(AE=0;AE<AF;AE++){AD[AE]="<tr id='w"+AE+1+"'>"+AG+"</tr>\n"}return"<tbody>"+AD.join("")+"</tbody>"}function X(AD){var AE=j.getTarget(AD);if(d.test(AE.id)&&AE!==null){D.addClass(AE,t)}}function x(AD){var AE=j.getTarget(AD);if(AE!==null){D.removeClass(AE,t)}}function n(AE){AE=AE||window.event;var AF=F.Calendar.getById(this.id),AD=document.getElementById(AF.id),AG=AE.relatedTarget||AE.fromElement;if(AF._isHidden&&(!AG||(AG!==AD&&!D.contains(AD,AG)))){L(AF,AE)}}function T(AE){AE=AE||window.event;var AH=AE.keyCode,AD=this.id.replace(/-calendar$/,""),AG=F.Calendar.getById(AD),AF;if(AH===W.ESC){if(!AG._isHidden){document.getElementById(AD).focus();c(AG)}}else{if(AH===W.ENTER){AF=j.getTarget(AE);M(this,AF)}else{if(AH===W.TAB){o(AG,AE)}else{if(W.ARROW_KEY_EXP.test(AH)){Z(AG,AE,AH)}}}}}function o(AI,AF){if(!u){return}var AH=j.getTarget(AF),AD=AF.shiftKey,AE=AI.id+"-prev-year",AJ=AH.id===AE,AG=AH.id===AI.id+"-next-year";if(AD&&AJ||!AD&&AG){j.preventDefault(AF)}else{if(AH.tabIndex===-1&&u){j.preventDefault(AF);document.getElementById(AE).focus()}}}function Z(AJ,AF,AI){var AH=j.getTarget(AF),AG=AH.id.match(/-day(\d+)$/),AE,AD;if(AG){if(AI===W.LEFT){AE=-1}else{if(AI===W.RIGHT){AE=1}else{if(AI===W.UP){AE=-7}else{if(AI===W.DOWN){AE=7}}}}if(AE){AE=+AG[1]+AE}}else{AE=0}AD=document.getElementById(AJ.id+"-day"+AE);if(AD){a(AD)}}function a(AD){if(u){AD.tabIndex=0;AD.focus();AD.tabIndex=-1}}function L(AE){if(G){AE.onshow();return}AB(document,"onmousedown",b);AB(document,"onmouseup",y);if(!AE._isHidden){return}if(U){c(U)}i(AE);AE._isHidden=false;var AD=document.getElementById(AE.calendarId),AF=AD.style;k(AE.id,AF);AE.onshow();AE.show(AF);U=AE;AE.setDate(H(AE));Q(AE,AD);AD.parentNode.style.zIndex="100"}function Q(AE,AD){if(u){if(AE.selectedId){setTimeout(function(){var AG=document.getElementById(AE.selectedId);try{AG.focus()}catch(AF){}finally{AE=AD=AG=null}},120)}else{AD.focus()}}}function k(AE,AF){var AD=document.getElementById(AE);AF.left=AD.offsetLeft+"px";AF.top=AD.offsetTop+AD.offsetHeight+"px"}function c(AE){if(AE._isHidden){return}AE.onhide();if(G){return}var AD=document.getElementById(AE.calendarId);if(AD!==null){AE.hide(AD.style);AD.parentNode.style.zIndex=""}AE._isHidden=true}var S;function s(AE){AE=AE||window.event;if(AE.button>1){return}var AF=j.getTarget(AE),AD=AF.id;if(d.test(AD)){M(this,AF);if(R.test(AD)){S=f(this,AD);if(S){S.startAfter(400)}}}}function f(AH,AD){var AF,AE=C.anim,AG=F.Calendar.getById(AH.id.replace(/-calendar$/,""));if(AE){if(!S){S=new AE.Animation(90)}S.run=function AF(){r(AG,AD)};AF=null}return S}function M(AH,AG){var AE,AF=AG.id,AD;AE=F.Calendar.getById(AH.id.replace(/-calendar$/,""));if(/-day\d/.test(AF)){if(AE.hideOnSelect||AF!==AE.selectedId){AD=+AG.firstChild.data;if(AD){Y(AE,AD,AG,AF)}}}else{if(R.test(AF)){r(AE,AF)}}}function Y(AF,AD,AJ,AE,AI){var AH=document.getElementById(AF.selectedId),AG=K;if(AH){D.removeClass(AH,AG)}D.addClass(AJ,AG);AF.selectedId=AJ.id;AC(AF,AD);AF.onselect();if(AF.hideOnSelect){document.getElementById(AF.id).focus();setTimeout(function(){c(AF,AI);AF=AJ=AH=null},150)}}function r(AE,AG){var AD=new Date(AE.displayDate),AF=R.exec(AG)[1];if(AF==="next-year"){AD.setFullYear(AD.getFullYear()+1)}else{if(AF==="prev-year"){AD.setFullYear(AD.getFullYear()-1)}else{if(AF==="next-month"){AD.setMonth(AD.getMonth()+1)}else{if(AF==="prev-month"){AD.setMonth(AD.getMonth()-1)}}}}AE.setDate(AD)}function AC(AG,AD){var AE=AG.displayDate||new Date,AF;AE.setDate(AD);AF=m(AE);document.getElementById(AG.id).value=AF}function AA(){return false}function m(AE){var AG=("000"+AE.getFullYear()).slice(-4),AF=("0"+(AE.getMonth()+1)).slice(-2),AD=("0"+(AE.getDate())).slice(-2);return AG+"-"+AF+"-"+AD}function q(AD){AD=AD||window.event;var AF=AD.keyCode,AE;if(AF===W.ESC||AF===W.ENTER){j.preventDefault(AD);AE=F.Calendar.getById(this.id);if(AF===27){c(AE)}else{if(AF===W.ENTER){if(AE._isHidden){L(AE)}else{c(AE)}}}}}function b(AE){if(!U){return}var AF=D.Event.getTarget(AE),AG=document,AD=AG.getElementById(U.calendarId);if(AF&&AF.id!==U.id&&!AD||!D.contains(AD,AF,true)){c(U);U=null;w(AG,"onmousedown",b);w(AG,"onmouseup",y)}}function y(AD){S&&S.stop()}return{hideOnSelect:true,initEvents:function(){if(G){return}var AE=document,AD=AE.getElementById(this.id);AB(AD,"onfocus",n);AB(AD,"onkeydown",q);AB(AD,"onclick",n)},purgeEvents:function(){var AE=document,AD=AE.getElementById(this.id);if(AD){w(AD,"onfocus",n);w(AD,"onkeydown",q);w(AD,"onclick",n)}w(AE,"onmousedown",b);w(AE,"onmouseup",y)},calendarId:"",hiddenDayClass:"ape-calendar-empty-day",calendarClass:"ape-calendar",show:function(AD){AD.visibility="visible"},hide:function(AD){AD.visibility="hidden"},isShown:function(AD){return AD.visibility==="visible"},onshow:v,onhide:v,onselect:v,getDate:function(){return this.displayDate||H(this)},setDate:function(AE){if(G){document.getElementById(this.id).value=m(AE);return}var AD=AE!=null,AF=1000*60*60*24;AE=AD?new Date(AE):new Date;if(!this.displayDate||!this.selectedId||Math.abs(this.displayDate-AE.getTime())>AF){this.displayDate=AE;h(this,AD)}}}}})();