APE.namespace("APE.widget");(function(){var C=self.APE,F=C.widget,D=C.dom;F.Calendar=C.createFactory(B,J);function B(K){this.id=K;if(G){return}this._isHidden=true;this.initEvents()}var E=document.createElement("input");E.setAttribute("type","date");var G=F.Calendar.IS_NATIVE=/date/i.test(E.type),A=[31,28,31,30,31,30,31,31,30,31,30,31];E=null;function H(L){var K=document.getElementById(L.id);return I(K.value)}function I(M){var L=/^\s*(\d{4})-(\d\d)-(\d\d)\s*$/,K=null,O,N=L.exec(M);if(N){K=new Date(0);O=+N[2];K.setFullYear(N[1],O-1,N[3]);if(O===K.getMonth()+1){K.setHours(0,0,0,0)}else{K=null}}return K}function J(){var j=D.Event,N=C.EventPublisher,AC=N.add,x=N.remove,V=document.body,U=null,e=typeof V.textContent==="string"?"textContent":"innerText",v=typeof V.focus!=="undefined",u="ape-calendar-focused-el",K="ape-calendar-selected-day",R=/-((?:next|prev)-(?:month|year))$/,d=/-next-|-prev-|-day\d/,o=/-day(\d+)$/,W=D.key,w=Function.prototype;V=null;function h(AG,AL){var AF=F.CalendarLocale,AP=AG.displayDate;if(!AF){throw Error("Missing Resource: APE.widget.CalendarLocale")}i(AG);var AI=document,AJ=AP.getFullYear(),AH=AP.getMonth(),AN=AF.months.abbr[AH],AK=g(AP),AO=AI.getElementById(AG.calendarId),AM=AO.getElementsByTagName("tbody")[0].getElementsByTagName("b"),AE=AI.getElementById(AG.calendarId+"-header");AE.firstChild.data=AJ+", "+AN;q(AG,AJ,AH,AK,AM);AA(AG,AK,AM);if(AL){P(AG,AK+AP.getDate(),AM)}}function g(AE){AE=new Date(AE);AE.setDate(1);return AE.getDay()}function q(AH,AM,AL,AN,AO){var AI=0,AG=0,AJ=A[AL],AF,AK=AH.id+"-day",AE=(0==(AM%4))&&((0!=(AM%100))||(0==(AM%400)));if(AL===1&&AE){AJ+=1}while(AI<AN){AF=AO[AI++];AF[e]=" ";AF.className=AH.hiddenDayClass;AF.id=""}while(AG++<AJ){AF=AO[AI++];AF.id=AK+(AG-1);AF[e]=AG+"";AF.tabIndex=-1;AF.className=""}for(AI=AN+AJ,AG=AO.length;AI<AG;AI++){AF=AO[AI];AF[e]=" ";AF.className=AH.hiddenDayClass}}function AA(AH,AE,AG){if(O(AH)){var AF=AE+new Date().getDate()-1;D.addClass(AG[AF],AH.calendarClass+"-today")}}function P(AH,AG,AF){if(O(AH)&&!AH.selectedId){var AE=AF[AG-1];D.addClass(AE,K);AH.selectedId=AE.id}}function O(AF){var AE=H(AF)||new Date;return AE!=null&&AF.displayDate.getYear()==AE.getYear()&&AF.displayDate.getMonth()==AE.getMonth()}function i(AH){if(!AH.calendarId){AH.calendarId=AH.id+"-calendar"}var AK=document;if(AK.getElementById(AH.calendarId)!==null){return}var AN=AK.createElement("div"),AM,AL=AK.getElementById(AH.id),AF=AL.parentNode,AI=l(),AE=F.CalendarLocale,AG=AE.days.abbr,AJ="<thead><tr class='calendar-button-row'><th id='"+AH.id+"-prev-year' tabindex='0' title='"+AE.previousYear+"'>&#x00ab;</th><th id='"+AH.id+"-prev-month' tabindex='0' title='"+AE.previousMonth+"'>&#x2039;</th><th colspan='3' class='ape-calendar-header'><div id='"+AH.calendarId+"-header'>-</div></th><th id='"+AH.id+"-next-month' tabindex='0' title='"+AE.nextMonth+"' class='"+AH.calendarClass+"-days'>&#x203A;</th><th id='"+AH.id+"-next-year' tabindex='0' title='"+AE.nextYear+"'>&#x00bb;</th></tr><tr><th>"+AG.join("</th><th>")+"</th></tr></thead>";AN.onselectstart=AB;AN.innerHTML="<table>"+AJ+AI+"</table>";AN.id=AH.calendarId;AN.className=AH.calendarClass;AN.tabIndex=0;AN.onmousedown=t;AN.onkeydown=T;AM=AN.firstChild;if("onfocusin" in AM){AM.onfocusin=X;AM.onfocusout=y}AF.insertBefore(AN,AL.nextSibling)}function l(){var AH=[],AG=6,AE=[],AF;AH.length=8;AE.length=AG;AH=AH.join("<td><b>&nbsp;</b></td>");for(AF=0;AF<AG;AF++){AE[AF]="<tr id='w"+AF+1+"'>"+AH+"</tr>\n"}return"<tbody>"+AE.join("")+"</tbody>"}function X(AE){var AF=j.getTarget(AE);if(d.test(AF.id)&&AF!==null){D.addClass(AF,u)}}function y(AE){var AF=j.getTarget(AE);if(AF!==null){D.removeClass(AF,u)}}function n(AF){AF=AF||window.event;var AG=F.Calendar.getById(this.id),AE=document.getElementById(AG.id),AH=AF.relatedTarget||AF.fromElement;if(AG._isHidden&&(!AH||(AH!==AE&&!D.contains(AE,AH)))){L(AG,AF)}}function T(AF){AF=AF||window.event;var AI=AF.keyCode,AE=this.id.replace(/-calendar$/,""),AH=F.Calendar.getById(AE),AG;if(AI===W.ESC){if(!AH._isHidden){document.getElementById(AE).focus();c(AH)}}else{if(AI===W.ENTER){AG=j.getTarget(AF);M(this,AG)}else{if(AI===W.TAB){p(AH,AF)}else{if(W.ARROW_KEY_EXP.test(AI)){Z(AH,AF,AI)}}}}}function p(AJ,AG){if(!v){return}var AI=j.getTarget(AG),AE=AG.shiftKey,AF=AJ.id+"-prev-year",AK=AI.id===AF,AH=AI.id===AJ.id+"-next-year";if(AE&&AK||!AE&&AH){j.preventDefault(AG)}else{if(AI.tabIndex===-1&&v){j.preventDefault(AG);document.getElementById(AF).focus()}}}function Z(AK,AG,AJ){var AI=j.getTarget(AG),AH=AI.id.match(o),AF,AE;if(AH){if(AJ===W.LEFT){AF=-1}else{if(AJ===W.RIGHT){AF=1}else{if(AJ===W.UP){AF=-7}else{if(AJ===W.DOWN){AF=7}}}}if(AF){AF=+AH[1]+AF}}else{AF=0}AE=document.getElementById(AK.id+"-day"+AF);if(AE){a(AE)}}function a(AE){if(v){AE.tabIndex=0;AE.focus();AE.tabIndex=-1}}function L(AF){if(G){AF.onshow();return}AC(document,"onmousedown",b);AC(document,"onmouseup",z);if(!AF._isHidden){return}if(U){c(U)}i(AF);AF._isHidden=false;var AE=document.getElementById(AF.calendarId),AG=AE.style;k(AF.id,AG);AF.onshow();AF.show(AG);U=AF;AF.setDate(H(AF));Q(AF,AE);AE.parentNode.style.zIndex="100"}function Q(AF,AE){if(v){if(AF.selectedId){setTimeout(function(){var AH=document.getElementById(AF.selectedId);try{AH.focus()}catch(AG){}finally{AF=AE=AH=null}},120)}else{AE.focus()}}}function k(AF,AG){var AE=document.getElementById(AF);AG.left=AE.offsetLeft+"px";AG.top=AE.offsetTop+AE.offsetHeight+"px"}function c(AF){if(AF._isHidden){return}AF.onhide();if(G){return}var AE=document.getElementById(AF.calendarId);if(AE!==null){AF.hide(AE.style);AE.parentNode.style.zIndex=""}AF._isHidden=true}var S;function t(AF){AF=AF||window.event;if(AF.button>1){return}var AG=j.getTarget(AF),AE=AG.id;if(d.test(AE)){M(this,AG);if(R.test(AE)){S=f(this,AE);if(S){S.startAfter(400)}}}}function f(AI,AE){var AG,AF=C.anim,AH=F.Calendar.getById(AI.id.replace(/-calendar$/,""));if(AF){if(!S){S=new AF.Animation(90)}S.run=function AG(){s(AH,AE)};AG=null}return S}function M(AI,AH){var AF,AG=AH.id,AE;AF=F.Calendar.getById(AI.id.replace(/-calendar$/,""));if(o.test(AG)){if(AF.hideOnSelect||AG!==AF.selectedId){AE=+AH.firstChild.data;if(AE){Y(AF,AE,AH,AG)}}}else{if(R.test(AG)){s(AF,AG)}}}function Y(AG,AE,AK,AF,AJ){var AI=document.getElementById(AG.selectedId),AH=K;if(AI){D.removeClass(AI,AH)}D.addClass(AK,AH);AG.selectedId=AK.id;AD(AG,AE);AG.onselect();if(AG.hideOnSelect){document.getElementById(AG.id).focus();setTimeout(function(){c(AG,AJ);AG=AK=AI=null},150)}}function s(AF,AH){var AE=new Date(AF.displayDate),AG=R.exec(AH)[1];if(AG==="next-year"){AE.setFullYear(AE.getFullYear()+1)}else{if(AG==="prev-year"){AE.setFullYear(AE.getFullYear()-1)}else{if(AG==="next-month"){AE.setMonth(AE.getMonth()+1)}else{if(AG==="prev-month"){AE.setMonth(AE.getMonth()-1)}}}}AF.setDate(AE)}function AD(AH,AE){var AF=AH.displayDate||new Date,AG;AF.setDate(AE);AG=m(AF);document.getElementById(AH.id).value=AG}function AB(){return false}function m(AF){var AH=("000"+AF.getFullYear()).slice(-4),AG=("0"+(AF.getMonth()+1)).slice(-2),AE=("0"+(AF.getDate())).slice(-2);return AH+"-"+AG+"-"+AE}function r(AE){AE=AE||window.event;var AG=AE.keyCode,AF;if(AG===W.ESC||AG===W.ENTER){j.preventDefault(AE);AF=F.Calendar.getById(this.id);if(AG===27){c(AF)}else{if(AG===W.ENTER){if(AF._isHidden){L(AF)}else{c(AF)}}}}}function b(AF){if(!U){return}var AG=D.Event.getTarget(AF),AH=document,AE=AH.getElementById(U.calendarId);if(AG&&AG.id!==U.id&&!AE||!D.contains(AE,AG,true)){c(U);U=null;x(AH,"onmousedown",b);x(AH,"onmouseup",z)}}function z(AE){S&&S.stop()}return{hideOnSelect:true,initEvents:function(){if(G){return}var AF=document,AE=AF.getElementById(this.id);AC(AE,"onfocus",n);AC(AE,"onkeydown",r);AC(AE,"onclick",n)},purgeEvents:function(){var AF=document,AE=AF.getElementById(this.id);if(AE){x(AE,"onfocus",n);x(AE,"onkeydown",r);x(AE,"onclick",n)}x(AF,"onmousedown",b);x(AF,"onmouseup",z)},calendarId:"",hiddenDayClass:"ape-calendar-empty-day",calendarClass:"ape-calendar",show:function(AE){AE.visibility="visible"},hide:function(AE){AE.visibility="hidden"},isShown:function(AE){return AE.visibility==="visible"},onshow:w,onhide:w,onselect:w,getDate:function(){return this.displayDate||H(this)},setDate:function(AF){if(G){document.getElementById(this.id).value=m(AF);return}var AE=AF!=null,AG=1000*60*60*24;AF=AE?new Date(AF):new Date;if(!this.displayDate||!this.selectedId||Math.abs(this.displayDate-AF.getTime())>AG){this.displayDate=AF;h(this,AE)}}}}})();