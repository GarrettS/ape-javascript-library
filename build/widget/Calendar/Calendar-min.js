APE.namespace("APE.widget").createCustomFactory("Calendar",function(C){var F=document.createElement("input"),D=window.APE,E=D.dom,J=E.Event,K={},L="ape-calendar-input";F.setAttribute("type","date");D.createMixin(C,{IS_NATIVE:/date/i.test(F.type),registerDelegateFor:I});return A;function I(O,M,N){K[O]=K[O]||J.addDelegatedFocus(document.documentElement,B(O,M,N))}function B(O,M,N){return function(P){H(P,O,M,N)}}function H(O,Q,M,N){var P=J.getTarget(O);if(P.id===Q&&(!N||N(P)!=false)){J.removeDelegatedFocus(document.documentElement,K[Q]);delete K[Q];C.getById(Q,M)}}function G(M){return E.hasToken(M.className,L)}function A(a){function c(AT,AS){this.id=AT;if(m){return}AS&&D.createMixin(this,AS);if(this.useAnim){this.hide=n}this._isHidden=true;this.initEvents()}function AC(AT){var AS=document.getElementById(AT.id);return W(AS.value)}function W(AU){var AT=/^\s*(\d{4})-(\d\d)-(\d\d)\s*$/,AS=null,AW,AV=AT.exec(AU);if(AV){AS=new Date(0);AW=+AV[2];AS.setFullYear(AV[1],AW-1,AV[3]);if(AW===AS.getMonth()+1){AS.setHours(0,0,0,0)}else{AS=null}}return AS}var AJ=Function.prototype,Q=D.EventPublisher,AQ=Q.add,AK=Q.remove,d=document.body,b=null,AI=typeof d.focus!=="undefined",AH="ape-calendar-focused-el",N="ape-calendar-selected-day",V=/-((?:next|prev)-(?:month|year))$/,q=/-next-|-prev-|-day\d/,AA=/-day(\d+)$/,f=E.key,m=a.IS_NATIVE,T=[31,28,31,30,31,30,31,31,30,31,30,31],r=D.anim,P=r.StyleTransition,k=0.1,AO={},e={opacity:0.98,width:"14.4em",height:"14.4em",visibility:"visible"};function u(AU,AZ){var AT=D.widget.CalendarLocale,Ad=AU.displayDate;if(!AT){throw Error("Missing Resource: APE.widget.CalendarLocale")}v(AU);var AW=document,AX=Ad.getFullYear(),AV=Ad.getMonth(),Ab=AT.months.abbr[AV],AY=t(Ad),Ac=AW.getElementById(AU.calendarId),Aa=Ac.getElementsByTagName("tbody")[0].getElementsByTagName("b"),AS=AW.getElementById(AU.calendarId+"-header");AS.firstChild.data=AX+", "+Ab;AD(AU,AX,AV,AY,Aa);AN(AU,AY,Aa);if(AZ){S(AU,AY+Ad.getDate(),Aa)}}function t(AS){AS=new Date(AS);AS.setDate(1);return AS.getDay()}function AD(AV,Aa,AZ,Ab,Ac){var AW=0,AU=0,AX=T[AZ],AT,AY=AV.id+"-day",AS=(0==(Aa%4))&&((0!=(Aa%100))||(0==(Aa%400)));if(AZ===1&&AS){AX+=1}while(AW<Ab){AT=Ac[AW++];AT[E.TEXT_CONTENT]=" ";AT.className=AV.hiddenDayClass;AT.id=""}while(AU++<AX){AT=Ac[AW++];AT.id=AY+(AU-1);AT[E.TEXT_CONTENT]=AU+"";AT.tabIndex=-1;AT.className=""}for(AW=Ab+AX,AU=Ac.length;AW<AU;AW++){AT=Ac[AW];AT[E.TEXT_CONTENT]=" ";AT.className=AV.hiddenDayClass}}function AN(AV,AS,AU){if(R(AV)){var AT=AS+new Date().getDate()-1;E.addClass(AU[AT],AV.calendarClass+"-today")}}function S(AV,AU,AT){if(R(AV)&&!AV.selectedId){var AS=AT[AU-1];E.addClass(AS,N);AV.selectedId=AS.id}}function R(AT){var AS=AC(AT)||new Date;return AS!=null&&AT.displayDate.getYear()==AS.getYear()&&AT.displayDate.getMonth()==AS.getMonth()}function v(AV){if(!AV.calendarId){AV.calendarId=AV.id+"-calendar"}var AY=document;if(AY.getElementById(AV.calendarId)!==null){return}var Ab=AY.createElement("div"),Aa,AZ=AY.getElementById(AV.id),AT=AZ.parentNode,AW=x(),AS=D.widget.CalendarLocale,AU=AS.days.abbr,AX="<thead><tr class='calendar-button-row'><th id='"+AV.id+"-prev-year' tabindex='0' title='"+AS.previousYear+"'>&#x00ab;</th><th id='"+AV.id+"-prev-month' tabindex='0' title='"+AS.previousMonth+"'>&#x2039;</th><th colspan='3' class='ape-calendar-header'><div id='"+AV.calendarId+"-header'>-</div></th><th id='"+AV.id+"-next-month' tabindex='0' title='"+AS.nextMonth+"' class='"+AV.calendarClass+"-days'>&#x203A;</th><th id='"+AV.id+"-next-year' tabindex='0' title='"+AS.nextYear+"'>&#x00bb;</th></tr><tr><th>"+AU.join("</th><th>")+"</th></tr></thead>";Ab.onselectstart=AP;Ab.innerHTML="<table>"+AX+AW+"</table>";Ab.id=AV.calendarId;Ab.className=AV.calendarClass;if(AV.useAnim){E.addClass(Ab,"ape-calendar-anim-start")}Ab.tabIndex=0;Ab.onmousedown=AG;Ab.onkeydown=Z;Aa=Ab.firstChild;if("onfocusin" in Aa){Aa.onfocusin=h;Aa.onfocusout=AL}AT.insertBefore(Ab,AZ.nextSibling)}function x(){var AV=[],AU=6,AS=[],AT;AV.length=8;AS.length=AU;AV=AV.join("<td><b>&nbsp;</b></td>");for(AT=0;AT<AU;AT++){AS[AT]="<tr id='w"+AT+1+"'>"+AV+"</tr>\n"}return"<tbody>"+AS.join("")+"</tbody>"}function h(AS){var AT=J.getTarget(AS);if(q.test(AT.id)&&AT!==null){E.addClass(AT,AH)}}function AL(AS){var AT=J.getTarget(AS);if(AT!==null){E.removeClass(AT,AH)}}function z(AT){AT=AT||window.event;var AU=a.getById(this.id),AS=document.getElementById(AU.id),AV=AT.relatedTarget||AT.fromElement;if(AU._isHidden&&(!AV||(AV!==AS&&!E.contains(AS,AV)))){M(AU,AT)}}function Z(AT){AT=AT||window.event;var AW=AT.keyCode,AS=this.id.replace(/-calendar$/,""),AV=a.getById(AS),AU;if(AW===f.ESC){if(!AV._isHidden){document.getElementById(AS).focus();p(AV)}}else{if(AW===f.ENTER){AU=J.getTarget(AT);O(this,AU)}else{if(AW===f.TAB){AB(AV,AT)}else{if(f.ARROW_KEY_EXP.test(AW)){j(AV,AT,AW)}}}}}function AB(AX,AU){if(!AI){return}var AW=J.getTarget(AU),AS=AU.shiftKey,AT=AX.id+"-prev-year",AY=AW.id===AT,AV=AW.id===AX.id+"-next-year";if(AS&&AY||!AS&&AV){J.preventDefault(AU)}else{if(AW.tabIndex===-1&&AI){J.preventDefault(AU);document.getElementById(AT).focus()}}}function j(AY,AU,AX){var AW=J.getTarget(AU),AV=AW.id.match(AA),AT,AS;if(AV){if(AX===f.LEFT){AT=-1}else{if(AX===f.RIGHT){AT=1}else{if(AX===f.UP){AT=-7}else{if(AX===f.DOWN){AT=7}}}}if(AT){AT=+AV[1]+AT}}else{AT=0}AS=document.getElementById(AY.id+"-day"+AT);if(AS){l(AS)}}function l(AS){if(AI){AS.tabIndex=0;AS.focus();AS.tabIndex=-1}}function M(AT){if(m){AT.onshow();return}AQ(document,"onmousedown",o);AQ(document,"onmouseup",AM);if(!AT._isHidden){return}if(b){p(b)}v(AT);AT._isHidden=false;var AS=document.getElementById(AT.calendarId),AU=AS.style;w(AT.id,AU);if(AT.useAnim){g(AT)}AT.onshow(AT);AT.show(AU);b=AT;AT.setDate(AC(AT));U(AT,AS);AS.parentNode.style.zIndex="100"}function U(AT,AS){if(AI){if(AT.selectedId){setTimeout(function(){var AV=document.getElementById(AT.selectedId);try{AV.focus()}catch(AU){}finally{AT=AS=AV=null}},120)}else{AS.focus()}}}function w(AU,AW){var AT=document.getElementById(AU),AS=AT.parentNode,AV=E.getOffsetCoords(AT,AS);AW.left=AV.x+"px";AW.top=AV.y+AT.offsetHeight+"px"}function p(AT){if(AT._isHidden){return}AT.onhide();if(m){return}var AS=document.getElementById(AT.calendarId);if(AS!==null){AT.hide(AS.style);AS.parentNode.style.zIndex=""}AT._isHidden=true}var X;function AG(AT){AT=AT||window.event;if(AT.button>1){return}var AU=J.getTarget(AT),AS=AU.id;if(q.test(AS)){O(this,AU);if(V.test(AS)){X=s(this,AS);if(X){X.startAfter(400)}}}}function s(AV,AS){var AT,AU=a.getById(AV.id.replace(/-calendar$/,""));if(r){if(!X){X=new r.Animation(3000)}X.run=function AT(){AF(AU,AS)};AT=null}return X}function O(AW,AV){var AT,AU=AV.id,AS;AT=a.getById(AW.id.replace(/-calendar$/,""));if(AA.test(AU)){if(AT.hideOnSelect||AU!==AT.selectedId){AS=+AV.firstChild.data;if(AS){i(AT,AS,AV,AU)}}}else{if(V.test(AU)){AF(AT,AU)}}}function i(AU,AS,AY,AT,AX){var AW=document.getElementById(AU.selectedId),AV=N;if(AW){E.removeClass(AW,AV)}E.addClass(AY,AV);AU.selectedId=AY.id;AR(AU,AS);AU.onselect();if(AU.hideOnSelect){document.getElementById(AU.id).focus();setTimeout(function(){p(AU,AX);AU=AY=AW=null},150)}}function AF(AT,AV){var AS=new Date(AT.displayDate),AU=V.exec(AV)[1];if(AU==="next-year"){AS.setFullYear(AS.getFullYear()+1)}else{if(AU==="prev-year"){AS.setFullYear(AS.getFullYear()-1)}else{if(AU==="next-month"){AS.setMonth(AS.getMonth()+1)}else{if(AU==="prev-month"){AS.setMonth(AS.getMonth()-1)}}}}AT.setDate(AS)}function AR(AV,AS){var AT=AV.displayDate||new Date,AU;AT.setDate(AS);AU=y(AT);document.getElementById(AV.id).value=AU}function AP(){return false}function y(AT){var AV=("000"+AT.getFullYear()).slice(-4),AU=("0"+(AT.getMonth()+1)).slice(-2),AS=("0"+(AT.getDate())).slice(-2);return AV+"-"+AU+"-"+AS}function AE(AS){AS=AS||window.event;var AU=AS.keyCode,AT;if(AU===f.ESC||AU===f.ENTER){J.preventDefault(AS);AT=a.getById(this.id);if(AU===27){p(AT)}else{if(AU===f.ENTER){if(AT._isHidden){M(AT)}else{p(AT)}}}}}function o(AT){if(!b){return}var AU=E.Event.getTarget(AT),AV=document,AS=AV.getElementById(b.calendarId);if(AU&&AU.id!==b.id&&!AS||!E.contains(AS,AU,true)){p(b);b=null;AK(AV,"onmousedown",o);AK(AV,"onmouseup",AM)}}function AM(AS){X&&X.stop()}function Y(AT){var AS=AO[AT];if(!AS){AS=AO[AT]=new P(AT,e,k,r.Transitions.getSigmoid(3))}return AS}function g(AS){if(AS.useAnim){Y(AS.calendarId).seekTo(1)}}function n(){if(this.useAnim){Y(this.calendarId).seekTo(0)}}c.prototype={hideOnSelect:true,useAnim:true,initEvents:function(){if(m){return}var AT=document,AS=AT.getElementById(this.id);AQ(AS,"onfocus",z);AQ(AS,"onkeydown",AE);AQ(AS,"onclick",z)},purgeEvents:function(){var AT=document,AS=AT.getElementById(this.id);if(AS){AK(AS,"onfocus",z);AK(AS,"onkeydown",AE);AK(AS,"onclick",z)}AK(AT,"onmousedown",o);AK(AT,"onmouseup",AM)},calendarId:"",hiddenDayClass:"ape-calendar-empty-day",calendarClass:"ape-calendar",show:function(AS){AS.visibility="visible"},hide:function(AS){AS.visibility="hidden"},isShown:function(AS){return AS.visibility==="visible"},onshow:AJ,onhide:AJ,onselect:AJ,getDate:function(){return this.displayDate||AC(this)},setDate:function(AT){if(m){document.getElementById(this.id).value=y(AT);return}var AS=AT!=null,AU=1000*60*60*24;AT=AS?new Date(AT):new Date;if(!this.displayDate||!this.selectedId||Math.abs(this.displayDate-AT.getTime())>AU){this.displayDate=AT;u(this,AS)}}};return c}});