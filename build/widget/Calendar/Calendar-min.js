APE.namespace("APE.widget");(function(){var C=self.APE,F=C.widget,D=C.dom;F.Calendar=C.createFactory(B,I);function B(J){this.id=J;if(G){return}this._isHidden=true;this.initEvents()}var E=document.createElement("input");E.setAttribute("type","date");var G=F.Calendar.IS_NATIVE=/date/i.test(E.type),A=[31,28,31,30,31,30,31,31,30,31,30,31];E=null;function H(N){var K=document.getElementById(N.id),M=/(?:^|\s+)(\d{4})-(\d\d)-(\d\d)(?:$|\s+)/,L=M.exec(K.value),J;if(L){J=new Date(0);J.setFullYear(L[1],L[2]-1,L[3])}return J}function I(){var i=D.Event,M=C.EventPublisher,AA=M.add,v=M.remove,U=document.body,T=null,d=typeof U.textContent==="string"?"textContent":"innerText",t=typeof U.focus!=="undefined",s="ape-calendar-focused-el",J="ape-calendar-selected-day",Q=/-((?:next|prev)-(?:month|year))$/,c=/-next-|-prev-|-day\d/,V=D.key,u=Function.prototype;U=null;function g(AE,AJ){var AD=F.CalendarLocale;if(!AD){throw Error("Missing Resource: APE.widget.CalendarLocale")}h(AE);var AG=document,AH=AE.displayDate.getFullYear(),AF=AE.displayDate.getMonth(),AL=AD.months.abbr[AF],AI=f(AE.displayDate),AM=AG.getElementById(AE.calendarId),AK=AM.getElementsByTagName("tbody")[0].getElementsByTagName("b"),AC=AG.getElementById(AE.calendarId+"-header");AC.firstChild.data=AH+", "+AL;o(AE,AH,AF,AI,AK);y(AE,AI,AK);if(AJ){O(AE,AI+AE.displayDate.getDate(),AK)}}function f(AC){AC=new Date(AC);AC.setDate(1);return AC.getDay()}function o(AF,AK,AJ,AL,AM){var AG=0,AE=0,AH=A[AJ],AD,AI=AF.id+"-day",AC=(0==(AK%4))&&((0!=(AK%100))||(0==(AK%400)));if(AJ===1&&AC){AH+=1}while(AG<AL){AD=AM[AG++];AD[d]=" ";AD.className=AF.hiddenDayClass;AD.id=""}while(AE++<AH){AD=AM[AG++];AD.id=AI+(AE-1);AD[d]=AE+"";AD.tabIndex=-1;AD.className=""}for(AG=AL+AH,AE=AM.length;AG<AE;AG++){AD=AM[AG];AD[d]=" ";AD.className=AF.hiddenDayClass}}function y(AF,AC,AE){if(N(AF)){var AD=AC+new Date().getDate()-1;D.addClass(AE[AD],AF.calendarClass+"-today")}}function O(AF,AE,AD){if(N(AF)&&!AF.selectedId){var AC=AD[AE-1];D.addClass(AC,J);AF.selectedId=AC.id}}function N(AD){var AC=H(AD)||new Date;return AC!=null&&AD.displayDate.getYear()==AC.getYear()&&AD.displayDate.getMonth()==AC.getMonth()}function h(AF){if(!AF.calendarId){AF.calendarId=AF.id+"-calendar"}var AI=document;if(AI.getElementById(AF.calendarId)!==null){return}var AL=AI.createElement("div"),AK,AJ=AI.getElementById(AF.id),AD=AJ.parentNode,AG=k(),AC=F.CalendarLocale,AE=AC.days.abbr,AH="<thead><tr class='calendar-button-row'><th id='"+AF.id+"-prev-year' tabindex='0' title='"+AC.previousYear+"'>&#x00ab;</th><th id='"+AF.id+"-prev-month' tabindex='0' title='"+AC.previousMonth+"'>&#x2039;</th><th colspan='3' class='ape-calendar-header'><div id='"+AF.calendarId+"-header'>-</div></th><th id='"+AF.id+"-next-month' tabindex='0' title='"+AC.nextMonth+"' class='"+AF.calendarClass+"-days'>&#x203A;</th><th id='"+AF.id+"-next-year' tabindex='0' title='"+AC.nextYear+"'>&#x00bb;</th></tr><tr><th>"+AE.join("</th><th>")+"</th></tr></thead>";AL.onselectstart=z;AL.innerHTML="<table>"+AH+AG+"</table>";AL.id=AF.calendarId;AL.className=AF.calendarClass;AL.tabIndex=0;AL.onmousedown=r;AL.onkeydown=S;AK=AL.firstChild;if("onfocusin" in AK){AK.onfocusin=W;AK.onfocusout=w}AD.insertBefore(AL,AJ.nextSibling)}function k(){var AF=[],AE=6,AC=[],AD;AF.length=8;AC.length=AE;AF=AF.join("<td><b>&nbsp;</b></td>");for(AD=0;AD<AE;AD++){AC[AD]="<tr id='w"+AD+1+"'>"+AF+"</tr>\n"}return"<tbody>"+AC.join("")+"</tbody>"}function W(AC){var AD=i.getTarget(AC);if(c.test(AD.id)){D.addClass(AD,s)}}function w(AC){var AD=i.getTarget(AC);D.removeClass(AD,s)}function m(AD){AD=AD||window.event;var AE=F.Calendar.getById(this.id),AC=document.getElementById(AE.id),AF=AD.relatedTarget||AD.fromElement;if(AE._isHidden&&(!AF||(AF!==AC&&!D.contains(AC,AF)))){K(AE,AD)}}function S(AD){AD=AD||window.event;var AG=AD.keyCode,AC=this.id.replace(/-calendar$/,""),AF=F.Calendar.getById(AC),AE;if(AG===V.ESC){if(!AF._isHidden){document.getElementById(AC).focus();b(AF)}}else{if(AG===V.ENTER){AE=i.getTarget(AD);L(this,AE)}else{if(AG===V.TAB){n(AF,AD)}else{if(V.ARROW_KEY_EXP.test(AG)){Y(AF,AD,AG)}}}}}function n(AH,AE){if(!t){return}var AG=i.getTarget(AE),AC=AE.shiftKey,AD=AH.id+"-prev-year",AI=AG.id===AD,AF=AG.id===AH.id+"-next-year";if(AC&&AI||!AC&&AF){i.preventDefault(AE)}else{if(AG.tabIndex===-1&&t){i.preventDefault(AE);document.getElementById(AD).focus()}}}function Y(AI,AE,AH){var AG=i.getTarget(AE),AF=AG.id.match(/-day(\d+)$/),AD,AC;if(AF){if(AH===V.LEFT){AD=-1}else{if(AH===V.RIGHT){AD=1}else{if(AH===V.UP){AD=-7}else{if(AH===V.DOWN){AD=7}}}}if(AD){AD=+AF[1]+AD}}else{AD=0}AC=document.getElementById(AI.id+"-day"+AD);if(AC){Z(AC)}}function Z(AC){if(t){AC.tabIndex=0;AC.focus();AC.tabIndex=-1}}function K(AD){if(G){AD.onshow();return}AA(document,"onmousedown",a);AA(document,"onmouseup",x);if(!AD._isHidden){return}if(T){b(T)}h(AD);AD._isHidden=false;var AC=document.getElementById(AD.calendarId),AE=AC.style;j(AD.id,AE);AD.onshow();AD.show(AE);T=AD;AD.setDate(H(AD));P(AD,AC);AC.parentNode.style.zIndex="100"}function P(AD,AC){if(t){if(AD.selectedId){setTimeout(function(){var AF=document.getElementById(AD.selectedId);try{AF.focus()}catch(AE){}finally{AD=AC=AF=null}},120)}else{AC.focus()}}}function j(AD,AE){var AC=document.getElementById(AD);AE.left=AC.offsetLeft+"px";AE.top=AC.offsetTop+AC.offsetHeight+"px"}function b(AD){if(AD._isHidden){return}AD.onhide();if(G){return}var AC=document.getElementById(AD.calendarId);if(AC!==null){AD.hide(AC.style);AC.parentNode.style.zIndex=""}AD._isHidden=true}var R;function r(AD){AD=AD||window.event;if(AD.button>1){return}var AE=i.getTarget(AD),AC=AE.id;if(c.test(AC)){L(this,AE);if(Q.test(AC)){R=e(this,AC);if(R){R.startAfter(400)}}}}function e(AG,AC){var AE,AD=C.anim,AF=F.Calendar.getById(AG.id.replace(/-calendar$/,""));if(AD){if(!R){R=new AD.Animation(90)}R.run=function AE(){q(AF,AC)};AE=null}return R}function L(AG,AF){var AD,AE=AF.id,AC;AD=F.Calendar.getById(AG.id.replace(/-calendar$/,""));if(/-day\d/.test(AE)){if(AD.hideOnSelect||AE!==AD.selectedId){AC=+AF.firstChild.data;if(AC){X(AD,AC,AF,AE)}}}else{if(Q.test(AE)){q(AD,AE)}}}function X(AE,AC,AI,AD,AH){var AG=document.getElementById(AE.selectedId),AF=J;if(AG){D.removeClass(AG,AF)}D.addClass(AI,AF);AE.selectedId=AI.id;AB(AE,AC);AE.onselect();if(AE.hideOnSelect){document.getElementById(AE.id).focus();setTimeout(function(){b(AE,AH);AE=AI=AG=null},150)}}function q(AD,AF){var AC=new Date(AD.displayDate),AE=Q.exec(AF)[1];if(AE==="next-year"){AC.setFullYear(AC.getFullYear()+1)}else{if(AE==="prev-year"){AC.setFullYear(AC.getFullYear()-1)}else{if(AE==="next-month"){AC.setMonth(AC.getMonth()+1)}else{if(AE==="prev-month"){AC.setMonth(AC.getMonth()-1)}}}}AD.setDate(AC)}function AB(AF,AC){var AD=AF.displayDate||new Date,AE;AD.setDate(AC);AE=l(AD);document.getElementById(AF.id).value=AE}function z(){return false}function l(AD){var AF=("000"+AD.getFullYear()).slice(-4),AE=("0"+(AD.getMonth()+1)).slice(-2),AC=("0"+(AD.getDate())).slice(-2);return AF+"-"+AE+"-"+AC}function p(AC){AC=AC||window.event;var AE=AC.keyCode,AD;if(AE===V.ESC||AE===V.ENTER){i.preventDefault(AC);AD=F.Calendar.getById(this.id);if(AE===27){b(AD)}else{if(AE===V.ENTER){if(AD._isHidden){K(AD)}else{b(AD)}}}}}function a(AD){if(!T){return}var AE=D.Event.getTarget(AD),AF=document,AC=AF.getElementById(T.calendarId);if(AE&&AE.id!==T.id&&!AC||!D.contains(AC,AE,true)){b(T);T=null;v(AF,"onmousedown",a);v(AF,"onmouseup",x)}}function x(AC){R&&R.stop()}return{hideOnSelect:true,initEvents:function(){if(G){return}var AD=document,AC=AD.getElementById(this.id);AA(AC,"onfocus",m);AA(AC,"onkeydown",p);AA(AC,"onclick",m)},purgeEvents:function(){var AD=document,AC=AD.getElementById(this.id);if(AC){v(AC,"onfocus",m);v(AC,"onkeydown",p);v(AC,"onclick",m)}v(AD,"onmousedown",a);v(AD,"onmouseup",x)},calendarId:"",hiddenDayClass:"ape-calendar-empty-day",calendarClass:"ape-calendar",show:function(AC){AC.visibility="visible"},hide:function(AC){AC.visibility="hidden"},isShown:function(AC){return AC.visibility==="visible"},onshow:u,onhide:u,onselect:u,getDate:function(){return this.displayDate||H(this)},setDate:function(AD){if(G){document.getElementById(this.id).value=l(AD);return}var AC=AD!=null,AE=1000*60*60*24;AD=AC?new Date(AD):new Date;if(!this.displayDate||!this.selectedId||Math.abs(this.displayDate-AD.getTime())>AE){this.displayDate=AD;g(this,AC)}}}}})();