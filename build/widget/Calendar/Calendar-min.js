APE.namespace("APE.widget").defineCustomFactory("Calendar",function(F){var A=document.createElement("input"),D=window.APE,E=D.dom,B=E.Event;D.widget.DelegateFactory.create(F,B,"focus");A.setAttribute("type","date");A.value="24.12.2010";F.IS_NATIVE=A.value=="";A=null;return C;function C(U){function X(AP,AO){this.id=AP;if(h){return}AO&&D.createMixin(this,AO);if(this.useAnim){this.hide=i}this._isHidden=true;this.initEvents()}function y(AP){var AO=document.getElementById(AP.id);return Q(AO.value)}function Q(AQ){var AP=/^\s*(\d{4})-(\d\d)-(\d\d)\s*$/,AO=null,AS,AR=AP.exec(AQ);if(AR){AO=new Date(0);AS=+AR[2];AO.setFullYear(AR[1],AS-1,AR[3]);if(AS===AO.getMonth()+1){AO.setHours(0,0,0,0)}else{AO=null}}return AO}var AF=Function.prototype,K=D.EventPublisher,AM=K.add,AG=K.remove,Y=document.body,V=null,AE=typeof Y.focus!=="undefined",AD="ape-calendar-focused-el",H="ape-calendar-selected-day",P=/-((?:next|prev)-(?:month|year))$/,l=/-next-|-prev-|-day\d/,v=/-day(\d+)$/,a=E.key,h=U.IS_NATIVE,N=[31,28,31,30,31,30,31,31,30,31,30,31],m=D.anim,J=m.StyleTransition,f=0.1,AK={},W=/-calendar$/,Z={opacity:0.98,width:"14.4em",height:"14.4em",visibility:"visible"};function p(AQ,AV){var AP=D.widget.CalendarLocale,AZ=AQ.displayDate;if(!AP){throw Error("Missing Resource: APE.widget.CalendarLocale")}q(AQ);var AS=document,AT=AZ.getFullYear(),AR=AZ.getMonth(),AX=AP.months.abbr[AR],AU=o(AZ),AY=AS.getElementById(AQ.calendarId),AW=AY.getElementsByTagName("tbody")[0].getElementsByTagName("b"),AO=AS.getElementById(AQ.calendarId+"-header");AO.firstChild.data=AT+", "+AX;z(AQ,AT,AR,AU,AW);AJ(AQ,AU,AW);if(AV){M(AQ,AU+AZ.getDate(),AW)}}function o(AO){AO=new Date(AO);AO.setDate(1);return AO.getDay()}function z(AR,AW,AV,AX,AY){var AS=0,AQ=0,AT=N[AV],AP,AU=AR.id+"-day",AO=(0==(AW%4))&&((0!=(AW%100))||(0==(AW%400)));if(AV===1&&AO){AT+=1}while(AS<AX){AP=AY[AS++];AP[E.TEXT_CONTENT]=" ";AP.className=AR.hiddenDayClass;AP.id=""}while(AQ++<AT){AP=AY[AS++];AP.id=AU+(AQ-1);AP[E.TEXT_CONTENT]=AQ+"";AP.tabIndex=-1;AP.className=""}for(AS=AX+AT,AQ=AY.length;AS<AQ;AS++){AP=AY[AS];AP[E.TEXT_CONTENT]=" ";AP.className=AR.hiddenDayClass}}function AJ(AR,AO,AQ){if(L(AR)){var AP=AO+new Date().getDate()-1;E.addClass(AQ[AP],AR.calendarClass+"-today")}}function M(AR,AQ,AP){if(L(AR)&&!AR.selectedId){var AO=AP[AQ-1];E.addClass(AO,H);AR.selectedId=AO.id}}function L(AP){var AO=y(AP)||new Date;return AO!=null&&AP.displayDate.getYear()==AO.getYear()&&AP.displayDate.getMonth()==AO.getMonth()}function q(AR){if(!AR.calendarId){AR.calendarId=AR.id+"-calendar"}var AU=document;if(AU.getElementById(AR.calendarId)!==null){return}var AX=AU.createElement("div"),AW,AV=AU.getElementById(AR.id),AP=AV.parentNode,AS=s(),AO=D.widget.CalendarLocale,AQ=AO.days.abbr,AT="<thead><tr class='calendar-button-row'><th id='"+AR.id+"-prev-year' tabindex='0' title='"+AO.previousYear+"'>&#x00ab;</th><th id='"+AR.id+"-prev-month' tabindex='0' title='"+AO.previousMonth+"'>&#x2039;</th><th colspan='3' class='ape-calendar-header'><div id='"+AR.calendarId+"-header'>-</div></th><th id='"+AR.id+"-next-month' tabindex='0' title='"+AO.nextMonth+"' class='"+AR.calendarClass+"-days'>&#x203A;</th><th id='"+AR.id+"-next-year' tabindex='0' title='"+AO.nextYear+"'>&#x00bb;</th></tr><tr><th>"+AQ.join("</th><th>")+"</th></tr></thead>";AX.onselectstart=AL;AX.innerHTML="<table>"+AT+AS+"</table>";AX.id=AR.calendarId;AX.className=AR.calendarClass;if(AR.useAnim){E.addClass(AX,"ape-calendar-anim-start")}AX.tabIndex=0;AX.onmousedown=AC;AX.onkeydown=T;AW=AX.firstChild;if("onfocusin" in AW){AW.onfocusin=c;AW.onfocusout=AH}AP.insertBefore(AX,AV.nextSibling)}function s(){var AR=[],AQ=6,AO=[],AP;AR.length=8;AO.length=AQ;AR=AR.join("<td><b>&nbsp;</b></td>");for(AP=0;AP<AQ;AP++){AO[AP]="<tr id='w"+AP+1+"'>"+AR+"</tr>\n"}return"<tbody>"+AO.join("")+"</tbody>"}function c(AO){var AP=B.getTarget(AO);if(l.test(AP.id)&&AP!==null){E.addClass(AP,AD)}}function AH(AO){var AP=B.getTarget(AO);if(AP!==null){E.removeClass(AP,AD)}}function u(AP){AP=AP||window.event;var AQ=U.getById(this.id),AO=document.getElementById(AQ.id),AR=AP.relatedTarget||AP.fromElement;if(AQ._isHidden&&(!AR||(AR!==AO&&!E.contains(AO,AR)))){G(AQ,AP)}}function T(AP){AP=AP||window.event;var AS=AP.keyCode,AO=this.id.replace(/-calendar$/,""),AR=U.getById(AO),AQ;if(AS===a.ESC){if(!AR._isHidden){document.getElementById(AO).focus();setTimeout(function(){k(AR)},1)}}else{if(AS===a.ENTER){AQ=B.getTarget(AP);I(this,AQ)}else{if(AS===a.TAB){x(AR,AP)}else{if(a.ARROW_KEY_EXP.test(AS)){e(AR,AP,AS)}}}}}function x(AT,AQ){if(!AE){return}var AS=B.getTarget(AQ),AO=AQ.shiftKey,AP=AT.id+"-prev-year",AU=AS.id===AP,AR=AS.id===AT.id+"-next-year";if(AO&&AU||!AO&&AR){B.preventDefault(AQ)}else{if(AS.tabIndex===-1&&AE){B.preventDefault(AQ);document.getElementById(AP).focus()}}}function e(AU,AQ,AT){var AS=B.getTarget(AQ),AR=AS.id.match(v),AP,AO;if(AR){if(AT===a.LEFT){AP=-1}else{if(AT===a.RIGHT){AP=1}else{if(AT===a.UP){AP=-7}else{if(AT===a.DOWN){AP=7}}}}if(AP){AP=+AR[1]+AP}}else{AP=0}AO=document.getElementById(AU.id+"-day"+AP);if(AO){g(AO)}}function g(AO){if(AE){AO.tabIndex=0;AO.focus();AO.tabIndex=-1}}function G(AP){if(h){AP.onshow();return}AM(document,"onmousedown",j);AM(document,"onmouseup",AI);if(!AP._isHidden){return}if(V){k(V)}q(AP);AP._isHidden=false;var AO=document.getElementById(AP.calendarId),AQ=AO.style;r(AP.id,AQ);if(AP.useAnim){b(AP)}AP.onshow(AP);AP.show(AQ);V=AP;AP.setDate(y(AP));O(AP,AO);AO.parentNode.style.zIndex="100"}function w(AP){var AO=document.getElementById(AP);if(AO.type!="text"){AO.type="text"}}function O(AP,AO){if(AE){if(AP.selectedId){setTimeout(function(){var AR=document.getElementById(AP.selectedId);try{AR.focus()}catch(AQ){}finally{AP=AO=AR=null}},120)}else{AO.focus()}}}function r(AQ,AS){var AP=document.getElementById(AQ),AO=AP.parentNode,AR=E.getOffsetCoords(AP,AO);AS.left=AR.x+"px";AS.top=AR.y+AP.offsetHeight+"px"}function k(AP){if(AP._isHidden){return}AP.onhide();if(h){return}var AO=document.getElementById(AP.calendarId);if(AO!==null){AP.hide(AO.style);AO.parentNode.style.zIndex=""}AP._isHidden=true}var R;function AC(AP){AP=AP||window.event;if(AP.button>1){return}var AQ=B.getTarget(AP),AO=AQ.id;if(l.test(AO)){I(this,AQ);if(P.test(AO)){R=n(this,AO);if(R){R.startAfter(400)}}}w(this.id.replace(W,""))}function n(AR,AO){var AP,AQ=U.getById(AR.id.replace(W,""));if(m){if(!R){R=new m.Animation(3000)}R.run=function AP(){AB(AQ,AO)};AP=AR=null}return R}function I(AS,AR){var AP,AQ=AR.id,AO;AP=U.getById(AS.id.replace(/-calendar$/,""));if(v.test(AQ)){if(AP.hideOnSelect||AQ!==AP.selectedId){AO=+AR.firstChild.data;if(AO){d(AP,AO,AR,AQ)}}}else{if(P.test(AQ)){AB(AP,AQ)}}}function d(AQ,AO,AU,AP,AT){var AS=document.getElementById(AQ.selectedId),AR=H;if(AS){E.removeClass(AS,AR)}E.addClass(AU,AR);AQ.selectedId=AU.id;AN(AQ,AO);AQ.onselect();if(AQ.hideOnSelect){document.getElementById(AQ.id).focus();setTimeout(function(){k(AQ,AT);AQ=AU=AS=null},150)}}function AB(AP,AR){var AO=new Date(AP.displayDate),AQ=P.exec(AR)[1];if(AQ==="next-year"){AO.setFullYear(AO.getFullYear()+1)}else{if(AQ==="prev-year"){AO.setFullYear(AO.getFullYear()-1)}else{if(AQ==="next-month"){AO.setMonth(AO.getMonth()+1)}else{if(AQ==="prev-month"){AO.setMonth(AO.getMonth()-1)}}}}AP.setDate(AO)}function AN(AR,AO){var AP=AR.displayDate||new Date,AQ;AP.setDate(AO);AQ=t(AP);document.getElementById(AR.id).value=AQ}function AL(){return false}function t(AP){var AR=("000"+AP.getFullYear()).slice(-4),AQ=("0"+(AP.getMonth()+1)).slice(-2),AO=("0"+(AP.getDate())).slice(-2);return AR+"-"+AQ+"-"+AO}function AA(AO){AO=AO||window.event;var AQ=AO.keyCode,AP;if(AQ===a.ESC||AQ===a.ENTER){B.preventDefault(AO);AP=U.getById(this.id);if(AQ===27){k(AP)}else{if(AQ===a.ENTER){if(AP._isHidden){G(AP)}else{k(AP)}}}}}function j(AP){if(!V){return}var AQ=E.Event.getTarget(AP),AR=document,AO=AR.getElementById(V.calendarId);if(AQ&&AQ.id!==V.id&&!AO||!E.isOrContains(AO,AQ)){k(V);V=null;AG(AR,"onmousedown",j);AG(AR,"onmouseup",AI)}}function AI(AO){R&&R.stop()}function S(AP){var AO=AK[AP];if(!AO){AO=AK[AP]=new J(AP,Z,f,m.Transitions.getSigmoid(3))}return AO}function b(AO){if(AO.useAnim){S(AO.calendarId).seekTo(1)}}function i(){if(this.useAnim){S(this.calendarId).seekTo(0)}}X.prototype={hideOnSelect:true,useAnim:true,initEvents:function(){if(h){return}var AP=document,AO=AP.getElementById(this.id);AM(AO,"onfocus",u);AM(AO,"onkeydown",AA);AM(AO,"onclick",u)},purgeEvents:function(){var AP=document,AO=AP.getElementById(this.id);if(AO){AG(AO,"onfocus",u);AG(AO,"onkeydown",AA);AG(AO,"onclick",u)}AG(AP,"onmousedown",j);AG(AP,"onmouseup",AI)},calendarId:"",hiddenDayClass:"ape-calendar-empty-day",calendarClass:"ape-calendar",show:function(AO){AO.visibility="visible"},hide:function(AO){AO.visibility="hidden"},isShown:function(AO){return AO.visibility==="visible"},onshow:AF,onhide:AF,onselect:AF,getDate:function(){return this.displayDate||y(this)},setDate:function(AP){if(h){document.getElementById(this.id).value=t(AP);return}var AO=AP!=null,AQ=1000*60*60*24;AP=AO?new Date(AP):new Date;if(!this.displayDate||!this.selectedId||Math.abs(this.displayDate-AP.getTime())>AQ){this.displayDate=AP;p(this,AO)}}};return X}});