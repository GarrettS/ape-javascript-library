APE.namespace("APE.widget").defineCustomFactory("Calendar",function(F){var A=document.createElement("input"),D=window.APE,E=D.dom,B=E.Event;D.widget.DelegateFactory.create(F,B,"focus");A.setAttribute("type","date");F.IS_NATIVE=/date/i.test(A.type);A=null;return C;function C(U){function W(AN,AM){this.id=AN;if(g){return}AM&&D.createMixin(this,AM);if(this.useAnim){this.hide=h}this._isHidden=true;this.initEvents()}function w(AN){var AM=document.getElementById(AN.id);return Q(AM.value)}function Q(AO){var AN=/^\s*(\d{4})-(\d\d)-(\d\d)\s*$/,AM=null,AQ,AP=AN.exec(AO);if(AP){AM=new Date(0);AQ=+AP[2];AM.setFullYear(AP[1],AQ-1,AP[3]);if(AQ===AM.getMonth()+1){AM.setHours(0,0,0,0)}else{AM=null}}return AM}var AD=Function.prototype,K=D.EventPublisher,AK=K.add,AE=K.remove,X=document.body,V=null,AC=typeof X.focus!=="undefined",AB="ape-calendar-focused-el",H="ape-calendar-selected-day",P=/-((?:next|prev)-(?:month|year))$/,k=/-next-|-prev-|-day\d/,u=/-day(\d+)$/,Z=E.key,g=U.IS_NATIVE,N=[31,28,31,30,31,30,31,31,30,31,30,31],l=D.anim,J=l.StyleTransition,e=0.1,AI={},Y={opacity:0.98,width:"14.4em",height:"14.4em",visibility:"visible"};function o(AO,AT){var AN=D.widget.CalendarLocale,AX=AO.displayDate;if(!AN){throw Error("Missing Resource: APE.widget.CalendarLocale")}p(AO);var AQ=document,AR=AX.getFullYear(),AP=AX.getMonth(),AV=AN.months.abbr[AP],AS=n(AX),AW=AQ.getElementById(AO.calendarId),AU=AW.getElementsByTagName("tbody")[0].getElementsByTagName("b"),AM=AQ.getElementById(AO.calendarId+"-header");AM.firstChild.data=AR+", "+AV;x(AO,AR,AP,AS,AU);AH(AO,AS,AU);if(AT){M(AO,AS+AX.getDate(),AU)}}function n(AM){AM=new Date(AM);AM.setDate(1);return AM.getDay()}function x(AP,AU,AT,AV,AW){var AQ=0,AO=0,AR=N[AT],AN,AS=AP.id+"-day",AM=(0==(AU%4))&&((0!=(AU%100))||(0==(AU%400)));if(AT===1&&AM){AR+=1}while(AQ<AV){AN=AW[AQ++];AN[E.TEXT_CONTENT]=" ";AN.className=AP.hiddenDayClass;AN.id=""}while(AO++<AR){AN=AW[AQ++];AN.id=AS+(AO-1);AN[E.TEXT_CONTENT]=AO+"";AN.tabIndex=-1;AN.className=""}for(AQ=AV+AR,AO=AW.length;AQ<AO;AQ++){AN=AW[AQ];AN[E.TEXT_CONTENT]=" ";AN.className=AP.hiddenDayClass}}function AH(AP,AM,AO){if(L(AP)){var AN=AM+new Date().getDate()-1;E.addClass(AO[AN],AP.calendarClass+"-today")}}function M(AP,AO,AN){if(L(AP)&&!AP.selectedId){var AM=AN[AO-1];E.addClass(AM,H);AP.selectedId=AM.id}}function L(AN){var AM=w(AN)||new Date;return AM!=null&&AN.displayDate.getYear()==AM.getYear()&&AN.displayDate.getMonth()==AM.getMonth()}function p(AP){if(!AP.calendarId){AP.calendarId=AP.id+"-calendar"}var AS=document;if(AS.getElementById(AP.calendarId)!==null){return}var AV=AS.createElement("div"),AU,AT=AS.getElementById(AP.id),AN=AT.parentNode,AQ=r(),AM=D.widget.CalendarLocale,AO=AM.days.abbr,AR="<thead><tr class='calendar-button-row'><th id='"+AP.id+"-prev-year' tabindex='0' title='"+AM.previousYear+"'>&#x00ab;</th><th id='"+AP.id+"-prev-month' tabindex='0' title='"+AM.previousMonth+"'>&#x2039;</th><th colspan='3' class='ape-calendar-header'><div id='"+AP.calendarId+"-header'>-</div></th><th id='"+AP.id+"-next-month' tabindex='0' title='"+AM.nextMonth+"' class='"+AP.calendarClass+"-days'>&#x203A;</th><th id='"+AP.id+"-next-year' tabindex='0' title='"+AM.nextYear+"'>&#x00bb;</th></tr><tr><th>"+AO.join("</th><th>")+"</th></tr></thead>";AV.onselectstart=AJ;AV.innerHTML="<table>"+AR+AQ+"</table>";AV.id=AP.calendarId;AV.className=AP.calendarClass;if(AP.useAnim){E.addClass(AV,"ape-calendar-anim-start")}AV.tabIndex=0;AV.onmousedown=AA;AV.onkeydown=T;AU=AV.firstChild;if("onfocusin" in AU){AU.onfocusin=b;AU.onfocusout=AF}AN.insertBefore(AV,AT.nextSibling)}function r(){var AP=[],AO=6,AM=[],AN;AP.length=8;AM.length=AO;AP=AP.join("<td><b>&nbsp;</b></td>");for(AN=0;AN<AO;AN++){AM[AN]="<tr id='w"+AN+1+"'>"+AP+"</tr>\n"}return"<tbody>"+AM.join("")+"</tbody>"}function b(AM){var AN=B.getTarget(AM);if(k.test(AN.id)&&AN!==null){E.addClass(AN,AB)}}function AF(AM){var AN=B.getTarget(AM);if(AN!==null){E.removeClass(AN,AB)}}function t(AN){AN=AN||window.event;var AO=U.getById(this.id),AM=document.getElementById(AO.id),AP=AN.relatedTarget||AN.fromElement;if(AO._isHidden&&(!AP||(AP!==AM&&!E.contains(AM,AP)))){G(AO,AN)}}function T(AN){AN=AN||window.event;var AQ=AN.keyCode,AM=this.id.replace(/-calendar$/,""),AP=U.getById(AM),AO;if(AQ===Z.ESC){if(!AP._isHidden){document.getElementById(AM).focus();j(AP)}}else{if(AQ===Z.ENTER){AO=B.getTarget(AN);I(this,AO)}else{if(AQ===Z.TAB){v(AP,AN)}else{if(Z.ARROW_KEY_EXP.test(AQ)){d(AP,AN,AQ)}}}}}function v(AR,AO){if(!AC){return}var AQ=B.getTarget(AO),AM=AO.shiftKey,AN=AR.id+"-prev-year",AS=AQ.id===AN,AP=AQ.id===AR.id+"-next-year";if(AM&&AS||!AM&&AP){B.preventDefault(AO)}else{if(AQ.tabIndex===-1&&AC){B.preventDefault(AO);document.getElementById(AN).focus()}}}function d(AS,AO,AR){var AQ=B.getTarget(AO),AP=AQ.id.match(u),AN,AM;if(AP){if(AR===Z.LEFT){AN=-1}else{if(AR===Z.RIGHT){AN=1}else{if(AR===Z.UP){AN=-7}else{if(AR===Z.DOWN){AN=7}}}}if(AN){AN=+AP[1]+AN}}else{AN=0}AM=document.getElementById(AS.id+"-day"+AN);if(AM){f(AM)}}function f(AM){if(AC){AM.tabIndex=0;AM.focus();AM.tabIndex=-1}}function G(AN){if(g){AN.onshow();return}AK(document,"onmousedown",i);AK(document,"onmouseup",AG);if(!AN._isHidden){return}if(V){j(V)}p(AN);AN._isHidden=false;var AM=document.getElementById(AN.calendarId),AO=AM.style;q(AN.id,AO);if(AN.useAnim){a(AN)}AN.onshow(AN);AN.show(AO);V=AN;AN.setDate(w(AN));O(AN,AM);AM.parentNode.style.zIndex="100"}function O(AN,AM){if(AC){if(AN.selectedId){setTimeout(function(){var AP=document.getElementById(AN.selectedId);try{AP.focus()}catch(AO){}finally{AN=AM=AP=null}},120)}else{AM.focus()}}}function q(AO,AQ){var AN=document.getElementById(AO),AM=AN.parentNode,AP=E.getOffsetCoords(AN,AM);AQ.left=AP.x+"px";AQ.top=AP.y+AN.offsetHeight+"px"}function j(AN){if(AN._isHidden){return}AN.onhide();if(g){return}var AM=document.getElementById(AN.calendarId);if(AM!==null){AN.hide(AM.style);AM.parentNode.style.zIndex=""}AN._isHidden=true}var R;function AA(AN){AN=AN||window.event;if(AN.button>1){return}var AO=B.getTarget(AN),AM=AO.id;if(k.test(AM)){I(this,AO);if(P.test(AM)){R=m(this,AM);if(R){R.startAfter(400)}}}}function m(AP,AM){var AN,AO=U.getById(AP.id.replace(/-calendar$/,""));if(l){if(!R){R=new l.Animation(3000)}R.run=function AN(){z(AO,AM)};AN=AP=null}return R}function I(AQ,AP){var AN,AO=AP.id,AM;AN=U.getById(AQ.id.replace(/-calendar$/,""));if(u.test(AO)){if(AN.hideOnSelect||AO!==AN.selectedId){AM=+AP.firstChild.data;if(AM){c(AN,AM,AP,AO)}}}else{if(P.test(AO)){z(AN,AO)}}}function c(AO,AM,AS,AN,AR){var AQ=document.getElementById(AO.selectedId),AP=H;if(AQ){E.removeClass(AQ,AP)}E.addClass(AS,AP);AO.selectedId=AS.id;AL(AO,AM);AO.onselect();if(AO.hideOnSelect){document.getElementById(AO.id).focus();setTimeout(function(){j(AO,AR);AO=AS=AQ=null},150)}}function z(AN,AP){var AM=new Date(AN.displayDate),AO=P.exec(AP)[1];if(AO==="next-year"){AM.setFullYear(AM.getFullYear()+1)}else{if(AO==="prev-year"){AM.setFullYear(AM.getFullYear()-1)}else{if(AO==="next-month"){AM.setMonth(AM.getMonth()+1)}else{if(AO==="prev-month"){AM.setMonth(AM.getMonth()-1)}}}}AN.setDate(AM)}function AL(AP,AM){var AN=AP.displayDate||new Date,AO;AN.setDate(AM);AO=s(AN);document.getElementById(AP.id).value=AO}function AJ(){return false}function s(AN){var AP=("000"+AN.getFullYear()).slice(-4),AO=("0"+(AN.getMonth()+1)).slice(-2),AM=("0"+(AN.getDate())).slice(-2);return AP+"-"+AO+"-"+AM}function y(AM){AM=AM||window.event;var AO=AM.keyCode,AN;if(AO===Z.ESC||AO===Z.ENTER){B.preventDefault(AM);AN=U.getById(this.id);if(AO===27){j(AN)}else{if(AO===Z.ENTER){if(AN._isHidden){G(AN)}else{j(AN)}}}}}function i(AN){if(!V){return}var AO=E.Event.getTarget(AN),AP=document,AM=AP.getElementById(V.calendarId);if(AO&&AO.id!==V.id&&!AM||!E.isOrContains(AM,AO)){j(V);V=null;AE(AP,"onmousedown",i);AE(AP,"onmouseup",AG)}}function AG(AM){R&&R.stop()}function S(AN){var AM=AI[AN];if(!AM){AM=AI[AN]=new J(AN,Y,e,l.Transitions.getSigmoid(3))}return AM}function a(AM){if(AM.useAnim){S(AM.calendarId).seekTo(1)}}function h(){if(this.useAnim){S(this.calendarId).seekTo(0)}}W.prototype={hideOnSelect:true,useAnim:true,initEvents:function(){if(g){return}var AN=document,AM=AN.getElementById(this.id);AK(AM,"onfocus",t);AK(AM,"onkeydown",y);AK(AM,"onclick",t)},purgeEvents:function(){var AN=document,AM=AN.getElementById(this.id);if(AM){AE(AM,"onfocus",t);AE(AM,"onkeydown",y);AE(AM,"onclick",t)}AE(AN,"onmousedown",i);AE(AN,"onmouseup",AG)},calendarId:"",hiddenDayClass:"ape-calendar-empty-day",calendarClass:"ape-calendar",show:function(AM){AM.visibility="visible"},hide:function(AM){AM.visibility="hidden"},isShown:function(AM){return AM.visibility==="visible"},onshow:AD,onhide:AD,onselect:AD,getDate:function(){return this.displayDate||w(this)},setDate:function(AN){if(g){document.getElementById(this.id).value=s(AN);return}var AM=AN!=null,AO=1000*60*60*24;AN=AM?new Date(AN):new Date;if(!this.displayDate||!this.selectedId||Math.abs(this.displayDate-AN.getTime())>AO){this.displayDate=AN;o(this,AM)}}};return W}});