APE.namespace("APE.widget");
(function(){function G(h){this.id=h;if(!o){this._isHidden=true;this.initEvents()}}function s(h){h=document.getElementById(h.id);var t=/(?:^|\s+)(\d{4})-(\d\d)-(\d\d)(?:$|\s+)/;h=t.exec(h.value);var q;if(h){q=new Date(0);q.setFullYear(h[1],h[2]-1,h[3])}return q}function H(){function h(a,b){var c=j.CalendarLocale;if(!c)throw Error("Missing Resource: APE.widget.CalendarLocale");A(a);var d=document,f=a.displayDate.getFullYear(),e=a.displayDate.getMonth();c=c.months.abbr[e];var i=t(a.displayDate),k=d.getElementById(a.calendarId);
k=k.getElementsByTagName("tbody")[0].getElementsByTagName("b");d=d.getElementById(a.calendarId+"-header");d.firstChild.data=f+", "+c;q(a,f,e,i,k);I(a,i,k);b&&J(a,i+a.displayDate.getDate(),k)}function t(a){a=new Date(a);a.setDate(1);return a.getDay()}function q(a,b,c,d,f){var e=0,i=0,k=K[c],L=a.id+"-day";b=0==b%4&&(0!=b%100||0==b%400);if(c===1&&b)k+=1;for(;e<d;){c=f[e++];c[u]=" ";c.className=a.hiddenDayClass;c.id=""}for(;i++<k;){c=f[e++];c.id=L+(i-1);c[u]=i+"";c.tabIndex=-1;c.className=""}e=d+k;for(i=
f.length;e<i;e++){c=f[e];c[u]=" ";c.className=a.hiddenDayClass}}function I(a,b,c){if(B(a)){b=b+(new Date).getDate()-1;l.addClass(c[b],a.calendarClass+"-today")}}function J(a,b,c){if(B(a)&&!a.selectedId){b=c[b-1];l.addClass(b,C);a.selectedId=b.id}}function B(a){var b=s(a)||new Date;return b!=null&&a.displayDate.getYear()==b.getYear()&&a.displayDate.getMonth()==b.getMonth()}function A(a){if(!a.calendarId)a.calendarId=a.id+"-calendar";var b=document;if(b.getElementById(a.calendarId)===null){var c=b.createElement("div");
b=b.getElementById(a.id);var d=b.parentNode,f=M(),e=j.CalendarLocale,i=e.days.abbr;e="<thead><tr class='calendar-button-row'><th id='"+a.id+"-prev-year' tabindex='0' title='"+e.previousYear+"'>&#x00ab;</th><th id='"+a.id+"-prev-month' tabindex='0' title='"+e.previousMonth+"'>&#x2039;</th><th colspan='3' class='ape-calendar-header'><div id='"+a.calendarId+"-header'>-</div></th><th id='"+a.id+"-next-month' tabindex='0' title='"+e.nextMonth+"' class='"+a.calendarClass+"-days'>&#x203A;</th><th id='"+
a.id+"-next-year' tabindex='0' title='"+e.nextYear+"'>&#x00bb;</th></tr><tr><th>"+i.join("</th><th>")+"</th></tr></thead>";c.onselectstart=N;c.innerHTML="<table>"+e+f+"</table>";c.id=a.calendarId;c.className=a.calendarClass;c.onmousedown=O;P||p.EventPublisher.add(document,"onmouseup",Q);c.onkeydown=R;a=c.firstChild;if("onfocusin"in a){a.onfocusin=S;a.onfocusout=T}g.addDelegatedFocus(d,containerFocused);d.insertBefore(c,b.nextSibling);g.addDelegatedBlur(b.parentNode,U)}}function U(a){a=g.getTarget(a);
var b=this.id.replace("-calendar",""),c=document.getElementById(this.id),d=document.getElementById(this.id);if(a!==c&&!l.contains(d,a)){a=j.Calendar.getById(b);m(a)}}function M(){var a=[],b=6,c=[],d;a.length=8;c.length=b;a=a.join("<td><b>&nbsp;</b></td>");for(d=0;d<b;d++)c[d]="<tr id='w"+d+1+"'>"+a+"</tr>\n";return"<tbody>"+c.join("")+"</tbody>"}function S(a){var b=g.getTarget(a);/-next-|-prev-|-day/.test(b.id)&&l.addClass(b,D);g.stopPropagation(a)}function T(a){a=g.getTarget(a);l.removeClass(a,D)}
function E(a){a=a||window.event;var b=j.Calendar.getById(this.id),c=document.getElementById(b.id),d=a.relatedTarget||a.fromElement;if(b._isHidden&&(!d||d!==c&&!l.contains(c,d)))v(b,a)}function V(a){a=a||window.event;var b=j.Calendar.getById(this.id);document.getElementById(b.id);var c=a.keyCode;if(c===27){g.preventDefault(a);m(b)}else if(c===13){g.preventDefault(a);b._isHidden?v(b):m(b)}}function R(a){a=a||window.event;var b=a.keyCode,c=this.id.replace(/-calendar$/,"");c=j.Calendar.getById(c);if(b===
27)m(c);else if(b===13){a=g.getTarget(a);w(this,a)}else if(b===9)W(c,a);else/37|38|39|40/.test(b)&&X(c,a,b)}function W(a,b){if(r){var c=g.getTarget(b),d=b.shiftKey,f=a.id+"-prev-year",e=c.id===f;a=c.id===a.id+"-next-year";if(d&&e||!d&&a)g.preventDefault(b);else if(c.tabIndex===-1&&r){g.preventDefault(b);document.getElementById(f).focus()}}}function X(a,b,c){b=g.getTarget(b);b=b.id.match(/-day(\d+)$/);var d;if(b){if(c===37)dayIndex=-1;else if(c===39)dayIndex=1;else if(c===38)dayIndex=-7;else if(c===
40)dayIndex=7;if(dayIndex)d=+b[1]+dayIndex}else d=0;(a=document.getElementById(a.id+"-day"+d))&&Y(a)}function Y(a){if(r){a.tabIndex=0;a.focus();a.tabIndex=-1}}function v(a,b){if(o)a.onshow(b);else{A(a);var c=document.getElementById(a.calendarId),d=c.style;a._isHidden=false;isShown(a.calendarEl.style)&&m(a,b);Z(a,d);a.onshow(b);a.show(d);a.setDate(s(a));if(r)a.selectedId?document.getElementById(a.selectedId).focus():c.focus()}}function Z(a,b){a=document.getElementById(a.id);b.left=a.offsetLeft+"px";
b.top=a.offsetTop+a.offsetHeight+"px"}function m(a,b){if(!a._isHidden){a.onhide(b);if(!o){b=document.getElementById(a.calendarId);a.hide(b.style);a._isHidden=true;document.getElementById(a.id).focus()}}}function O(a){a=a||window.event;if(!(a.button>1)){a=g.getTarget(a);var b=this;if(/-next-|-prev-/.test(a.id)){w(b,a);(n=$(b,a))&&n.startAfter(400)}}}function $(a,b){var c;c=p.anim;if(!n&&c)n=new c.Animation(10);n.run=function d(){w(a,b)};c=null;return n}function Q(){n&&n.stop()}function w(a,b){var c=
b.id,d;a=j.Calendar.getById(a.id.replace(/-calendar$/,""));if(/^b$/i.test(b.tagName)){if(a.hideOnSelect||c!==a.selectedId)(d=+b.firstChild.data)&&aa(a,d,b,c)}else/-next-|-prev-/.test(c)&&ba(a,c)}function aa(a,b,c,d,f){var e=document.getElementById(a.selectedId);d=C;e&&l.removeClass(e,d);l.addClass(c,d);a.selectedId=c.id;ca(a,b);a.onselect();if(a.hideOnSelect){document.getElementById(a.id).focus();setTimeout(function(){m(a,f);a=c=e=null},150)}}function ba(a,b){var c,d=new RegExp("^"+a.id+"-((?:next|prev)-(?:year|month))");
if(d.test(b)){c=new Date(a.displayDate);b=d.exec(b)[1];if(b==="next-year")c.setFullYear(c.getFullYear()+1);else if(b==="prev-year")c.setFullYear(c.getFullYear()-1);else if(b==="next-month")c.setMonth(c.getMonth()+1);else b==="prev-month"&&c.setMonth(c.getMonth()-1);a.setDate(c)}}function ca(a,b){var c=a.displayDate||new Date;c.setDate(b);b=F(c);document.getElementById(a.id).value=b}function N(){return false}function x(){}function F(a){var b=("000"+a.getFullYear()).slice(-4),c=("0"+(a.getMonth()+1)).slice(-2);
a=("0"+a.getDate()).slice(-2);return b+"-"+c+"-"+a}function da(a){a=a||window.event;var b=a.keyCode,c;if(b===27||b===13){c=j.Calendar.getById(this.id);if(b===27)m(c,a);else if(b===13)c._isHidden?v(c):m(c)}}var g=l.Event,y=document.body,u=typeof y.textContent==="string"?"textContent":"innerText",r=typeof y.focus!=="undefined",D="ape-calendar-focused-el",C="ape-calendar-selected-day",P;y=null;var n;return{hideOnSelect:true,initEvents:function(){if(!o){var a=document;a=a.getElementById(this.id);var b=
p.EventPublisher.add;b(a,"onfocus",E);b(a,"onkeydown",V);b(a,"onkeydown",da);o||b(a,"onclick",E)}},calendarId:"",hiddenDayClass:"ape-calendar-empty-day",calendarClass:"ape-calendar",show:function(a){a.visibility="visible"},hide:function(a){a.visibility="hidden"},isShown:function(a){return a.visibility==="visible"},onshow:x,onhide:x,onselect:x,getDate:function(){return this.displayDate||s(this)},setDate:function(a){if(o)document.getElementById(this.id).value=F(a);else{var b=a!=null,c=864E5;a=b?new Date(a):
new Date;if(!this.displayDate||!this.selectedId||Math.abs(this.displayDate-a.getTime())>c){this.displayDate=a;h(this,b)}}}}}var p=self.APE,j=p.widget,l=p.dom;j.Calendar=p.createFactory(G,H);var z=document.createElement("input");z.setAttribute("type","date");var o=j.Calendar.IS_NATIVE=/date/i.test(z.type),K=[31,28,31,30,31,30,31,31,30,31,30,31];z=null})();
