APE.namespace("APE.widget").createCustomFactory("Calendar",function(B){var F=document.createElement("input"),D=window.APE,E=D.dom,I=E.Event,J={};F.setAttribute("type","date");D.createMixin(B,{IS_NATIVE:/date/i.test(F.type),registerDelegateFor:H});return A;function H(M,K,L){J[M]=J[M]||I.addDelegatedFocus(document.documentElement,C(M,K,L))}function C(M,K,L){return function(N){G(N,M,K,L)}}function G(M,O,K,L){var N=I.getTarget(M);if(N.id===O&&(!L||L(N)!=false)){I.removeDelegatedFocus(document.documentElement,J[O]);delete J[O];B.getById(O,K)}}function A(Y){function a(AR,AQ){this.id=AR;if(k){return}AQ&&D.createMixin(this,AQ);if(this.useAnim){this.hide=l}this._isHidden=true;this.initEvents()}function AA(AR){var AQ=document.getElementById(AR.id);return U(AQ.value)}function U(AS){var AR=/^\s*(\d{4})-(\d\d)-(\d\d)\s*$/,AQ=null,AU,AT=AR.exec(AS);if(AT){AQ=new Date(0);AU=+AT[2];AQ.setFullYear(AT[1],AU-1,AT[3]);if(AU===AQ.getMonth()+1){AQ.setHours(0,0,0,0)}else{AQ=null}}return AQ}var AH=Function.prototype,O=D.EventPublisher,AO=O.add,AI=O.remove,b=document.body,Z=null,AG=typeof b.focus!=="undefined",AF="ape-calendar-focused-el",L="ape-calendar-selected-day",T=/-((?:next|prev)-(?:month|year))$/,o=/-next-|-prev-|-day\d/,y=/-day(\d+)$/,d=E.key,k=Y.IS_NATIVE,R=[31,28,31,30,31,30,31,31,30,31,30,31],p=D.anim,N=p.StyleTransition,i=0.1,AM={},c={opacity:0.98,width:"14.4em",height:"14.4em",visibility:"visible"};function s(AS,AX){var AR=D.widget.CalendarLocale,Ab=AS.displayDate;if(!AR){throw Error("Missing Resource: APE.widget.CalendarLocale")}t(AS);var AU=document,AV=Ab.getFullYear(),AT=Ab.getMonth(),AZ=AR.months.abbr[AT],AW=r(Ab),Aa=AU.getElementById(AS.calendarId),AY=Aa.getElementsByTagName("tbody")[0].getElementsByTagName("b"),AQ=AU.getElementById(AS.calendarId+"-header");AQ.firstChild.data=AV+", "+AZ;AB(AS,AV,AT,AW,AY);AL(AS,AW,AY);if(AX){Q(AS,AW+Ab.getDate(),AY)}}function r(AQ){AQ=new Date(AQ);AQ.setDate(1);return AQ.getDay()}function AB(AT,AY,AX,AZ,Aa){var AU=0,AS=0,AV=R[AX],AR,AW=AT.id+"-day",AQ=(0==(AY%4))&&((0!=(AY%100))||(0==(AY%400)));if(AX===1&&AQ){AV+=1}while(AU<AZ){AR=Aa[AU++];AR[E.TEXT_CONTENT]=" ";AR.className=AT.hiddenDayClass;AR.id=""}while(AS++<AV){AR=Aa[AU++];AR.id=AW+(AS-1);AR[E.TEXT_CONTENT]=AS+"";AR.tabIndex=-1;AR.className=""}for(AU=AZ+AV,AS=Aa.length;AU<AS;AU++){AR=Aa[AU];AR[E.TEXT_CONTENT]=" ";AR.className=AT.hiddenDayClass}}function AL(AT,AQ,AS){if(P(AT)){var AR=AQ+new Date().getDate()-1;E.addClass(AS[AR],AT.calendarClass+"-today")}}function Q(AT,AS,AR){if(P(AT)&&!AT.selectedId){var AQ=AR[AS-1];E.addClass(AQ,L);AT.selectedId=AQ.id}}function P(AR){var AQ=AA(AR)||new Date;return AQ!=null&&AR.displayDate.getYear()==AQ.getYear()&&AR.displayDate.getMonth()==AQ.getMonth()}function t(AT){if(!AT.calendarId){AT.calendarId=AT.id+"-calendar"}var AW=document;if(AW.getElementById(AT.calendarId)!==null){return}var AZ=AW.createElement("div"),AY,AX=AW.getElementById(AT.id),AR=AX.parentNode,AU=v(),AQ=D.widget.CalendarLocale,AS=AQ.days.abbr,AV="<thead><tr class='calendar-button-row'><th id='"+AT.id+"-prev-year' tabindex='0' title='"+AQ.previousYear+"'>&#x00ab;</th><th id='"+AT.id+"-prev-month' tabindex='0' title='"+AQ.previousMonth+"'>&#x2039;</th><th colspan='3' class='ape-calendar-header'><div id='"+AT.calendarId+"-header'>-</div></th><th id='"+AT.id+"-next-month' tabindex='0' title='"+AQ.nextMonth+"' class='"+AT.calendarClass+"-days'>&#x203A;</th><th id='"+AT.id+"-next-year' tabindex='0' title='"+AQ.nextYear+"'>&#x00bb;</th></tr><tr><th>"+AS.join("</th><th>")+"</th></tr></thead>";AZ.onselectstart=AN;AZ.innerHTML="<table>"+AV+AU+"</table>";AZ.id=AT.calendarId;AZ.className=AT.calendarClass;if(AT.useAnim){E.addClass(AZ,"ape-calendar-anim-start")}AZ.tabIndex=0;AZ.onmousedown=AE;AZ.onkeydown=X;AY=AZ.firstChild;if("onfocusin" in AY){AY.onfocusin=f;AY.onfocusout=AJ}AR.insertBefore(AZ,AX.nextSibling)}function v(){var AT=[],AS=6,AQ=[],AR;AT.length=8;AQ.length=AS;AT=AT.join("<td><b>&nbsp;</b></td>");for(AR=0;AR<AS;AR++){AQ[AR]="<tr id='w"+AR+1+"'>"+AT+"</tr>\n"}return"<tbody>"+AQ.join("")+"</tbody>"}function f(AQ){var AR=I.getTarget(AQ);if(o.test(AR.id)&&AR!==null){E.addClass(AR,AF)}}function AJ(AQ){var AR=I.getTarget(AQ);if(AR!==null){E.removeClass(AR,AF)}}function x(AR){AR=AR||window.event;var AS=Y.getById(this.id),AQ=document.getElementById(AS.id),AT=AR.relatedTarget||AR.fromElement;if(AS._isHidden&&(!AT||(AT!==AQ&&!E.contains(AQ,AT)))){K(AS,AR)}}function X(AR){AR=AR||window.event;var AU=AR.keyCode,AQ=this.id.replace(/-calendar$/,""),AT=Y.getById(AQ),AS;if(AU===d.ESC){if(!AT._isHidden){document.getElementById(AQ).focus();n(AT)}}else{if(AU===d.ENTER){AS=I.getTarget(AR);M(this,AS)}else{if(AU===d.TAB){z(AT,AR)}else{if(d.ARROW_KEY_EXP.test(AU)){h(AT,AR,AU)}}}}}function z(AV,AS){if(!AG){return}var AU=I.getTarget(AS),AQ=AS.shiftKey,AR=AV.id+"-prev-year",AW=AU.id===AR,AT=AU.id===AV.id+"-next-year";if(AQ&&AW||!AQ&&AT){I.preventDefault(AS)}else{if(AU.tabIndex===-1&&AG){I.preventDefault(AS);document.getElementById(AR).focus()}}}function h(AW,AS,AV){var AU=I.getTarget(AS),AT=AU.id.match(y),AR,AQ;if(AT){if(AV===d.LEFT){AR=-1}else{if(AV===d.RIGHT){AR=1}else{if(AV===d.UP){AR=-7}else{if(AV===d.DOWN){AR=7}}}}if(AR){AR=+AT[1]+AR}}else{AR=0}AQ=document.getElementById(AW.id+"-day"+AR);if(AQ){j(AQ)}}function j(AQ){if(AG){AQ.tabIndex=0;AQ.focus();AQ.tabIndex=-1}}function K(AR){if(k){AR.onshow();return}AO(document,"onmousedown",m);AO(document,"onmouseup",AK);if(!AR._isHidden){return}if(Z){n(Z)}t(AR);AR._isHidden=false;var AQ=document.getElementById(AR.calendarId),AS=AQ.style;u(AR.id,AS);if(AR.useAnim){e(AR)}AR.onshow(AR);AR.show(AS);Z=AR;AR.setDate(AA(AR));S(AR,AQ);AQ.parentNode.style.zIndex="100"}function S(AR,AQ){if(AG){if(AR.selectedId){setTimeout(function(){var AT=document.getElementById(AR.selectedId);try{AT.focus()}catch(AS){}finally{AR=AQ=AT=null}},120)}else{AQ.focus()}}}function u(AS,AU){var AR=document.getElementById(AS),AQ=AR.parentNode,AT=E.getOffsetCoords(AR,AQ);AU.left=AT.x+"px";AU.top=AT.y+AR.offsetHeight+"px"}function n(AR){if(AR._isHidden){return}AR.onhide();if(k){return}var AQ=document.getElementById(AR.calendarId);if(AQ!==null){AR.hide(AQ.style);AQ.parentNode.style.zIndex=""}AR._isHidden=true}var V;function AE(AR){AR=AR||window.event;if(AR.button>1){return}var AS=I.getTarget(AR),AQ=AS.id;if(o.test(AQ)){M(this,AS);if(T.test(AQ)){V=q(this,AQ);if(V){V.startAfter(400)}}}}function q(AT,AQ){var AR,AS=Y.getById(AT.id.replace(/-calendar$/,""));if(p){if(!V){V=new p.Animation(3000)}V.run=function AR(){AD(AS,AQ)};AR=AT=null}return V}function M(AU,AT){var AR,AS=AT.id,AQ;AR=Y.getById(AU.id.replace(/-calendar$/,""));if(y.test(AS)){if(AR.hideOnSelect||AS!==AR.selectedId){AQ=+AT.firstChild.data;if(AQ){g(AR,AQ,AT,AS)}}}else{if(T.test(AS)){AD(AR,AS)}}}function g(AS,AQ,AW,AR,AV){var AU=document.getElementById(AS.selectedId),AT=L;if(AU){E.removeClass(AU,AT)}E.addClass(AW,AT);AS.selectedId=AW.id;AP(AS,AQ);AS.onselect();if(AS.hideOnSelect){document.getElementById(AS.id).focus();setTimeout(function(){n(AS,AV);AS=AW=AU=null},150)}}function AD(AR,AT){var AQ=new Date(AR.displayDate),AS=T.exec(AT)[1];if(AS==="next-year"){AQ.setFullYear(AQ.getFullYear()+1)}else{if(AS==="prev-year"){AQ.setFullYear(AQ.getFullYear()-1)}else{if(AS==="next-month"){AQ.setMonth(AQ.getMonth()+1)}else{if(AS==="prev-month"){AQ.setMonth(AQ.getMonth()-1)}}}}AR.setDate(AQ)}function AP(AT,AQ){var AR=AT.displayDate||new Date,AS;AR.setDate(AQ);AS=w(AR);document.getElementById(AT.id).value=AS}function AN(){return false}function w(AR){var AT=("000"+AR.getFullYear()).slice(-4),AS=("0"+(AR.getMonth()+1)).slice(-2),AQ=("0"+(AR.getDate())).slice(-2);return AT+"-"+AS+"-"+AQ}function AC(AQ){AQ=AQ||window.event;var AS=AQ.keyCode,AR;if(AS===d.ESC||AS===d.ENTER){I.preventDefault(AQ);AR=Y.getById(this.id);if(AS===27){n(AR)}else{if(AS===d.ENTER){if(AR._isHidden){K(AR)}else{n(AR)}}}}}function m(AR){if(!Z){return}var AS=E.Event.getTarget(AR),AT=document,AQ=AT.getElementById(Z.calendarId);if(AS&&AS.id!==Z.id&&!AQ||!E.contains(AQ,AS,true)){n(Z);Z=null;AI(AT,"onmousedown",m);AI(AT,"onmouseup",AK)}}function AK(AQ){V&&V.stop()}function W(AR){var AQ=AM[AR];if(!AQ){AQ=AM[AR]=new N(AR,c,i,p.Transitions.getSigmoid(3))}return AQ}function e(AQ){if(AQ.useAnim){W(AQ.calendarId).seekTo(1)}}function l(){if(this.useAnim){W(this.calendarId).seekTo(0)}}a.prototype={hideOnSelect:true,useAnim:true,initEvents:function(){if(k){return}var AR=document,AQ=AR.getElementById(this.id);AO(AQ,"onfocus",x);AO(AQ,"onkeydown",AC);AO(AQ,"onclick",x)},purgeEvents:function(){var AR=document,AQ=AR.getElementById(this.id);if(AQ){AI(AQ,"onfocus",x);AI(AQ,"onkeydown",AC);AI(AQ,"onclick",x)}AI(AR,"onmousedown",m);AI(AR,"onmouseup",AK)},calendarId:"",hiddenDayClass:"ape-calendar-empty-day",calendarClass:"ape-calendar",show:function(AQ){AQ.visibility="visible"},hide:function(AQ){AQ.visibility="hidden"},isShown:function(AQ){return AQ.visibility==="visible"},onshow:AH,onhide:AH,onselect:AH,getDate:function(){return this.displayDate||AA(this)},setDate:function(AR){if(k){document.getElementById(this.id).value=w(AR);return}var AQ=AR!=null,AS=1000*60*60*24;AR=AQ?new Date(AR):new Date;if(!this.displayDate||!this.selectedId||Math.abs(this.displayDate-AR.getTime())>AS){this.displayDate=AR;s(this,AQ)}}};return a}});