APE.namespace("APE.widget").createCustomFactory("Calendar",function(C){var A=document.createElement("input");A.setAttribute("type","date");C.IS_NATIVE=/date/i.test(A.type);return B;function B(Q){function S(AD){this.id=AD;if(Z){return}this._isHidden=true;this.initEvents()}function p(AE){var AD=document.getElementById(AE.id);return N(AD.value)}function N(AF){var AE=/^\s*(\d{4})-(\d\d)-(\d\d)\s*$/,AD=null,AH,AG=AE.exec(AF);if(AG){AD=new Date(0);AH=+AG[2];AD.setFullYear(AG[1],AH-1,AG[3]);if(AH===AD.getMonth()+1){AD.setHours(0,0,0,0)}else{AD=null}}return AD}var d=window.APE,G=d.dom,j=G.Event,H=d.EventPublisher,AB=H.add,w=H.remove,T=document.body,R=null,v=typeof T.focus!=="undefined",u="ape-calendar-focused-el",E="ape-calendar-selected-day",M=/-((?:next|prev)-(?:month|year))$/,c=/-next-|-prev-|-day\d/,n=/-day(\d+)$/,U=G.key,Z=Q.IS_NATIVE,K=[31,28,31,30,31,30,31,31,30,31,30,31];noop=Function.prototype;T=null;function g(AF,AK){var AE=d.widget.CalendarLocale,AO=AF.displayDate;if(!AE){throw Error("Missing Resource: APE.widget.CalendarLocale")}h(AF);var AH=document,AI=AO.getFullYear(),AG=AO.getMonth(),AM=AE.months.abbr[AG],AJ=f(AO),AN=AH.getElementById(AF.calendarId),AL=AN.getElementsByTagName("tbody")[0].getElementsByTagName("b"),AD=AH.getElementById(AF.calendarId+"-header");AD.firstChild.data=AI+", "+AM;q(AF,AI,AG,AJ,AL);z(AF,AJ,AL);if(AK){J(AF,AJ+AO.getDate(),AL)}}function f(AD){AD=new Date(AD);AD.setDate(1);return AD.getDay()}function q(AG,AL,AK,AM,AN){var AH=0,AF=0,AI=K[AK],AE,AJ=AG.id+"-day",AD=(0==(AL%4))&&((0!=(AL%100))||(0==(AL%400)));if(AK===1&&AD){AI+=1}while(AH<AM){AE=AN[AH++];AE[G.TEXT_CONTENT]=" ";AE.className=AG.hiddenDayClass;AE.id=""}while(AF++<AI){AE=AN[AH++];AE.id=AJ+(AF-1);AE[G.TEXT_CONTENT]=AF+"";AE.tabIndex=-1;AE.className=""}for(AH=AM+AI,AF=AN.length;AH<AF;AH++){AE=AN[AH];AE[G.TEXT_CONTENT]=" ";AE.className=AG.hiddenDayClass}}function z(AG,AD,AF){if(I(AG)){var AE=AD+new Date().getDate()-1;G.addClass(AF[AE],AG.calendarClass+"-today")}}function J(AG,AF,AE){if(I(AG)&&!AG.selectedId){var AD=AE[AF-1];G.addClass(AD,E);AG.selectedId=AD.id}}function I(AE){var AD=p(AE)||new Date;return AD!=null&&AE.displayDate.getYear()==AD.getYear()&&AE.displayDate.getMonth()==AD.getMonth()}function h(AG){if(!AG.calendarId){AG.calendarId=AG.id+"-calendar"}var AJ=document;if(AJ.getElementById(AG.calendarId)!==null){return}var AM=AJ.createElement("div"),AL,AK=AJ.getElementById(AG.id),AE=AK.parentNode,AH=k(),AD=d.widget.CalendarLocale,AF=AD.days.abbr,AI="<thead><tr class='calendar-button-row'><th id='"+AG.id+"-prev-year' tabindex='0' title='"+AD.previousYear+"'>&#x00ab;</th><th id='"+AG.id+"-prev-month' tabindex='0' title='"+AD.previousMonth+"'>&#x2039;</th><th colspan='3' class='ape-calendar-header'><div id='"+AG.calendarId+"-header'>-</div></th><th id='"+AG.id+"-next-month' tabindex='0' title='"+AD.nextMonth+"' class='"+AG.calendarClass+"-days'>&#x203A;</th><th id='"+AG.id+"-next-year' tabindex='0' title='"+AD.nextYear+"'>&#x00bb;</th></tr><tr><th>"+AF.join("</th><th>")+"</th></tr></thead>";AM.onselectstart=AA;AM.innerHTML="<table>"+AI+AH+"</table>";AM.id=AG.calendarId;AM.className=AG.calendarClass;AM.tabIndex=0;AM.onmousedown=t;AM.onkeydown=P;AL=AM.firstChild;if("onfocusin" in AL){AL.onfocusin=V;AL.onfocusout=x}AE.insertBefore(AM,AK.nextSibling)}function k(){var AG=[],AF=6,AD=[],AE;AG.length=8;AD.length=AF;AG=AG.join("<td><b>&nbsp;</b></td>");for(AE=0;AE<AF;AE++){AD[AE]="<tr id='w"+AE+1+"'>"+AG+"</tr>\n"}return"<tbody>"+AD.join("")+"</tbody>"}function V(AD){var AE=j.getTarget(AD);if(c.test(AE.id)&&AE!==null){G.addClass(AE,u)}}function x(AD){var AE=j.getTarget(AD);if(AE!==null){G.removeClass(AE,u)}}function m(AE){AE=AE||window.event;var AF=Q.getById(this.id),AD=document.getElementById(AF.id),AG=AE.relatedTarget||AE.fromElement;if(AF._isHidden&&(!AG||(AG!==AD&&!G.contains(AD,AG)))){D(AF,AE)}}function P(AE){AE=AE||window.event;var AH=AE.keyCode,AD=this.id.replace(/-calendar$/,""),AG=Q.getById(AD),AF;if(AH===U.ESC){if(!AG._isHidden){document.getElementById(AD).focus();b(AG)}}else{if(AH===U.ENTER){AF=j.getTarget(AE);F(this,AF)}else{if(AH===U.TAB){o(AG,AE)}else{if(U.ARROW_KEY_EXP.test(AH)){X(AG,AE,AH)}}}}}function o(AI,AF){if(!v){return}var AH=j.getTarget(AF),AD=AF.shiftKey,AE=AI.id+"-prev-year",AJ=AH.id===AE,AG=AH.id===AI.id+"-next-year";if(AD&&AJ||!AD&&AG){j.preventDefault(AF)}else{if(AH.tabIndex===-1&&v){j.preventDefault(AF);document.getElementById(AE).focus()}}}function X(AJ,AF,AI){var AH=j.getTarget(AF),AG=AH.id.match(n),AE,AD;if(AG){if(AI===U.LEFT){AE=-1}else{if(AI===U.RIGHT){AE=1}else{if(AI===U.UP){AE=-7}else{if(AI===U.DOWN){AE=7}}}}if(AE){AE=+AG[1]+AE}}else{AE=0}AD=document.getElementById(AJ.id+"-day"+AE);if(AD){Y(AD)}}function Y(AD){if(v){AD.tabIndex=0;AD.focus();AD.tabIndex=-1}}function D(AE){if(Z){AE.onshow();return}AB(document,"onmousedown",a);AB(document,"onmouseup",y);if(!AE._isHidden){return}if(R){b(R)}h(AE);AE._isHidden=false;var AD=document.getElementById(AE.calendarId),AF=AD.style;i(AE.id,AF);AE.onshow();AE.show(AF);R=AE;AE.setDate(p(AE));L(AE,AD);AD.parentNode.style.zIndex="100"}function L(AE,AD){if(v){if(AE.selectedId){setTimeout(function(){var AG=document.getElementById(AE.selectedId);try{AG.focus()}catch(AF){}finally{AE=AD=AG=null}},120)}else{AD.focus()}}}function i(AF,AH){var AE=document.getElementById(AF),AD=AE.parentNode,AG=G.getOffsetCoords(AE,AD);AH.left=AG.x+"px";AH.top=AG.y+AE.offsetHeight+"px"}function b(AE){if(AE._isHidden){return}AE.onhide();if(Z){return}var AD=document.getElementById(AE.calendarId);if(AD!==null){AE.hide(AD.style);AD.parentNode.style.zIndex=""}AE._isHidden=true}var O;function t(AE){AE=AE||window.event;if(AE.button>1){return}var AF=j.getTarget(AE),AD=AF.id;if(c.test(AD)){F(this,AF);if(M.test(AD)){O=e(this,AD);if(O){O.startAfter(400)}}}}function e(AH,AD){var AF,AE=d.anim,AG=Q.getById(AH.id.replace(/-calendar$/,""));if(AE){if(!O){O=new AE.Animation(3000)}O.run=function AF(){s(AG,AD)};AF=null}return O}function F(AH,AG){var AE,AF=AG.id,AD;AE=Q.getById(AH.id.replace(/-calendar$/,""));if(n.test(AF)){if(AE.hideOnSelect||AF!==AE.selectedId){AD=+AG.firstChild.data;if(AD){W(AE,AD,AG,AF)}}}else{if(M.test(AF)){s(AE,AF)}}}function W(AF,AD,AJ,AE,AI){var AH=document.getElementById(AF.selectedId),AG=E;if(AH){G.removeClass(AH,AG)}G.addClass(AJ,AG);AF.selectedId=AJ.id;AC(AF,AD);AF.onselect();if(AF.hideOnSelect){document.getElementById(AF.id).focus();setTimeout(function(){b(AF,AI);AF=AJ=AH=null},150)}}function s(AE,AG){var AD=new Date(AE.displayDate),AF=M.exec(AG)[1];if(AF==="next-year"){AD.setFullYear(AD.getFullYear()+1)}else{if(AF==="prev-year"){AD.setFullYear(AD.getFullYear()-1)}else{if(AF==="next-month"){AD.setMonth(AD.getMonth()+1)}else{if(AF==="prev-month"){AD.setMonth(AD.getMonth()-1)}}}}AE.setDate(AD)}function AC(AG,AD){var AE=AG.displayDate||new Date,AF;AE.setDate(AD);AF=l(AE);document.getElementById(AG.id).value=AF}function AA(){return false}function l(AE){var AG=("000"+AE.getFullYear()).slice(-4),AF=("0"+(AE.getMonth()+1)).slice(-2),AD=("0"+(AE.getDate())).slice(-2);return AG+"-"+AF+"-"+AD}function r(AD){AD=AD||window.event;var AF=AD.keyCode,AE;if(AF===U.ESC||AF===U.ENTER){j.preventDefault(AD);AE=Q.getById(this.id);if(AF===27){b(AE)}else{if(AF===U.ENTER){if(AE._isHidden){D(AE)}else{b(AE)}}}}}function a(AE){if(!R){return}var AF=G.Event.getTarget(AE),AG=document,AD=AG.getElementById(R.calendarId);if(AF&&AF.id!==R.id&&!AD||!G.contains(AD,AF,true)){b(R);R=null;w(AG,"onmousedown",a);w(AG,"onmouseup",y)}}function y(AD){O&&O.stop()}S.prototype={hideOnSelect:true,initEvents:function(){if(Z){return}var AE=document,AD=AE.getElementById(this.id);AB(AD,"onfocus",m);AB(AD,"onkeydown",r);AB(AD,"onclick",m)},purgeEvents:function(){var AE=document,AD=AE.getElementById(this.id);if(AD){w(AD,"onfocus",m);w(AD,"onkeydown",r);w(AD,"onclick",m)}w(AE,"onmousedown",a);w(AE,"onmouseup",y)},calendarId:"",hiddenDayClass:"ape-calendar-empty-day",calendarClass:"ape-calendar",show:function(AD){AD.visibility="visible"},hide:function(AD){AD.visibility="hidden"},isShown:function(AD){return AD.visibility==="visible"},onshow:noop,onhide:noop,onselect:noop,getDate:function(){return this.displayDate||p(this)},setDate:function(AE){if(Z){document.getElementById(this.id).value=l(AE);return}var AD=AE!=null,AF=1000*60*60*24;AE=AD?new Date(AE):new Date;if(!this.displayDate||!this.selectedId||Math.abs(this.displayDate-AE.getTime())>AF){this.displayDate=AE;g(this,AD)}}};return S}});