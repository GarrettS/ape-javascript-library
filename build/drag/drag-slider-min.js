APE.namespace("APE.drag");(function(){var E=self.APE,G=E.dom,I=E.drag,P=G.Event,J=1000,K={},F,L,O="function",B=E.createFactory(N,M),Q=E.createFactory(D,C);I.Draggable=B;I.DropTarget=Q;B.instanceDestructor=H;function N(X,R,U){var V=document,S=V.getElementById(X),T;this.id=X;this.el=this.origEl=S;this.style=S.style;this.isRel=G.getStyle(S,"position").toLowerCase()=="relative";var W=(this.isRel?S.parentNode:G.getContainingBlock(S));if(W===null){W=V.documentElement}this.container=W;this.dropTargets=[];this.handle=S;this.onbeforeexitcontainer=A;for(T in R){this[T]=R[T]}S.style.zIndex=parseInt(G.getStyle(S,"zIndex"),10)||J++}function A(){return !this.keepInContainer}function H(){var R,T,S;for(R in this.instances){S=this.instances[R];for(T in S){delete S[T]}delete this.instances[R]}K={}}function M(){var AJ=self.document,U=E.EventPublisher,AB="documentElement",b=AJ[AB].style,x="serSelect",AK="MozU"+x,k="MozU"+x,AA="u"+x,r=AK in b?AK:k in b?k:AA in b?AA:"",a="px",e="left",o="top",AH=false,X=0,W=0,z,s=false,R=false,j=25,u=-1,w=U.get(AJ,"onmousedown");getEventCoords=P.getCoords;if("onselectstart" in AJ){U.add(AJ,"onselectstart",g)}else{w.addAfter(g)}if("pixelLeft" in b){a=0;e="pixelLeft";o="pixelTop"}w.add(h).addAfter(Y);U.add(AJ,"onkeydown",t);U.add(AJ,"onmousemove",q);U.add(AJ,"onmouseup",Z);AJ=b=null;function g(AM){var d=!z;if(r){this[AB].style[r]=d?"":"none"}else{AM=AM||self.event;AM.returnValue=d}}function AE(d,AM){return AM===d.handle||(d.useHandleTree&&G.contains(d.handle,AM))}function AG(d,AM){if(AM){if(d.selectedClassName){G.addClass(d.el,d.selectedClassName)}if(d.dragMultiple&&!(d.id in K)){K[d.id]=d}}else{if(d.selectedClassName){G.removeClass(d.el,d.selectedClassName)}delete K[d.id]}d.isSelected=AM}function m(AT,AS){var AM=AS.container,AP=AS.el,AV=document,AO=AV.documentElement,AR=G.getContainingBlock(AP)||AO,AQ,AU,AY=(AR===AM)?{x:0,y:0}:G.getOffsetCoords(AR,AM),AN=G.getPixelCoords(AP),AZ=G.getOffsetCoords(AP,AP.parentNode),AX=AZ.x-AN.x+AY.x,AW=AZ.y-AN.y+AY.y;if(AS.keepInContainer){if(AM===AV.body){AQ=parseInt(G.getStyle(AM,"width"),10);AU=parseInt(G.getStyle(AM,"height"),10)}else{AQ=AM.clientWidth;AU=AM.clientHeight}AS.minX=0-AX;AS.maxX=AQ-AP.offsetWidth-AX;AS.minY=0-AW;AS.maxY=AU-AP.offsetHeight-AW}}function y(){for(var d in K){AG(K[d],false)}R=false}function T(AP,d){v(d);var AQ=G.removeClass,AO,AN,AM,AR;if(s!==false){for(AN=0,AM=s.length;AN<AM;AN++){AO=s[AN];if(AO.hasDropTargetOver){if(typeof AO.ondragout==O){AO.ondragout(AP,d)}if(AO.dragOverClassName){AQ(AO.el,AO.dragOverClassName)}AO.hasDropTargetOver=false}}}for(AR in K){v(K[AR])}z=null}function V(d,AM){if(d.activeDragClassName){G.removeClass(d.el,d.activeDragClassName)}if(typeof d.ondragend==O&&d.hasBeenDragged){d.ondragend(AM)}if(d.copyEl){d.el.parentNode.insertBefore(d.copyEl,d.el)}d.hasBeenDragged=false}function f(d,AM){if(AM){if(d.id in K){AG(d,false)}else{AG(d,true)}}else{if(!d.isSelected){y();AG(d,true)}}}function AC(AM){var AO="addClass",AQ,AN=AM.el,AP=AN,d;if(!AM.copyEl){AM.origEl=AN;AM.copyEl=AN.cloneNode(true);AM.copyEl.id+="Copy"}AQ=AM.copyEl;d=AQ.style;d.display="";if(AQ.parentNode!==AN.parentNode){AN.parentNode.insertBefore(AQ,AN)}d.zIndex=parseInt(AP.style.zIndex,10)+100;if(AM.origClassName){G[AO](AN,AM.origClassName)}AM.el=AQ;AM.style=d;if(AM.isRel){d.marginBottom=-AP.offsetHeight+-(parseInt(G.getStyle(AP,"marginBottom"),10)||0)+"px";d.marginright=-AP.offsetWidth+-(parseInt(G.getStyle(AP,"marginRight"),10)||0)+"px"}}function AL(d){if(d.copyEl.style.display=="none"){return}d.el=d.origEl;d.style=d.origEl.style;d.moveToX(d.x);d.moveToY(d.y);d.copyEl.style.display="none";if(d.origClassName){G.removeClass(d.el,d.origClassName)}}function AF(AM,d){if(!R){return}var AN,AO;for(AO in K){AN=K[AO];if(typeof AM=="number"){AN.moveToX(AN.origX+AM)}if(typeof d=="number"){AN.moveToY(AN.origY+d)}}}function c(d,AM){if(d.isBeingDragged){return}if(d.dragCopy){AC(d)}if(typeof d.ondragstart==O){d.ondragstart(AM)}if(d.activeDragClassName){G.addClass(d.el,d.activeDragClassName)}m(AM,d);d.isBeingDragged=true}function h(AP){if(L){L=false;return}AP=AP||self.event;var AO=P.getTarget(AP),AN=B.instances,AM,d=AO,AQ=AP.metaKey||AP.ctrlKey;while(!AM&&d!==null){AM=AN[d.id];d=G.findAncestorWithAttribute(d,"id")}if(AM){if(!AM.isDragEnabled){if(!AQ){y()}return false}if(!AQ&&AM.hasHandleSet&&!AE(AM,AO)){y();AM=null;return}else{if(!AQ&&!AM.isSelected){y()}AP.returnValue=false}}else{if(!AQ){y();if(z){AG(z,false);z=null}}return}if(AQ&&z&&!AM.dragMultiple){AH=true;return false}if(!AM.dragMultiple){if(!AQ){y()}else{AH=true;return false}}f(AM,AQ);AM.style.zIndex=++J;if(AQ){}z=AM;AI(AP,AM);for(var AR in K){AI(AP,K[AR])}return AO.tagName!=="IMG"}function Y(){if(!z){return}s=[];var AO=z.dropTargets,AN,AM=0,d=AO.length;for(;AM<d;AM++){AN=AO[AM];AN.initCoords();if(typeof AN.ondragover==O||typeof AN.ondragout==O||AN.dragOverClassName){s.push(AN)}}if(s.length===0){s=false}}function AI(AO,d){if(typeof d.onbeforedragstart==O&&d.onbeforedragstart(AO)==false){return true}var AN=getEventCoords(AO),AM;X=AN.x;W=AN.y;AM=G.getPixelCoords(d.el);d.origX=d.grabX=AM.x;d.origY=d.grabY=AM.y;d.isBeingDragged=false}function q(AY){if(!z){return}var AO=+new Date;if(AO-u<j){return}u=AO;AY=AY||self.event;var AR=getEventCoords(AY),AX=AR.x,AU=AR.y,AT=AX-X,AS=AU-W,AQ=false,Aa=z.origX+AT,AZ=z.origY+AS,AV;if(z.isBeingDragged===false){c(z,AY);delete K[z.id];for(AV in K){R=true;c(K[AV],AY)}}z.hasBeenDragged=(z.hasBeenDragged||(AT||AS));var AP=Aa<z.minX,AN=Aa>z.maxX,Ac=AZ<z.minY,AW=AZ>z.maxY,AM=z.container!=null,Ad=(typeof z.ondrag==O),d=typeof z.onbeforeexitcontainer==O,Ab=0;if(typeof z.onbeforedrag==O&&z.onbeforedrag(AY)==false){return}AM&=(AP||AN||Ac||AW);if(AM&&(d||z.onbeforeexitcontainer()==false)){if(AP){if(!z.isAtLeft){z.moveToX(z.minX);AF(z.minX-z.origX,null);if(Ad){z.ondrag(AY)}z.isAtRight=false;z.isAtLeft=true}Ab+=1}else{if(AN){if(!z.isAtRight){z.moveToX(z.maxX);AF(z.maxX-z.origX,null);if(Ad){z.ondrag(AY)}z.isAtRight=true;z.isAtLeft=false}Ab+=1}else{z.isAtLeft=z.isAtRight=false;z.moveToX(Aa);AF(AT,null)}}if(Ac){if(!z.isAtTop){z.moveToY(z.minY);AF(null,z.minY-z.origY);if(Ad){z.ondrag(AY)}z.isAtTop=true;z.isAtBottom=false}Ab+=1}else{if(AW){if(!z.isAtBottom){if(z.maxY>0){z.moveToY(z.maxY)}AF(null,z.maxY-z.origY);if(Ad){z.ondrag(AY)}z.isAtTop=false;z.isAtBottom=true}Ab+=1}else{z.isAtTop=z.isAtBottom=false;z.moveToY(AZ);AF(null,AS)}}AQ=Ab==2;if(AQ&&typeof z.ondragstop==O){z.ondragstop(AY)}else{if(Ad){z.ondrag(AY)}}}else{z.isAtLeft=z.isAtRight=z.isAtTop=z.isAtBottom=false;z.moveToX(Aa);z.moveToY(AZ);AF(AT,AS);if(Ad){z.ondrag(AY)}}if(s!==false){p(z,AY,AX,AU)}return false}function Z(AN){L=false;if(!z){return}var AR=(z.isBeingDragged&&!z.hasBeenDragged),AQ,AM,AO,d,AP;if(!z.hasBeenDragged&&!AR){if(!AH){z=null}return}K[z.id]=z;AH=false;if(z.copyEl){AL(z)}if(R){for(AQ in K){AM=K[AQ];if(AM.copyEl){AL(AM)}}}AN=AN||self.event;i(AN);if(R){for(AQ in K){AO=K[AQ];d=AO.x;AP=AO.y;if(d<AO.minX){AO.moveToX(AO.minX)}else{if(d>AO.maxX){AO.moveToX(AO.maxX)}}if(AP<AO.minY){AO.moveToY(AO.minY)}else{if(AP>AO.maxY){AO.moveToY(AO.maxY)}}if(AO.hasBeenDragged){V(AO,AN)}}}V(z,AN);z=null}function t(d){d=d||self.event;if(d.keyCode==27){if(z){z.release(d)}}}function p(AT,AR,AN,d){var AU={x:AN,y:d},AQ=0,AP=s.length,AM,AO,AS={domEvent:AR,dragObj:AT};for(;AQ<AP;AQ++){AM=s[AQ];AO=AM.containsCoords(AU);if(!AM.hasDropTargetOver&&AO){AM.hasDropTargetOver=true;if(typeof AM.ondragover==O){AM.ondragover(AS)}if(AM.dragOverClassName){G.addClass(AM.el,AM.dragOverClassName)}}else{if(AM.hasDropTargetOver&&!AO){if(typeof AM.ondragout==O){AM.ondragout(AS)}if(AM.dragOverClassName){G.removeClass(AM.el,AM.dragOverClassName)}AM.hasDropTargetOver=false}}}}function i(AO){var AM=z.dropTargets,AS,AP,d=AM.length,AN,AR,AQ;if(d>0){AP=getEventCoords(AO);for(AN=0;AN<d;AN++){AS=AM[AN];if(AS.containsCoords(AP)){if(typeof AS.ondrop==O){AS.ondrop({domEvent:AO,dragObj:z,dropTarget:AS})}if(R){for(AR in K){if(AR===AS.id){continue}if(typeof AS.ondrop==O){AQ=K[AR];AS.ondrop({domEvent:AO,dragObj:AQ,dropTarget:AS})}}}if(AS.dragOverClassName){G.removeClass(AS.el,AS.dragOverClassName)}break}}}}function l(AM){var AN=E.anim;AM.startX=AM.x;AM.startY=AM.y;var d=new AN.Animation(0.2);d.transition=AN.Transitions.accel;d.run=n;d.dObj=AM;d.onplay=AM.onglide;d.onend=S;d.start()}function n(AO){var AM=this.dObj,AN=AM.startX-AM.grabX,d=AM.startY-AM.grabY;AO=Math.pow(AO,3);AM.moveToX(AM.startX-(AN*AO));AM.moveToY(AM.startY-(d*AO))}function S(){AD(this.dObj)}function AD(d){if(typeof d.onglideend==O){d.onglideend()}if(d.copyEl){d.el=d.origEl;d.style=d.origEl.style;d.copyEl.style.display="none"}V(d,{})}function v(d){if(E.anim&&d.useAnim){l(d)}else{d.moveToX(d.grabX);d.moveToY(d.grabY);if(typeof d.onglide==O){d.onglide()}AD(d,{})}}return{dragCopy:false,useAnim:true,dragMultiple:false,selectedClassName:"",activeDragClassName:"",useHandleTree:true,isSelected:false,onbeforedrag:F,onbeforedragstart:F,ondragstart:F,ondrag:F,ondragstop:F,ondragend:F,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,keepInContainer:false,isDragEnabled:true,hasHandleSet:false,setHandle:function(d,AM){this.handle=d;this.hasHandleSet=true;this.useHandleTree=AM!=false},addDropTarget:function(AO){var AM=Q.getByNode(AO),d=AM.el,AN=this.dropTargets;if(this.el===d){return AM}return AN[AN.length]=Q.getByNode(d)},grab:function(AS,AU,AO){AS=AS||self.event;var AT=P.getTarget(AS),AN;if(AS.preventDefault){AS.preventDefault()}else{AS.returnValue=false}if(G.contains(this.el,AT)){return}AN=G.getPixelCoords(this.el);this.grabX=AN.x;this.grabY=AN.y;var AV=getEventCoords(AS),AR=this.handle,AM=G.getOffsetCoords(G.getContainingBlock(this.el)),AQ=AV.x-AM.x,d=AQ-(0|AR.offsetWidth/2),AP=AV.y-AM.y,AX=(AP-(0|AR.offsetHeight/2)),AW=G.getOffsetCoords(AR,this.el);if(this.keepInContainer){d=Math.max(d,0);d=Math.min(d,this.container.clientWidth-this.el.offsetWidth);AX=Math.max(AX,0);AX=Math.min(AX,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(d-AW.x+(AU||0));this.moveToY(AX-AW.y+(AO||0));AI(AS,this);L=true;z=this},release:function(d){T(d,this);if(typeof this.onrelease==O){this.onrelease(d)}if(this.dragMultiple){K[this.id]=this}},moveToX:function(d){this.style[e]=(this.x=d)+a},moveToY:function(d){this.style[o]=(this.y=d)+a},removeDropTarget:function(AO){var AO=document.getElementById(AO.id),AM=this.dropTargets,AN,d;for(AN=0,d=AM.length;AN<d;AN++){if(AM[AN].el===AO){AM.splice(AN,1);return AO}}return null},toString:function(){return"Draggable(id="+this.id+")"}}}function D(R){this.el=document.getElementById(R);this.id=R}function C(){return{dragOverClassName:"",initCoords:function(){this.coords=this.coords||{};G.getOffsetCoords(this.el,document,this.coords);this.coords.w=this.el.clientWidth;this.coords.h=this.el.clientHeight},containsCoords:function(R){var T=this.coords.x,S=this.coords.y;return(R.x>=T&&R.x<=T+this.coords.w)&&(R.y>=S&&R.y<=S+this.coords.h)},ondragover:false,ondragout:F,ondrop:F}}})();(function(){var B=self.APE,F=B.drag,C=B.dom,E=F.Slider=B.createFactory(A,G),J=1,D=2,H="minValue",I="maxValue";E.direction={HORZ:J,VERT:D};function A(O,K,M,N){this.id=O;this.dir=K;this.value=0;this.rationalValue=0;var L=F.Draggable.getById(O,K);L.keepInContainer=true;this.handle=L;this[H]=M||0;this[I]=N;this.tDist=0;this.init()}function G(){B.EventPublisher.add(document,"onkeydown",R);var P="ape-slider-track-active",S=null;return{init:function(){var W=B.EventPublisher,V=document.getElementById(this.id),X=this.handle,U=this.trackbar=document.getElementById(this.id).parentNode;W.add(X,"onglideend",N,this);W.add(X,"ondragend",N,this);W.add(X,"onglideend",N,this);W.add(X,"ondrag",Q,this);if(!("focus" in X)){W.add(V,"onmousedown",L,this)}W.add(V,"onfocus",L,this);W.add(V,"onblur",K,this);W.add(X,"onglide",Q,this);W.add(X,"ondragstop",Q,this);if(this.dir===D){this.tDist=U.clientHeight-V.offsetHeight;X.moveToX=M}else{this.tDist=U.clientWidth-V.offsetWidth;X.moveToY=M}if(this[I]===undefined){this[I]=this.tDist}W.add(U,"onmousedown",T,U)},ticks:15,rationalValue:0,slideToX:function(U){this.handle.moveToX(U);if(typeof slider.onslide==="function"){slider.onslide()}},setValue:function(U){U=Math.max(this[H],U);U=Math.min(this[I],U);var V=this.handle,X=this[I]-this[H],W=(U-this[H])/X;if(!V||!V.id){return}if(this.dir===D){V.moveToY(this.tDist*(1-W))}else{V.moveToX(this.tDist*W)}this.rationalValue=W;this.value=U},slideToY:function(U){this.handle.moveToY(U);this.onslide()},setRationalValue:function(V,U){V=Math.max(0,V);V=Math.min(1,V);this.rationalValue=V;this.setValue(this[H]+(V*(this[I]-this[H])));if(U){Q.call(this,{})}},toString:function(){return"Slider: "+this.handle.toString()}};function M(){}function T(W){var V=C.Event.getTarget(W),U;if(V!==this){return true}U=E.instances[this.getElementsByTagName("*")[0].id];W=W||self.event;if(W.preventDefault){W.preventDefault()}C.addClass(this,P);U.handle.grab(W);Q.call(U,W);return false}function N(U){C.removeClass(this.trackbar,P);Q.call(this,U);if(typeof this.onslideend==="function"){this.onslideend(U)}}function L(U){S=this;C.addClass(this.trackbar,P)}function K(U){if(S===this){S=null}C.removeClass(this.trackbar,P)}function Q(X){this.value=0;var V=document.getElementById(this.id),W=0;if(this.dir===J){if(V.offsetLeft>0){W=V.offsetLeft/this.tDist}else{W=0}}else{if(V.offsetTop>0){var U=this.tDist-V.offsetTop;W=U/this.tDist}else{W=1}}this.rationalValue=W;this.value=W*(this[I]-this[H]);if(this.onslide){this.onslide(X||{})}}var O;function R(Y){Y=Y||self.event;if(Y.stopPropagation){Y.stopPropagation()}Y.cancelBubble=true;var W=+new Date,U=S;if(!U){return}if(W-O<5){return}O=W;var b=Y.keyCode,a,V=b===37,Z=b===39,c=b===38,X=b===40;if(!(V||Z||c||X)){return true}if(U.id in E.instances){a=U[I]/U.ticks;if(V||X){a=-a}U.setValue(U.value+a);if(U.onslide){U.onslide(Y)}return false}}}})();