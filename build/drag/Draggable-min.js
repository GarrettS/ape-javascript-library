APE.namespace("APE.drag");
(function(){function sa(j,k){var l=document,n=l.getElementById(j),p;this.id=j;this.el=this.origEl=n;this.style=n.style;j=(this.isRel=u(n,"position").toLowerCase()=="relative")?n.parentNode:i.getContainingBlock(n);if(j===null)j=l.documentElement;this.container=j;this.dropTargets=[];this.handle=n;this.onbeforeexitcontainer=ta;if(k){for(p in k)this[p]=k[p];n.style.zIndex=x(u(n,"zIndex"),10)||W++}}function ta(){return!this.keepInContainer}function ua(){var j,k,l;for(j in this.instances){l=this.instances[j];
for(k in l)delete l[k];delete this.instances[j]}m={}}function va(){function j(){function a(g){var h=!e;if(f)this[X].style[f]=h?"":"none";else(g||window.event||0).returnValue=h}var b="serSelect",c="MozU"+b,d="MozU"+b;b="u"+b;var f=c in y?c:d in y?d:b in y?b:"";c="onselectstart";c in q?z(q,c,a):L.addAfter(a)}function k(a,b){return b===a.handle||a.useHandleTree&&i.contains(a.handle,b)}function l(a,b){if(b){a.selectedClassName&&i.addClass(a.el,a.selectedClassName);if(a.dragMultiple&&!(a.id in m))m[a.id]=
a}else{a.selectedClassName&&i.removeClass(a.el,a.selectedClassName);delete m[a.id]}a.isSelected=b}function n(a){var b=a.container,c=a.el,d=document,f=d.documentElement;f=i.getContainingBlock(c)||f;var g=f===b?{x:0,y:0}:i.getOffsetCoords(f,b),h=i.getPixelCoords(c),r=i.getOffsetCoords(c,c.parentNode);f=r.x-h.x+g.x;g=r.y-h.y+g.y;if(a.keepInContainer){if(b===d.body){d=x(u(b,"width"),10);b=x(u(b,"height"),10)}else{d=b.clientWidth;b=b.clientHeight}a.minX=0-f;a.maxX=d-c.offsetWidth-f;a.minY=0-g;a.maxY=b-
c.offsetHeight-g}}function p(){s(l,[false],true);A=false}function wa(a){Y(e);var b,c,d;if(t!==false){c=0;for(d=t.length;c<d;c++){b=t[c];if(b.hasDropTargetOver){typeof b.ondragout==o&&b.ondragout(a,e);b.dragOverClassName&&i.removeClass(b.el,b.dragOverClassName);b.hasDropTargetOver=false}}}s(Y)}function M(a){a.activeDragClassName&&i.removeClass(a.el,a.activeDragClassName);xa(a);Z&&a.el.releaseCapture();a.hasBeenDragged=false}function N(){if(e.hasBeenDragged)if(e.dragMultiple)m[e.id]=e;else m={};E=false;
F.remove(document,G,O);e=null}function ya(a,b){if(b)a.id in m?l(a,false):l(a,true);else if(!a.isSelected){p();l(a,true)}}function $(a){var b=a.el,c=a.copyEl;if(!c)c=a.copyEl=document.getElementById(a.proxyId);aa(a,c,b)}function za(a){if(!a.copyEl){a.copyEl=a.el.cloneNode(true);a.copyEl.id+="Copy"}aa(a,a.copyEl,a.el)}function aa(a,b,c){var d=b.style;a.origEl=c;d.zIndex=x(c.style.zIndex,10)+100;a.el=b;a.style=d;var f=u(c,"display");d.display=f;if(a.dragCopy){c.parentNode.insertBefore(b,c);a.isRel&&
Aa(d,c,f)}else Ba(a,b,c)}function Ba(a,b,c){b=i.getOffsetCoords(c,b.parentNode);a.moveToX(b.x);a.moveToY(b.y)}function Aa(a,b,c){if(c=="inline")a.marginRight=-b.offsetWidth+-(x(u(b,"marginRight"),10)||0)+"px";else a.marginBottom=-b.offsetHeight+-(x(u(b,"marginBottom"),10)||0)+"px"}function H(a){var b=a.copyEl;if(b){a.el=a.origEl;a.style=a.el.style;a.moveToX(a.x);a.moveToY(a.y);b.style.display="none";a.dragCopy&&!a.proxyId&&a.el.parentNode.insertBefore(b,a.el)}}function v(a,b){!A||P||s(Ca,[a,b])}function Ca(a,
b,c){typeof b=="number"&&a.moveToX(a.origX+b);typeof c=="number"&&a.moveToY(a.origY+c)}function ba(a,b){if(!a.isBeingDragged){a.dragCopy&&!a.proxyId&&za(a);typeof a.ondragstart==o&&a.ondragstart(ca(a,b));Z&&a.el.setCapture();a.activeDragClassName&&i.addClass(a.el,a.activeDragClassName);n(a);a.isBeingDragged=true}}function ca(a,b){var c=a.id,d={},f=1;d[c]=a;if(A)for(c in m){d[c]=m[c];f++}return{domEvent:b,draggableList:d,count:f}}function Da(a){if(I)I=false;else{var b=a||window.event;if(!(Q&&e)){a=
da(a,"touches");var c=J.getTarget(b),d=a.metaKey||a.ctrlKey,f=Ea(c);if(f){if(!f.isDragEnabled){d||p();return false}if(!d&&f.hasHandleSet&&!k(f,c))p();else{!d&&!f.isSelected&&p();a.returnValue=false;if(d&&e&&!f.dragMultiple){E=true;return false}if(!f.dragMultiple)if(d){E=true;return false}else p();ya(f,d);f.style.zIndex=++W;if(R(f,a)!=false){e=f;S(b);s(R,[a]);return c.tagName!=="IMG"}}}else if(!d){p();if(e){l(e,false);e=null}}}}}function Ea(a){for(var b,c=T.instances;!b&&a!==null;a=i.findAncestorWithAttribute(a,
"id"))b=c[a.id];return b}function Fa(){if(e){var a=e.dropTargets,b,c,d,f;if(!a)return t=false;t=[];c=d=0;for(f=a.length;c<f;c++){b=a[c];b.initCoords();if(b.ondragover||b.ondragout||b.dragOverClassName)t[d++]=b}if(d===0)t=false}}function R(a,b){if(typeof a.onbeforedragstart==o&&a.onbeforedragstart(ca(a,b))==false)return false;b=K(b);a.proxyId&&!a.dragCopy&&$(a);Ga(a);ea=b.x;fa=b.y;b=i.getPixelCoords(a.el);a.origX=a.grabX=b.x;a.origY=a.grabY=b.y;a.isBeingDragged=false;z(document,G,O)}function Ga(a){var b=
a.constraint;if(b==="y")a.moveToX=B;else if(b==="x")a.moveToY=B}function xa(a){delete a.moveToX;delete a.moveToY}function O(a){if(e){var b=+new Date;if(!(b-ga<Ha)){ga=b;b=a=a||event;if(Q){a=a.touches&&a.touches[0];if(!a)return;S(b)}var c=K(a);b=c.x;c=c.y;var d=b-ea,f=c-fa,g=e.origX+d,h=e.origY+f,r;if(e.isBeingDragged===false){P=!!e.proxyId;for(r in m){A=true;break}delete m[e.id];ba(e,a);e.proxyId&&e.dragCopy&&$(e);s(ba,[a])}e.hasBeenDragged=e.hasBeenDragged||!!(d||f);if(!(typeof e.onbeforedrag==o&&
e.onbeforedrag(a)==false)){r=typeof e.ondrag===o;if(!Ia(e,g,h,d,f,r,a)){e.isAtLeft=e.isAtRight=e.isAtTop=e.isAtBottom=false;e.moveToX(g);e.moveToY(h);v(d,f);r&&e.ondrag(a)}t!==false&&Ja(e,a,b,c);return false}}}}function Ia(a,b,c,d,f,g,h){if(a.container){var r=b<a.minX,ha=b>a.maxX,ia=c<a.minY,ja=c>a.maxY,C;if(r||ha||ia||ja&&a.onbeforeexitcontainer()!=true){if(r){if(!a.isAtLeft){a.moveToX(a.minX);v(a.minX-a.origX,null);g&&a.ondrag(h);a.isAtRight=false;a.isAtLeft=true}C=true}else if(ha){if(!a.isAtRight){a.moveToX(a.maxX);
v(a.maxX-a.origX,null);g&&a.ondrag(h);a.isAtRight=true;a.isAtLeft=false}C=true}else{a.isAtLeft=a.isAtRight=false;a.moveToX(b);v(d,null)}if(ia){if(!a.isAtTop){a.moveToY(a.minY);v(null,a.minY-a.origY);g&&a.ondrag(h);a.isAtTop=true;a.isAtBottom=false}C=true}else if(ja){if(!a.isAtBottom){a.maxY>0&&a.moveToY(a.maxY);v(null,a.maxY-a.origY);g&&a.ondrag(h);a.isAtTop=false;a.isAtBottom=true}C=true}else{a.isAtTop=a.isAtBottom=false;a.moveToY(c);v(null,f)}if(C)a.ondragstop(h);else g&&a.ondrag(h);return true}}return false}
function Ka(a){I=false;F.remove(document,G,O);if(e){var b=e.hasBeenDragged;b=e.isBeingDragged&&!b;a=da(a,"changedTouches");if(!e.hasBeenDragged&&!b){if(!E){H(e);N(a)}}else{P||s(La);s(H);H(e);Ma(a);s(M,[a]);m[e.id]=e;M(e,a);e.ondragend({domEvent:a,draggableList:m});e&&N(a)}}}function La(a){var b=a.x,c=a.y;if(b<a.minX)a.moveToX(a.minX);else b>a.maxX&&a.moveToX(a.maxX);if(c<a.minY)a.moveToY(a.minY);else c>a.maxY&&a.moveToY(a.maxY)}function s(a,b,c){if(A||c){var d;b=b||[];b.unshift(0);for(d in m){c=b[0]=
m[d];a.apply(c,b)}}}function ka(a){if(e){a=a||event;if(a.keyCode==27||a.type==="touchcancel")e.release(a)}}function Ja(a,b,c,d){c={x:c,y:d};d=0;for(var f=t.length,g={domEvent:b,dragObj:a};d<f;d++){a=t[d];b=a.containsCoords(c);if(!a.hasDropTargetOver&&b){a.hasDropTargetOver=true;typeof a.ondragover==o&&a.ondragover(g);a.dragOverClassName&&i.addClass(a.el,a.dragOverClassName)}else if(a.hasDropTargetOver&&!b){typeof a.ondragout==o&&a.ondragout(g);a.dragOverClassName&&i.removeClass(a.el,a.dragOverClassName);
a.hasDropTargetOver=false}}}function Ma(a){var b=e.dropTargets,c,d,f=b.length,g,h;if(f){d=K(a);for(g=0;g<f;g++){c=b[g];if(typeof c.ondrop===o&&c.containsCoords(d)){c.ondrop(la(a,e));s(Na,[c,a])}(h=c.dragOverClassName)&&i.removeClass(c.el,h)}}}function la(a,b){return{domEvent:a,dragObj:b}}function Na(a,b,c){a.id!==b.id&&b.ondrop(la(c,a))}function da(a,b){return a&&a[b]&&a[b][0]||a||event}function Oa(a){var b=w.anim,c=new b.Animation(0.2);c.transition=b.Transitions.accel;c.run=Pa;c.dObj=a;c.onplay=
a.onglide;c.onend=Qa;c.start()}function Pa(a){var b=this.dObj,c=b.x-b.grabX,d=b.y-b.grabY;a=Math.pow(a,3);b.moveToX(b.x-c*a);b.moveToY(b.y-d*a)}function Qa(){ma(this.dObj)}function ma(a){typeof a.onglideend==o&&a.onglideend();H(a)}function Y(a){if(w.anim&&a.useAnim)Oa(a);else{a.moveToX(a.grabX);a.moveToY(a.grabY);typeof a.onglide==o&&a.onglide();ma(a,{})}}var q=document,F=w.EventPublisher,z=F.add,S=J.preventDefault,X="documentElement",y=q[X].style,U="px",na="left",oa="top",E=false,Z="setCapture"in
document.documentElement,ea=0,fa=0,e,t=false,A=false,P=false,Ha=25,ga=-1,pa="onmousedown",G="onmousemove",qa="onmouseup",Q,L,K=J.getCoords;if("ontouchstart"in q){Q=true;pa="ontouchstart";G="ontouchmove";qa="ontouchend";z(q,"ontouchcancel",ka)}L=F.get(q,pa);if("pixelLeft"in y){U=0;na="pixelLeft";oa="pixelTop"}z(q,"onkeydown",ka);z(q,qa,Ka);j(q,y);L.add(Da).addAfter(Fa);q=y=null;return{dragCopy:false,useAnim:true,dragMultiple:false,selectedClassName:"",activeDragClassName:"",useHandleTree:true,isSelected:false,
onbeforedrag:D,onbeforedragstart:B,ondragstart:D,ondrag:D,ondragstop:B,ondragend:B,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,keepInContainer:false,isDragEnabled:true,hasHandleSet:false,setHandle:function(a,b){this.handle=a;this.hasHandleSet=true;this.useHandleTree=b!=false},dropTargets:false,addDropTarget:function(a){a=V.getByNode(a);var b=a.el,c=this.dropTargets;if(this.el===b)return a;return c[c.length]=V.getByNode(b)},grab:function(a,b,c){a=a||window.event;var d=J.getTarget(a);S(a);if(!i.contains(this.el,
d)){d=i.getPixelCoords(this.el);this.grabX=d.x;this.grabY=d.y;var f=K(a);d=this.handle;var g=i.getOffsetCoords(i.getContainingBlock(this.el)),h=f.x-g.x;h=h-(0|d.offsetWidth/2);f=f.y-g.y;f=f-(0|d.offsetHeight/2);d=i.getOffsetCoords(d,this.el);if(this.keepInContainer){h=Math.max(h,0);h=Math.min(h,this.container.clientWidth-this.el.offsetWidth);f=Math.max(f,0);f=Math.min(f,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(h-d.x+(b||0));this.moveToY(f-d.y+(c||0));R(this,a);I=true;e=this}},
release:function(a){a=a||{};s(M,[a]);typeof this.onrelease==o&&this.onrelease(a);wa(a);N(a)},moveToX:function(a){this.style[na]=(this.x=a)+U},moveToY:function(a){this.style[oa]=(this.y=a)+U},removeDropTarget:function(a){a=document.getElementById(a.id);var b=this.dropTargets,c,d;c=0;for(d=b.length;c<d;c++)if(b[c].el===a){b.splice(c,1);return a}return null},toString:function(){return"Draggable(id="+this.id+")"}}}function Ra(j){this.el=document.getElementById(j);this.id=j}function Sa(){return{dragOverClassName:"",
initCoords:function(){var j=this.coords||(this.coords={}),k=this.el;i.getOffsetCoords(k,document,j);j.w=k.clientWidth;j.h=k.clientHeight},containsCoords:function(j){var k=this.coords,l=k.x,n=k.y;return j.x>=l&&j.x<=l+k.w&&j.y>=n&&j.y<=n+k.h},ondragover:false,ondragout:D,ondrop:D}}var w=self.APE,i=w.dom,u=i.getStyle,ra=w.drag,J=i.Event,W=1E3,m={},D,B=Function.prototype,x=self.parseInt,I,o="function",T=w.createFactory(sa,va),V=w.createFactory(Ra,Sa);ra.Draggable=T;ra.DropTarget=V;T.instanceDestructor=
ua})();
