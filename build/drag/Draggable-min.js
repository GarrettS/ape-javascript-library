APE.namespace("APE.drag");
(function(){function ta(i,k){var l=document,n=l.getElementById(i),p;this.id=i;this.el=this.origEl=n;this.style=n.style;i=(this.isRel=u(n,"position").toLowerCase()=="relative")?n.parentNode:h.getContainingBlock(n);if(i===null)i=l.documentElement;this.container=i;this.dropTargets=[];this.handle=n;this.onbeforeexitcontainer=ua;if(k){for(p in k)this[p]=k[p];n.style.zIndex=x(u(n,"zIndex"),10)||X++}}function ua(){return!this.keepInContainer}function va(){var i,k,l;for(i in this.instances){l=this.instances[i];
for(k in l)delete l[k];delete this.instances[i]}m={}}function wa(){function i(){function a(g){var j=!e;if(f)this[Y].style[f]=j?"":"none";else(g||window.event||0).returnValue=j}var b="serSelect",c="MozU"+b,d="MozU"+b;b="u"+b;var f=c in y?c:d in y?d:b in y?b:"";c="onselectstart";c in q?z(q,c,a):M.addAfter(a)}function k(a,b){return b===a.handle||a.useHandleTree&&h.contains(a.handle,b)}function l(a,b){if(b){a.selectedClassName&&h.addClass(a.el,a.selectedClassName);if(a.dragMultiple&&!(a.id in m))m[a.id]=
a}else{a.selectedClassName&&h.removeClass(a.el,a.selectedClassName);delete m[a.id]}a.isSelected=b}function n(a){var b=a.container,c=a.el,d=document,f=d.documentElement;f=h.getContainingBlock(c)||f;var g=f===b?{x:0,y:0}:h.getOffsetCoords(f,b),j=h.getPixelCoords(c),r=h.getOffsetCoords(c,c.parentNode);f=r.x-j.x+g.x;g=r.y-j.y+g.y;if(a.keepInContainer){if(b===d.body){d=x(u(b,"width"),10);b=x(u(b,"height"),10)}else{d=b.clientWidth;b=b.clientHeight}a.minX=0-f;a.maxX=d-c.offsetWidth-f;a.minY=0-g;a.maxY=b-
c.offsetHeight-g}}function p(){s(l,[false],true);A=false}function xa(a){Z(e);var b,c,d;if(t!==false){c=0;for(d=t.length;c<d;c++){b=t[c];if(b.hasDropTargetOver){typeof b.ondragout==o&&b.ondragout(a,e);b.dragOverClassName&&h.removeClass(b.el,b.dragOverClassName);b.hasDropTargetOver=false}}}s(Z)}function N(a){a.activeDragClassName&&h.removeClass(a.el,a.activeDragClassName);ya(a);$&&a.el.releaseCapture();a.hasBeenDragged=false}function O(){if(e.hasBeenDragged)if(e.dragMultiple)m[e.id]=e;else m={};F=false;
G.remove(document,H,P);e=null}function za(a,b){if(b)a.id in m?l(a,false):l(a,true);else if(!a.isSelected){p();l(a,true)}}function aa(a){var b=a.el,c=a.copyEl;if(!c)c=a.copyEl=document.getElementById(a.proxyId);ba(a,c,b)}function Aa(a){if(!a.copyEl){a.copyEl=a.el.cloneNode(true);a.copyEl.id+="Copy"}ba(a,a.copyEl,a.el)}function ba(a,b,c){var d=b.style;a.origEl=c;d.zIndex=x(c.style.zIndex,10)+100;a.el=b;a.style=d;var f=u(c,"display");d.display=f;if(a.dragCopy){c.parentNode.insertBefore(b,c);a.isRel&&
Ba(d,c,f)}else Ca(a,b,c)}function Ca(a,b,c){b=h.getOffsetCoords(c,b.parentNode);a.moveToX(b.x);a.moveToY(b.y)}function Ba(a,b,c){if(c=="inline")a.marginRight=-b.offsetWidth+-(x(u(b,"marginRight"),10)||0)+"px";else a.marginBottom=-b.offsetHeight+-(x(u(b,"marginBottom"),10)||0)+"px"}function I(a){var b=a.copyEl;if(b){a.el=a.origEl;a.style=a.el.style;a.moveToX(a.x);a.moveToY(a.y);b.style.display="none";a.dragCopy&&!a.proxyId&&a.el.parentNode.insertBefore(b,a.el)}}function v(a,b){!A||Q||s(Da,[a,b])}function Da(a,
b,c){typeof b=="number"&&a.moveToX(a.origX+b);typeof c=="number"&&a.moveToY(a.origY+c)}function ca(a,b){if(!a.isBeingDragged){a.dragCopy&&!a.proxyId&&Aa(a);typeof a.ondragstart==o&&a.ondragstart(da(a,b));$&&a.el.setCapture();a.activeDragClassName&&h.addClass(a.el,a.activeDragClassName);n(a);a.isBeingDragged=true}}function da(a,b){var c=a.id,d={},f=1;d[c]=a;if(A)for(c in m){d[c]=m[c];f++}return{domEvent:b,draggableList:d,count:f}}function Ea(a){if(J)J=false;else{var b=a||window.event;if(!(R&&e)){a=
ea(a,"touches");var c=K.getTarget(b),d=a.metaKey||a.ctrlKey,f=Fa(c);if(f){if(!f.isDragEnabled){d||p();return false}if(!d&&f.hasHandleSet&&!k(f,c))p();else{!d&&!f.isSelected&&p();a.returnValue=false;if(d&&e&&!f.dragMultiple){F=true;return false}if(!f.dragMultiple)if(d){F=true;return false}else p();za(f,d);f.style.zIndex=++X;if(S(f,a)!=false){e=f;T(b);s(S,[a]);return c.tagName!=="IMG"}}}else if(!d){p();if(e){l(e,false);e=null}}}}}function Fa(a){for(var b,c=U.instances;!b&&a!==null;a=h.findAncestorWithAttribute(a,
"id"))b=c[a.id];return b}function Ga(){if(e){var a=e.dropTargets,b,c,d,f;if(!a)return t=false;t=[];c=d=0;for(f=a.length;c<f;c++){b=a[c];b.initCoords();if(b.ondragover||b.ondragout||b.dragOverClassName)t[d++]=b}if(d===0)t=false}}function S(a,b){if(typeof a.onbeforedragstart==o&&a.onbeforedragstart(da(a,b))==false)return false;b=L(b);a.proxyId&&!a.dragCopy&&aa(a);Ha(a);fa=b.x;ga=b.y;b=h.getPixelCoords(a.el);a.origX=a.grabX=b.x;a.origY=a.grabY=b.y;a.isBeingDragged=false;z(document,H,P)}function Ha(a){var b=
a.constraint;if(b==="y")a.moveToX=B;else if(b==="x")a.moveToY=B}function ya(a){delete a.moveToX;delete a.moveToY}function P(a){if(e){var b=+new Date;if(!(b-ha<Ia)){ha=b;b=a=a||event;if(R){a=a.touches&&a.touches[0];if(!a)return;T(b)}var c=L(a);b=c.x;c=c.y;var d=b-fa,f=c-ga,g=e.origX+d,j=e.origY+f,r;if(e.isBeingDragged===false){Q=!!e.proxyId;for(r in m){A=true;break}delete m[e.id];ca(e,a);e.proxyId&&e.dragCopy&&aa(e);s(ca,[a])}e.hasBeenDragged=e.hasBeenDragged||!!(d||f);if(!(typeof e.onbeforedrag==
o&&e.onbeforedrag(a)==false)){r=typeof e.ondrag===o;if(!Ja(e,g,j,d,f,r,a)){e.isAtLeft=e.isAtRight=e.isAtTop=e.isAtBottom=false;e.moveToX(g);e.moveToY(j);v(d,f);r&&e.ondrag(a)}t!==false&&Ka(e,a,b,c);return false}}}}function Ja(a,b,c,d,f,g,j){if(a.container){var r=b<a.minX,ia=b>a.maxX,ja=c<a.minY,ka=c>a.maxY,C,D;if(r||ia||ja||ka&&a.onbeforeexitcontainer()!=true){if(r){if(!a.isAtLeft){a.moveToX(a.minX);v(a.minX-a.origX,null);D=g;a.isAtRight=false;a.isAtLeft=true}C=true}else if(ia){if(!a.isAtRight){a.moveToX(a.maxX);
v(a.maxX-a.origX,null);D=g;a.isAtRight=true;a.isAtLeft=false}C=true}else{a.isAtLeft=a.isAtRight=false;a.moveToX(b);v(d,null)}if(ja){if(!a.isAtTop){a.moveToY(a.minY);v(null,a.minY-a.origY);D=g;a.isAtTop=true;a.isAtBottom=false}C=true}else if(ka){if(!a.isAtBottom){a.maxY>0&&a.moveToY(a.maxY);v(null,a.maxY-a.origY);D=g;a.isAtTop=false;a.isAtBottom=true}C=true}else{a.isAtTop=a.isAtBottom=false;a.moveToY(c);v(null,f)}a[C&&!D?"ondragstop":"ondrag"](j);return true}}return false}function La(a){J=false;G.remove(document,
H,P);if(e){var b=e.hasBeenDragged;b=e.isBeingDragged&&!b;a=ea(a,"changedTouches");if(!e.hasBeenDragged&&!b){if(!F){I(e);O(a)}}else{Q||s(Ma);s(I);I(e);Na(a);s(N,[a]);m[e.id]=e;N(e,a);e.ondragend({domEvent:a,draggableList:m});e&&O(a)}}}function Ma(a){var b=a.x,c=a.y;if(b<a.minX)a.moveToX(a.minX);else b>a.maxX&&a.moveToX(a.maxX);if(c<a.minY)a.moveToY(a.minY);else c>a.maxY&&a.moveToY(a.maxY)}function s(a,b,c){if(A||c){var d;b=b||[];b.unshift(0);for(d in m){c=b[0]=m[d];a.apply(c,b)}}}function la(a){if(e){a=
a||event;if(a.keyCode==27||a.type==="touchcancel")e.release(a)}}function Ka(a,b,c,d){c={x:c,y:d};d=0;for(var f=t.length,g={domEvent:b,dragObj:a};d<f;d++){a=t[d];b=a.containsCoords(c);if(!a.hasDropTargetOver&&b){a.hasDropTargetOver=true;typeof a.ondragover==o&&a.ondragover(g);a.dragOverClassName&&h.addClass(a.el,a.dragOverClassName)}else if(a.hasDropTargetOver&&!b){typeof a.ondragout==o&&a.ondragout(g);a.dragOverClassName&&h.removeClass(a.el,a.dragOverClassName);a.hasDropTargetOver=false}}}function Na(a){var b=
e.dropTargets,c,d,f=b.length,g,j;if(f){d=L(a);for(g=0;g<f;g++){c=b[g];if(typeof c.ondrop===o&&c.containsCoords(d)){c.ondrop(ma(a,e));s(Oa,[c,a])}(j=c.dragOverClassName)&&h.removeClass(c.el,j)}}}function ma(a,b){return{domEvent:a,dragObj:b}}function Oa(a,b,c){a.id!==b.id&&b.ondrop(ma(c,a))}function ea(a,b){return a&&a[b]&&a[b][0]||a||event}function Pa(a){var b=w.anim,c=new b.Animation(0.2);c.transition=b.Transitions.accel;c.run=Qa;c.dObj=a;c.onplay=a.onglide;c.onend=Ra;c.start()}function Qa(a){var b=
this.dObj,c=b.x-b.grabX,d=b.y-b.grabY;a=Math.pow(a,3);b.moveToX(b.x-c*a);b.moveToY(b.y-d*a)}function Ra(){na(this.dObj)}function na(a){typeof a.onglideend==o&&a.onglideend();I(a)}function Z(a){if(w.anim&&a.useAnim)Pa(a);else{a.moveToX(a.grabX);a.moveToY(a.grabY);typeof a.onglide==o&&a.onglide();na(a,{})}}var q=document,G=w.EventPublisher,z=G.add,T=K.preventDefault,Y="documentElement",y=q[Y].style,V="px",oa="left",pa="top",F=false,$="setCapture"in document.documentElement,fa=0,ga=0,e,t=false,A=false,
Q=false,Ia=25,ha=-1,qa="onmousedown",H="onmousemove",ra="onmouseup",R,M,L=K.getCoords;if("ontouchstart"in q){R=true;qa="ontouchstart";H="ontouchmove";ra="ontouchend";z(q,"ontouchcancel",la)}M=G.get(q,qa);if("pixelLeft"in y){V=0;oa="pixelLeft";pa="pixelTop"}z(q,"onkeydown",la);z(q,ra,La);i(q,y);M.add(Ea).addAfter(Ga);q=y=null;return{dragCopy:false,useAnim:true,dragMultiple:false,selectedClassName:"",activeDragClassName:"",useHandleTree:true,isSelected:false,onbeforedrag:E,onbeforedragstart:B,ondragstart:E,
ondrag:E,ondragstop:B,ondragend:B,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,keepInContainer:false,isDragEnabled:true,hasHandleSet:false,setHandle:function(a,b){this.handle=a;this.hasHandleSet=true;this.useHandleTree=b!=false},dropTargets:false,addDropTarget:function(a){a=W.getByNode(a);var b=a.el,c=this.dropTargets;if(this.el===b)return a;return c[c.length]=W.getByNode(b)},grab:function(a,b,c){a=a||window.event;var d=K.getTarget(a);T(a);if(!h.contains(this.el,d)){d=h.getPixelCoords(this.el);this.grabX=
d.x;this.grabY=d.y;var f=L(a);d=this.handle;var g=h.getOffsetCoords(h.getContainingBlock(this.el)),j=f.x-g.x;j=j-(0|d.offsetWidth/2);f=f.y-g.y;f=f-(0|d.offsetHeight/2);d=h.getOffsetCoords(d,this.el);if(this.keepInContainer){j=Math.max(j,0);j=Math.min(j,this.container.clientWidth-this.el.offsetWidth);f=Math.max(f,0);f=Math.min(f,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(j-d.x+(b||0));this.moveToY(f-d.y+(c||0));S(this,a);J=true;e=this}},release:function(a){a=a||{};s(N,[a]);typeof this.onrelease==
o&&this.onrelease(a);xa(a);O(a)},moveToX:function(a){this.style[oa]=(this.x=a)+V},moveToY:function(a){this.style[pa]=(this.y=a)+V},removeDropTarget:function(a){a=document.getElementById(a.id);var b=this.dropTargets,c,d;c=0;for(d=b.length;c<d;c++)if(b[c].el===a){b.splice(c,1);return a}return null},toString:function(){return"Draggable(id="+this.id+")"}}}function Sa(i){this.el=document.getElementById(i);this.id=i}function Ta(){return{dragOverClassName:"",initCoords:function(){var i=this.coords||(this.coords=
{}),k=this.el;h.getOffsetCoords(k,document,i);i.w=k.clientWidth;i.h=k.clientHeight},containsCoords:function(i){var k=this.coords,l=k.x,n=k.y;return i.x>=l&&i.x<=l+k.w&&i.y>=n&&i.y<=n+k.h},ondragover:false,ondragout:E,ondrop:E}}var w=self.APE,h=w.dom,u=h.getStyle,sa=w.drag,K=h.Event,X=1E3,m={},E,B=Function.prototype,x=self.parseInt,J,o="function",U=w.createFactory(ta,wa),W=w.createFactory(Sa,Ta);sa.Draggable=U;sa.DropTarget=W;U.instanceDestructor=va})();
