APE.namespace("APE.drag");(function(){var K=self.APE,N=K.dom,M=K.drag,C=K.EventPublisher,R=N.Event,P=1000,Q={},B,L,G="function",F=K.createFactory(A,E),D=K.createFactory(H,O);M.Draggable=F;M.DropTarget=D;F.instanceDestructor=J;function A(X,S){var V=document,T=V.getElementById(X),U;this.id=X;this.el=this.origEl=T;this.style=T.style;this.isRel=N.getStyle(T,"position").toLowerCase()=="relative";var W=(this.isRel?T.parentNode:N.getContainingBlock(T));if(W===null){W=V.documentElement}this.container=W;this.dropTargets=[];this.handle=T;this.onbeforeexitcontainer=I;for(U in S){this[U]=S[U]}T.style.zIndex=parseInt(N.getStyle(T,"zIndex"),10)||P++}function I(){return !this.keepInContainer}function J(){var S,U,T;for(S in this.instances){T=this.instances[S];for(U in T){delete T[U]}delete this.instances[S]}Q={}}function E(){var AJ=self.document,AB="documentElement",b=AJ[AB].style,x="serSelect",AK="MozU"+x,k="MozU"+x,AA="u"+x,r=AK in b?AK:k in b?k:AA in b?AA:"",a="px",e="left",o="top",AH=false,X=0,W=0,z,s=false,S=false,j=25,u=-1,w=C.get(AJ,"onmousedown");getEventCoords=R.getCoords;if("onselectstart" in AJ){C.add(AJ,"onselectstart",g)}else{w.addAfter(g)}if("pixelLeft" in b){a=0;e="pixelLeft";o="pixelTop"}w.add(h).addAfter(Y);C.add(AJ,"onkeydown",t);C.add(AJ,"onmousemove",q);C.add(AJ,"onmouseup",Z);AJ=b=null;function g(AM){var d=!z;if(r){this[AB].style[r]=d?"":"none"}else{if(!AM){self.event.returnValue=d}}}function AE(d,AM){return AM===d.handle||(d.useHandleTree&&N.contains(d.handle,AM))}function AG(d,AM){if(AM){if(d.selectedClassName){N.addClass(d.el,d.selectedClassName)}if(d.dragMultiple&&!(d.id in Q)){Q[d.id]=d}}else{if(d.selectedClassName){N.removeClass(d.el,d.selectedClassName)}delete Q[d.id]}d.isSelected=AM}function m(AT,AS){var AM=AS.container,AP=AS.el,AV=document,AO=AV.documentElement,AR=N.getContainingBlock(AP)||AO,AQ,AU,AY=(AR===AM)?{x:0,y:0}:N.getOffsetCoords(AR,AM),AN=N.getPixelCoords(AP),AZ=N.getOffsetCoords(AP,AP.parentNode),AX=AZ.x-AN.x+AY.x,AW=AZ.y-AN.y+AY.y;if(AS.keepInContainer){if(AM===AV.body){AQ=parseInt(N.getStyle(AM,"width"),10);AU=parseInt(N.getStyle(AM,"height"),10)}else{AQ=AM.clientWidth;AU=AM.clientHeight}AS.minX=0-AX;AS.maxX=AQ-AP.offsetWidth-AX;AS.minY=0-AW;AS.maxY=AU-AP.offsetHeight-AW}}function y(){for(var d in Q){AG(Q[d],false)}S=false}function U(AP,d){v(d);var AQ=N.removeClass,AO,AN,AM,AR;if(s!==false){for(AN=0,AM=s.length;AN<AM;AN++){AO=s[AN];if(AO.hasDropTargetOver){if(typeof AO.ondragout==G){AO.ondragout(AP,d)}if(AO.dragOverClassName){AQ(AO.el,AO.dragOverClassName)}AO.hasDropTargetOver=false}}}for(AR in Q){v(Q[AR])}z=null}function V(d,AM){if(d.activeDragClassName){N.removeClass(d.el,d.activeDragClassName)}if(typeof d.ondragend==G&&d.hasBeenDragged){d.ondragend(AM)}if(d.copyEl){d.el.parentNode.insertBefore(d.copyEl,d.el)}d.hasBeenDragged=false}function f(d,AM){if(AM){if(d.id in Q){AG(d,false)}else{AG(d,true)}}else{if(!d.isSelected){y();AG(d,true)}}}function AC(AM){var AO="addClass",AQ,AN=AM.el,AP=AN,d;if(!AM.copyEl){AM.origEl=AN;AM.copyEl=AN.cloneNode(true);AM.copyEl.id+="Copy"}AQ=AM.copyEl;d=AQ.style;d.display="";if(AQ.parentNode!==AN.parentNode){AN.parentNode.insertBefore(AQ,AN)}d.zIndex=parseInt(AP.style.zIndex,10)+100;if(AM.origClassName){N[AO](AN,AM.origClassName)}AM.el=AQ;AM.style=d;if(AM.isRel){d.marginBottom=-AP.offsetHeight+-(parseInt(N.getStyle(AP,"marginBottom"),10)||0)+"px";d.marginright=-AP.offsetWidth+-(parseInt(N.getStyle(AP,"marginRight"),10)||0)+"px"}}function AL(d){if(d.copyEl.style.display=="none"){return}d.el=d.origEl;d.style=d.origEl.style;d.moveToX(d.x);d.moveToY(d.y);d.copyEl.style.display="none";if(d.origClassName){N.removeClass(d.el,d.origClassName)}}function AF(AM,d){if(!S){return}var AN,AO;for(AO in Q){AN=Q[AO];if(typeof AM=="number"){AN.moveToX(AN.origX+AM)}if(typeof d=="number"){AN.moveToY(AN.origY+d)}}}function c(d,AM){if(d.isBeingDragged){return}if(d.dragCopy){AC(d)}if(typeof d.ondragstart==G){d.ondragstart(AM)}if(d.activeDragClassName){N.addClass(d.el,d.activeDragClassName)}m(AM,d);d.isBeingDragged=true}function h(AP){if(L){L=false;return}AP=AP||self.event;var AO=R.getTarget(AP),AN=F.instances,AM,d=AO,AQ=AP.metaKey||AP.ctrlKey;while(!AM&&d!==null){AM=AN[d.id];d=N.findAncestorWithAttribute(d,"id")}if(AM){if(!AM.isDragEnabled){if(!AQ){y()}return false}if(!AQ&&AM.hasHandleSet&&!AE(AM,AO)){y();AM=null;return}else{if(!AQ&&!AM.isSelected){y()}AP.returnValue=false}}else{if(!AQ){y();if(z){AG(z,false);z=null}}return}if(AQ&&z&&!AM.dragMultiple){AH=true;return false}if(!AM.dragMultiple){if(!AQ){y()}else{AH=true;return false}}f(AM,AQ);AM.style.zIndex=++P;if(AQ){}z=AM;AI(AP,AM);for(var AR in Q){AI(AP,Q[AR])}return AO.tagName!=="IMG"}function Y(){if(!z){return}s=[];var AO=z.dropTargets,AN,AM=0,d=AO.length;for(;AM<d;AM++){AN=AO[AM];AN.initCoords();if(typeof AN.ondragover==G||typeof AN.ondragout==G||AN.dragOverClassName){s.push(AN)}}if(s.length===0){s=false}}function AI(AO,d){if(typeof d.onbeforedragstart==G&&d.onbeforedragstart(AO)==false){return true}var AN=getEventCoords(AO),AM;X=AN.x;W=AN.y;AM=N.getPixelCoords(d.el);d.origX=d.grabX=AM.x;d.origY=d.grabY=AM.y;d.isBeingDragged=false}function q(AY){if(!z){return}var AO=+new Date;if(AO-u<j){return}u=AO;AY=AY||self.event;var AR=getEventCoords(AY),AX=AR.x,AU=AR.y,AT=AX-X,AS=AU-W,AQ=false,Aa=z.origX+AT,AZ=z.origY+AS,AV;if(z.isBeingDragged===false){c(z,AY);delete Q[z.id];for(AV in Q){S=true;c(Q[AV],AY)}}z.hasBeenDragged=(z.hasBeenDragged||(AT||AS));var AP=Aa<z.minX,AN=Aa>z.maxX,Ac=AZ<z.minY,AW=AZ>z.maxY,AM=z.container!=null,Ad=(typeof z.ondrag==G),d=typeof z.onbeforeexitcontainer==G,Ab=0;if(typeof z.onbeforedrag==G&&z.onbeforedrag(AY)==false){return}AM&=(AP||AN||Ac||AW);if(AM&&(d||z.onbeforeexitcontainer()==false)){if(AP){if(!z.isAtLeft){z.moveToX(z.minX);AF(z.minX-z.origX,null);if(Ad){z.ondrag(AY)}z.isAtRight=false;z.isAtLeft=true}Ab+=1}else{if(AN){if(!z.isAtRight){z.moveToX(z.maxX);AF(z.maxX-z.origX,null);if(Ad){z.ondrag(AY)}z.isAtRight=true;z.isAtLeft=false}Ab+=1}else{z.isAtLeft=z.isAtRight=false;z.moveToX(Aa);AF(AT,null)}}if(Ac){if(!z.isAtTop){z.moveToY(z.minY);AF(null,z.minY-z.origY);if(Ad){z.ondrag(AY)}z.isAtTop=true;z.isAtBottom=false}Ab+=1}else{if(AW){if(!z.isAtBottom){if(z.maxY>0){z.moveToY(z.maxY)}AF(null,z.maxY-z.origY);if(Ad){z.ondrag(AY)}z.isAtTop=false;z.isAtBottom=true}Ab+=1}else{z.isAtTop=z.isAtBottom=false;z.moveToY(AZ);AF(null,AS)}}AQ=Ab==2;if(AQ&&typeof z.ondragstop==G){z.ondragstop(AY)}else{if(Ad){z.ondrag(AY)}}}else{z.isAtLeft=z.isAtRight=z.isAtTop=z.isAtBottom=false;z.moveToX(Aa);z.moveToY(AZ);AF(AT,AS);if(Ad){z.ondrag(AY)}}if(s!==false){p(z,AY,AX,AU)}return false}function Z(AN){L=false;if(!z){return}var AR=(z.isBeingDragged&&!z.hasBeenDragged),AQ,AM,AO,d,AP;if(!z.hasBeenDragged&&!AR){if(!AH){z=null}return}Q[z.id]=z;AH=false;if(z.copyEl){AL(z)}if(S){for(AQ in Q){AM=Q[AQ];if(AM.copyEl){AL(AM)}}}AN=AN||self.event;i(AN);if(S){for(AQ in Q){AO=Q[AQ];d=AO.x;AP=AO.y;if(d<AO.minX){AO.moveToX(AO.minX)}else{if(d>AO.maxX){AO.moveToX(AO.maxX)}}if(AP<AO.minY){AO.moveToY(AO.minY)}else{if(AP>AO.maxY){AO.moveToY(AO.maxY)}}if(AO.hasBeenDragged){V(AO,AN)}}}V(z,AN);z=null}function t(d){d=d||self.event;if(d.keyCode==27){if(z){z.release(d)}}}function p(AT,AR,AN,d){var AU={x:AN,y:d},AQ=0,AP=s.length,AM,AO,AS={domEvent:AR,dragObj:AT};for(;AQ<AP;AQ++){AM=s[AQ];AO=AM.containsCoords(AU);if(!AM.hasDropTargetOver&&AO){AM.hasDropTargetOver=true;if(typeof AM.ondragover==G){AM.ondragover(AS)}if(AM.dragOverClassName){N.addClass(AM.el,AM.dragOverClassName)}}else{if(AM.hasDropTargetOver&&!AO){if(typeof AM.ondragout==G){AM.ondragout(AS)}if(AM.dragOverClassName){N.removeClass(AM.el,AM.dragOverClassName)}AM.hasDropTargetOver=false}}}}function i(AO){var AM=z.dropTargets,AS,AP,d=AM.length,AN,AR,AQ;if(d>0){AP=getEventCoords(AO);for(AN=0;AN<d;AN++){AS=AM[AN];if(AS.containsCoords(AP)){if(typeof AS.ondrop==G){AS.ondrop({domEvent:AO,dragObj:z,dropTarget:AS})}if(S){for(AR in Q){if(AR===AS.id){continue}if(typeof AS.ondrop==G){AQ=Q[AR];AS.ondrop({domEvent:AO,dragObj:AQ,dropTarget:AS})}}}if(AS.dragOverClassName){N.removeClass(AS.el,AS.dragOverClassName)}break}}}}function l(AM){var AN=K.anim;AM.startX=AM.x;AM.startY=AM.y;var d=new AN.Animation(0.2);d.transition=AN.Transitions.accel;d.run=n;d.dObj=AM;d.onplay=AM.onglide;d.onend=T;d.start()}function n(AO){var AM=this.dObj,AN=AM.startX-AM.grabX,d=AM.startY-AM.grabY;AO=Math.pow(AO,3);AM.moveToX(AM.startX-(AN*AO));AM.moveToY(AM.startY-(d*AO))}function T(){AD(this.dObj)}function AD(d){if(typeof d.onglideend==G){d.onglideend()}if(d.copyEl){d.el=d.origEl;d.style=d.origEl.style;d.copyEl.style.display="none"}V(d,{})}function v(d){if(K.anim&&d.useAnim){l(d)}else{d.moveToX(d.grabX);d.moveToY(d.grabY);if(typeof d.onglide==G){d.onglide()}AD(d,{})}}return{dragCopy:false,useAnim:true,dragMultiple:false,selectedClassName:"",activeDragClassName:"",useHandleTree:true,isSelected:false,onbeforedrag:B,onbeforedragstart:B,ondragstart:B,ondrag:B,ondragstop:B,ondragend:B,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,keepInContainer:false,isDragEnabled:true,hasHandleSet:false,setHandle:function(d,AM){this.handle=d;this.hasHandleSet=true;this.useHandleTree=AM!=false},addDropTarget:function(AO){var AM=D.getByNode(AO),d=AM.el,AN=this.dropTargets;if(this.el===d){return AM}return AN[AN.length]=D.getByNode(d)},grab:function(AS,AU,AO){AS=AS||self.event;var AT=R.getTarget(AS),AN;if(AS.preventDefault){AS.preventDefault()}else{AS.returnValue=false}if(N.contains(this.el,AT)){return}AN=N.getPixelCoords(this.el);this.grabX=AN.x;this.grabY=AN.y;var AV=getEventCoords(AS),AR=this.handle,AM=N.getOffsetCoords(N.getContainingBlock(this.el)),AQ=AV.x-AM.x,d=AQ-(0|AR.offsetWidth/2),AP=AV.y-AM.y,AX=(AP-(0|AR.offsetHeight/2)),AW=N.getOffsetCoords(AR,this.el);if(this.keepInContainer){d=Math.max(d,0);d=Math.min(d,this.container.clientWidth-this.el.offsetWidth);AX=Math.max(AX,0);AX=Math.min(AX,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(d-AW.x+(AU||0));this.moveToY(AX-AW.y+(AO||0));AI(AS,this);L=true;z=this},release:function(d){U(d,this);if(typeof this.onrelease==G){this.onrelease(d)}if(this.dragMultiple){Q[this.id]=this}},moveToX:function(d){this.style[e]=(this.x=d)+a},moveToY:function(d){this.style[o]=(this.y=d)+a},removeDropTarget:function(AO){var AO=document.getElementById(AO.id),AM=this.dropTargets,AN,d;for(AN=0,d=AM.length;AN<d;AN++){if(AM[AN].el===AO){AM.splice(AN,1);return AO}}return null},toString:function(){return"Draggable(id="+this.id+")"}}}function H(S){this.el=document.getElementById(S);this.id=S}function O(){return{dragOverClassName:"",initCoords:function(){this.coords=this.coords||{};N.getOffsetCoords(this.el,document,this.coords);this.coords.w=this.el.clientWidth;this.coords.h=this.el.clientHeight},containsCoords:function(S){var U=this.coords.x,T=this.coords.y;return(S.x>=U&&S.x<=U+this.coords.w)&&(S.y>=T&&S.y<=T+this.coords.h)},ondragover:false,ondragout:B,ondrop:B}}})();