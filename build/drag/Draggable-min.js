APE.namespace("APE.drag");(function(){var K=self.APE,N=K.dom,M=K.drag,R=N.Event,P=1000,Q={},B,I=self.parseInt,L,F="function",E=K.createFactory(A,D),C=K.createFactory(G,O);M.Draggable=E;M.DropTarget=C;E.instanceDestructor=J;function A(Z,S){var X=document,T=X.getElementById(Z),W,U=Function.prototype,V;this.id=Z;this.el=this.origEl=T;this.style=T.style;this.isRel=N.getStyle(T,"position").toLowerCase()=="relative";var Y=(this.isRel?T.parentNode:N.getContainingBlock(T));if(Y===null){Y=X.documentElement}this.container=Y;this.dropTargets=[];this.handle=T;this.onbeforeexitcontainer=H;if(S){for(V in S){this[V]=S[V]}W=S.constraint;if(W=="y"){this.moveToX=U}else{if(W=="x"){this.moveToY=U}}T.style.zIndex=I(N.getStyle(T,"zIndex"),10)||P++}}function H(){return !this.keepInContainer}function J(){var S,U,T;for(S in this.instances){T=this.instances[S];for(U in T){delete T[U]}delete this.instances[S]}Q={}}function D(){var AQ=document,X=K.EventPublisher,AI=R.preventDefault,AG="documentElement",h=AQ[AG].style,AC="serSelect",AT="MozU"+AC,p="MozU"+AC,AF="u"+AC,w=AT in h?AT:p in h?p:AF in h?AF:"",g="px",j="left",t="top",AO=false,a=0,Z=0,AE,x=false,U=false,o=25,y=-1,f="onmousedown",S="onmousemove",AR="onmouseup",AA,AB;getEventCoords=R.getCoords;if("ontouchstart" in AQ){AA=true;f="ontouchstart";S="ontouchmove";AR="ontouchend";X.add(AQ,"ontouchcancel",AM)}AB=X.get(AQ,f);if("onselectstart" in AQ){X.add(AQ,"onselectstart",l)}else{AB.addAfter(l)}if("pixelLeft" in h){g=0;j="pixelLeft";t="pixelTop"}AB.add(m).addAfter(c);X.add(AQ,"onkeydown",AM);X.add(AQ,S,v);X.add(self,S,function(d){d.preventDefault()});X.add(AQ,AR,e);AQ=h=null;function l(AV){var d=!AE;if(w){this[AG].style[w]=d?"":"none"}else{AV=AV||event;AV.returnValue=d}}function AK(d,AV){return AV===d.handle||(d.useHandleTree&&N.contains(d.handle,AV))}function AN(d,AV){if(AV){if(d.selectedClassName){N.addClass(d.el,d.selectedClassName)}if(d.dragMultiple&&!(d.id in Q)){Q[d.id]=d}}else{if(d.selectedClassName){N.removeClass(d.el,d.selectedClassName)}delete Q[d.id]}d.isSelected=AV}function r(Ab){var AV=Ab.container,AY=Ab.el,Ac=document,AX=Ac.documentElement,Aa=N.getContainingBlock(AY)||AX,AZ,Ad,Ag=(Aa===AV)?{x:0,y:0}:N.getOffsetCoords(Aa,AV),AW=N.getPixelCoords(AY),Ah=N.getOffsetCoords(AY,AY.parentNode),Af=Ah.x-AW.x+Ag.x,Ae=Ah.y-AW.y+Ag.y;if(Ab.keepInContainer){if(AV===Ac.body){AZ=I(N.getStyle(AV,"width"),10);Ad=I(N.getStyle(AV,"height"),10)}else{AZ=AV.clientWidth;Ad=AV.clientHeight}Ab.minX=0-Af;Ab.maxX=AZ-AY.offsetWidth-Af;Ab.minY=0-Ae;Ab.maxY=Ad-AY.offsetHeight-Ae}}function AD(){for(var d in Q){AN(Q[d],false)}U=false}function W(AY,d){z(d);var AZ=N.removeClass,AX,AW,AV,Aa;if(x!==false){for(AW=0,AV=x.length;AW<AV;AW++){AX=x[AW];if(AX.hasDropTargetOver){if(typeof AX.ondragout==F){AX.ondragout(AY,d)}if(AX.dragOverClassName){AZ(AX.el,AX.dragOverClassName)}AX.hasDropTargetOver=false}}}for(Aa in Q){z(Q[Aa])}AE=null}function Y(d,AV){if(d.activeDragClassName){N.removeClass(d.el,d.activeDragClassName)}if(d.copyEl){d.el.parentNode.insertBefore(d.copyEl,d.el)}}function k(d,AV){if(AV){if(d.id in Q){AN(d,false)}else{AN(d,true)}}else{if(!d.isSelected){AD();AN(d,true)}}}function AH(AV){var AX="addClass",AZ,AW=AV.el,AY=AW,d;if(!AV.copyEl){AV.origEl=AW;AV.copyEl=AW.cloneNode(true);AV.copyEl.id+="Copy"}AZ=AV.copyEl;d=AZ.style;d.display="";if(AZ.parentNode!==AW.parentNode){AW.parentNode.insertBefore(AZ,AW)}d.zIndex=I(AY.style.zIndex,10)+100;if(AV.origClassName){N[AX](AW,AV.origClassName)}AV.el=AZ;AV.style=d;if(AV.isRel){d.marginBottom=-AY.offsetHeight+-(I(N.getStyle(AY,"marginBottom"),10)||0)+"px";d.marginright=-AY.offsetWidth+-(I(N.getStyle(AY,"marginRight"),10)||0)+"px"}}function AU(d){if(d.copyEl.style.display=="none"){return}d.el=d.origEl;d.style=d.origEl.style;d.moveToX(d.x);d.moveToY(d.y);d.copyEl.style.display="none";if(d.origClassName){N.removeClass(d.el,d.origClassName)}}function AL(AV,d){if(!U){return}var AW,AX;for(AX in Q){AW=Q[AX];if(typeof AV=="number"){AW.moveToX(AW.origX+AV)}if(typeof d=="number"){AW.moveToY(AW.origY+d)}}}function i(d,AV){if(d.isBeingDragged){return}if(d.dragCopy){AH(d)}if(typeof d.ondragstart==F){d.ondragstart(AV)}if(d.activeDragClassName){N.addClass(d.el,d.activeDragClassName)}r(d);d.isBeingDragged=true}function m(AZ){if(L){L=false;return}d=AZ||event;if(AA&&AE){return}AZ=b(AZ,"touches");var d,AY=R.getTarget(d),AX=E.instances,AW,AV=AY,Aa=AZ.metaKey||AZ.ctrlKey;while(!AW&&AV!==null){AW=AX[AV.id];AV=N.findAncestorWithAttribute(AV,"id")}if(AW){if(!AW.isDragEnabled){if(!Aa){AD()}return false}if(!Aa&&AW.hasHandleSet&&!AK(AW,AY)){AD();AW=null;return}else{if(!Aa&&!AW.isSelected){AD()}AZ.returnValue=false}}else{if(!Aa){AD();if(AE){AN(AE,false);AE=null}}return}if(Aa&&AE&&!AW.dragMultiple){AO=true;return false}if(!AW.dragMultiple){if(!Aa){AD()}else{AO=true;return false}}k(AW,Aa);AW.style.zIndex=++P;AE=AW;AI(d);AP(AZ,AW);for(var Ab in Q){AP(AZ,Q[Ab])}return AY.tagName!=="IMG"}function c(){if(!AE){return}x=[];var AX=AE.dropTargets,AW,AV=0,d=AX.length;for(;AV<d;AV++){AW=AX[AV];AW.initCoords();if(typeof AW.ondragover==F||typeof AW.ondragout==F||AW.dragOverClassName){x.push(AW)}}if(x.length===0){x=false}}function AP(AX,d){if(typeof d.onbeforedragstart==F&&d.onbeforedragstart(AX)==false){return true}var AW=getEventCoords(AX),AV;a=AW.x;Z=AW.y;AV=N.getPixelCoords(d.el);d.origX=d.grabX=AV.x;d.origY=d.grabY=AV.y;d.isBeingDragged=false}function v(Ai){if(!AE){return}var AX=+new Date,Ab;if(AX-y<o){return}y=AX;Ab=Ai=Ai||event;if(AA){Ai=Ai.touches&&Ai.touches[0];if(!Ai){return}AI(Ab)}var Aa=getEventCoords(Ai),Ah=Aa.x,Ae=Aa.y,Ad=Ah-a,Ac=Ae-Z,AZ=false,Ak=AE.origX+Ad,Aj=AE.origY+Ac,Af;if(AE.isBeingDragged===false){i(AE,Ai);delete Q[AE.id];for(Af in Q){U=true;i(Q[Af],Ai)}}AE.hasBeenDragged=(AE.hasBeenDragged||!!(Ad||Ac));var AY=Ak<AE.minX,AW=Ak>AE.maxX,An=Aj<AE.minY,Ag=Aj>AE.maxY,AV=AE.container!=null,Am=(typeof AE.ondrag==F),d=typeof AE.onbeforeexitcontainer==F,Al=0;if(typeof AE.onbeforedrag==F&&AE.onbeforedrag(Ai)==false){return}AV&=(AY||AW||An||Ag);if(AV&&(d||AE.onbeforeexitcontainer()==false)){if(AY){if(!AE.isAtLeft){AE.moveToX(AE.minX);AL(AE.minX-AE.origX,null);if(Am){AE.ondrag(Ai)}AE.isAtRight=false;AE.isAtLeft=true}Al+=1}else{if(AW){if(!AE.isAtRight){AE.moveToX(AE.maxX);AL(AE.maxX-AE.origX,null);if(Am){AE.ondrag(Ai)}AE.isAtRight=true;AE.isAtLeft=false}Al+=1}else{AE.isAtLeft=AE.isAtRight=false;AE.moveToX(Ak);AL(Ad,null)}}if(An){if(!AE.isAtTop){AE.moveToY(AE.minY);AL(null,AE.minY-AE.origY);if(Am){AE.ondrag(Ai)}AE.isAtTop=true;AE.isAtBottom=false}Al+=1}else{if(Ag){if(!AE.isAtBottom){if(AE.maxY>0){AE.moveToY(AE.maxY)}AL(null,AE.maxY-AE.origY);if(Am){AE.ondrag(Ai)}AE.isAtTop=false;AE.isAtBottom=true}Al+=1}else{AE.isAtTop=AE.isAtBottom=false;AE.moveToY(Aj);AL(null,Ac)}}AZ=Al==2;if(AZ&&typeof AE.ondragstop==F){AE.ondragstop(Ai)}else{if(Am){AE.ondrag(Ai)}}}else{AE.isAtLeft=AE.isAtRight=AE.isAtTop=AE.isAtBottom=false;AE.moveToX(Ak);AE.moveToY(Aj);AL(Ad,Ac);if(Am){AE.ondrag(Ai)}}if(x!==false){u(AE,Ai,Ah,Ae)}return false}function e(AZ){L=false;if(!AE){return}var AY=AE.hasBeenDragged,AV=(AE.isBeingDragged&&!AY),AX={},d,Ac,AW,Ab,Aa;if(!AE.hasBeenDragged&&!AV){if(!AO){AE=null}return}Q[AE.id]=AE;AO=false;if(AE.copyEl){AU(AE)}AZ=b(AZ,"changedTouches");n(AZ);for(d in Q){AW=AX[d]=Q[d];if(U){if(AW.copyEl){AU(AW)}AW=Q[d];Ab=AW.x;Aa=AW.y;if(Ab<AW.minX){AW.moveToX(AW.minX)}else{if(Ab>AW.maxX){AW.moveToX(AW.maxX)}}if(Aa<AW.minY){AW.moveToY(AW.minY)}else{if(Aa>AW.maxY){AW.moveToY(AW.maxY)}}if(AY){Y(AW,AZ)}}}if(AY){Y(AE,AZ);if(typeof AE.ondragend==F){AE.ondragend({domEvent:AZ,draggableList:AX})}}AE.hasBeenDragged=false;AE=null}var AS=function(AV,d){var AW=document.documentElement,AX;if(typeof AW.sourceIndex=="number"){AX=function(AZ,AY){return AZ.sourceIndex-AY.sourceIndex}}else{if("compareDocumentPosition" in AW){AX=function(AZ,AY){return AY.compareDocumentPosition(AZ)-3}}}AW=null;return(AS=AX)(AV,d)};function AM(d){d=d||event;if(d.keyCode==27||d.type==="touchcancel"){if(AE){AE.release(d)}}}function T(AV,d){this.type=AV;this.domEvent=d}function u(Ac,Aa,AW,d){var Ad={x:AW,y:d},AZ=0,AY=x.length,AV,AX,Ab={domEvent:Aa,dragObj:Ac};for(;AZ<AY;AZ++){AV=x[AZ];AX=AV.containsCoords(Ad);if(!AV.hasDropTargetOver&&AX){AV.hasDropTargetOver=true;if(typeof AV.ondragover==F){AV.ondragover(Ab)}if(AV.dragOverClassName){N.addClass(AV.el,AV.dragOverClassName)}}else{if(AV.hasDropTargetOver&&!AX){if(typeof AV.ondragout==F){AV.ondragout(Ab)}if(AV.dragOverClassName){N.removeClass(AV.el,AV.dragOverClassName)}AV.hasDropTargetOver=false}}}}function n(AX){var AV=AE.dropTargets,Ab,AY,d=AV.length,AW,Aa,AZ;if(d>0){AY=getEventCoords(AX);for(AW=0;AW<d;AW++){Ab=AV[AW];if(Ab.containsCoords(AY)){if(typeof Ab.ondrop==F){Ab.ondrop({domEvent:AX,dragObj:AE,dropTarget:Ab})}if(U){for(Aa in Q){if(Aa===Ab.id){continue}if(typeof Ab.ondrop==F){AZ=Q[Aa];Ab.ondrop({domEvent:AX,dragObj:AZ,dropTarget:Ab})}}}if(Ab.dragOverClassName){N.removeClass(Ab.el,Ab.dragOverClassName)}break}}}}function b(AV,d){return AV&&AV[d]&&AV[d][0]||AV||event}function q(AV){var AW=K.anim;AV.startX=AV.x;AV.startY=AV.y;var d=new AW.Animation(0.2);d.transition=AW.Transitions.accel;d.run=s;d.dObj=AV;d.onplay=AV.onglide;d.onend=V;d.start()}function s(AX){var AV=this.dObj,AW=AV.startX-AV.grabX,d=AV.startY-AV.grabY;AX=Math.pow(AX,3);AV.moveToX(AV.startX-(AW*AX));AV.moveToY(AV.startY-(d*AX))}function V(){AJ(this.dObj)}function AJ(d){if(typeof d.onglideend==F){d.onglideend()}if(d.copyEl){d.el=d.origEl;d.style=d.origEl.style;d.copyEl.style.display="none"}Y(d,{})}function z(d){if(K.anim&&d.useAnim){q(d)}else{d.moveToX(d.grabX);d.moveToY(d.grabY);if(typeof d.onglide==F){d.onglide()}AJ(d,{})}}return{dragCopy:false,useAnim:true,dragMultiple:false,selectedClassName:"",activeDragClassName:"",useHandleTree:true,isSelected:false,onbeforedrag:B,onbeforedragstart:B,ondragstart:B,ondrag:B,ondragstop:B,ondragend:B,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,keepInContainer:false,isDragEnabled:true,hasHandleSet:false,setHandle:function(d,AV){this.handle=d;this.hasHandleSet=true;this.useHandleTree=AV!=false},dropTargets:false,addDropTarget:function(AX){var AV=C.getByNode(AX),d=AV.el,AW=this.dropTargets;if(this.el===d){return AV}return AW[AW.length]=C.getByNode(d)},grab:function(Ab,Ad,AX){Ab=Ab||event;var Ac=R.getTarget(Ab),AW;AI(Ab);if(N.contains(this.el,Ac)){return}AW=N.getPixelCoords(this.el);this.grabX=AW.x;this.grabY=AW.y;var Ae=getEventCoords(Ab),Aa=this.handle,AV=N.getOffsetCoords(N.getContainingBlock(this.el)),AZ=Ae.x-AV.x,d=AZ-(0|Aa.offsetWidth/2),AY=Ae.y-AV.y,Ag=(AY-(0|Aa.offsetHeight/2)),Af=N.getOffsetCoords(Aa,this.el);if(this.keepInContainer){d=Math.max(d,0);d=Math.min(d,this.container.clientWidth-this.el.offsetWidth);Ag=Math.max(Ag,0);Ag=Math.min(Ag,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(d-Af.x+(Ad||0));this.moveToY(Ag-Af.y+(AX||0));AP(Ab,this);L=true;AE=this},release:function(d){W(d,this);if(typeof this.onrelease==F){this.onrelease(d)}if(this.dragMultiple){Q[this.id]=this}},moveToX:function(d){this.style[j]=(this.x=d)+g},moveToY:function(d){this.style[t]=(this.y=d)+g},removeDropTarget:function(AX){var AX=document.getElementById(AX.id),AV=this.dropTargets,AW,d;for(AW=0,d=AV.length;AW<d;AW++){if(AV[AW].el===AX){AV.splice(AW,1);return AX}}return null},toString:function(){return"Draggable(id="+this.id+")"}}}function G(S){this.el=document.getElementById(S);this.id=S}function O(){return{dragOverClassName:"",initCoords:function(){this.coords=this.coords||{};N.getOffsetCoords(this.el,document,this.coords);this.coords.w=this.el.clientWidth;this.coords.h=this.el.clientHeight},containsCoords:function(T){var S=this.coords,V=S.x,U=S.y;return(T.x>=V&&T.x<=V+S.w)&&(T.y>=U&&T.y<=U+S.h)},ondragover:false,ondragout:B,ondrop:B}}})();