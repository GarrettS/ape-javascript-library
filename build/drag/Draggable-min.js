APE.namespace("APE.drag");(function(){var K=self.APE,N=K.dom,M=K.drag,C=K.EventPublisher,R=N.Event,P=1000,Q={},B,L,G="function",F=K.createFactory(A,E),D=K.createFactory(H,O);M.Draggable=F;M.DropTarget=D;F.instanceDestructor=J;function A(V){var T=document,S=T.getElementById(V);this.id=V;this.el=this.origEl=S;this.style=S.style;this.isRel=N.getStyle(S,"position").toLowerCase()=="relative";var U=(this.isRel?S.parentNode:N.getContainingBlock(S));if(U===null){U=T.documentElement}this.container=U;this.dropTargets=[];this.handle=S;this.onbeforeexitcontainer=I;S.style.zIndex=parseInt(N.getStyle(S,"zIndex"),10)||P++}function I(){return !this.keepInContainer}function J(){var S,U,T;for(S in this.instances){T=this.instances[S];for(U in T){delete T[U]}delete this.instances[S]}Q={};dO=null}function E(){var AG=self.document,y="documentElement",a=AG[y].style,u="serSelect",AH="MozU"+u,i="MozU"+u,x="u"+u,o=AH in a?AH:i in a?i:x in a?x:"",Z="px",c="left",m="top",AE=false,W=0,V=0,w,p=false,h=25,r=-1,t=C.get(AG,"onmousedown");getEventCoords=R.getCoords;if("onselectstart" in AG){C.add(AG,"onselectstart",f)}else{t.addAfter(f)}if("pixelLeft" in a){Z=0;c="pixelLeft";m="pixelTop"}t.add(g).addAfter(X);C.add(AG,"onkeydown",q);C.add(AG,"onmousemove",n);C.add(AG,"onmouseup",Y);AG=a=null;function f(AJ){var d=!w;if(o){this[y].style[o]=d?"":"none"}else{if(!AJ){self.event.returnValue=d}}}function AB(d,AJ){return AJ===d.handle||(d.useHandleTree&&N.contains(d.handle,AJ))}function AD(d,AJ){if(AJ){if(d.selectedClassName){N.addClass(d.el,d.selectedClassName)}if(d.dragMultiple&&!(d.id in Q)){Q[d.id]=d}}else{if(d.selectedClassName){N.removeClass(d.el,d.selectedClassName)}delete Q[d.id]}d.isSelected=AJ}function k(AQ,AP){var AJ=AP.container,AM=AP.el,AS=document,AL=AS.documentElement,AO=N.getContainingBlock(AM)||AL,AN,AR,AV=(AO===AJ)?{x:0,y:0}:N.getOffsetCoords(AO,AJ),AK=N.getPixelCoords(AM),AW=N.getOffsetCoords(AM,AM.parentNode),AU=AW.x-AK.x+AV.x,AT=AW.y-AK.y+AV.y;if(AP.keepInContainer){if(AJ===AS.body){AN=parseInt(N.getStyle(AJ,"width"),10);AR=parseInt(N.getStyle(AJ,"height"),10)}else{AN=AJ.clientWidth;AR=AJ.clientHeight}AP.minX=0-AU;AP.maxX=AN-AM.offsetWidth-AU;AP.minY=0-AT;AP.maxY=AR-AM.offsetHeight-AT}}function v(){for(var d in Q){AD(Q[d],false)}}function S(){for(var d in Q){return true}return false}function T(AM,d){s(d);var AN=N.removeClass,AL,AK,AJ,AO;if(p!==false){for(AK=0,AJ=p.length;AK<AJ;AK++){AL=p[AK];if(AL.hasDropTargetOver){if(typeof AL.ondragout==G){AL.ondragout(AM,d)}if(AL.dragOverClassName){AN(AL.el,AL.dragOverClassName)}AL.hasDropTargetOver=false}}}for(AO in Q){s(Q[AO])}w=null}function U(d,AJ){if(d.activeDragClassName){N.removeClass(d.el,d.activeDragClassName)}if(typeof d.ondragend==G&&d.hasBeenDragged){d.ondragend(AJ)}if(d.copyEl){d.el.parentNode.insertBefore(d.copyEl,d.el)}d.hasBeenDragged=false}function e(d,AJ){if(AJ){if(d.id in Q){AD(d,false)}else{AD(d,true)}}else{if(!d.isSelected){v();AD(d,true)}}}function z(AJ){var AL="addClass",AN,AK=AJ.el,AM=AK,d;if(!AJ.copyEl){AJ.origEl=AK;AJ.copyEl=AK.cloneNode(true);AJ.copyEl.id+="Copy"}AN=AJ.copyEl;d=AN.style;d.display="";if(AN.parentNode!==AK.parentNode){AK.parentNode.insertBefore(AN,AK)}d.zIndex=parseInt(AM.style.zIndex,10)+100;if(AJ.origClassName){N[AL](AK,AJ.origClassName)}AJ.el=AN;AJ.style=d;if(AJ.isRel){d.marginBottom=-AM.offsetHeight+-(parseInt(N.getStyle(AM,"marginBottom"),10)||0)+"px";d.marginright=-AM.offsetWidth+-(parseInt(N.getStyle(AM,"marginRight"),10)||0)+"px"}}function AI(d){if(d.copyEl.style.display=="none"){return}d.el=d.origEl;d.style=d.origEl.style;d.moveToX(d.x);d.moveToY(d.y);d.copyEl.style.display="none";if(d.origClassName){N.removeClass(d.el,d.origClassName)}}function AC(AJ,d){var AK,AL;for(AL in Q){AK=Q[AL];if(typeof AJ=="number"){AK.moveToX(AK.origX+AJ)}if(typeof d=="number"){AK.moveToY(AK.origY+d)}}}function b(d,AJ){if(d.isBeingDragged){return}if(d.dragCopy){z(d)}if(typeof d.ondragstart==G){d.ondragstart(AJ)}if(d.activeDragClassName){N.addClass(d.el,d.activeDragClassName)}k(AJ,d);d.isBeingDragged=true}function g(AM){if(L){L=false;return}AM=AM||self.event;var AL=R.getTarget(AM),AK=F.instances,AJ,d=AL,AN=AM.metaKey||AM.ctrlKey;while(!AJ&&d!==null){AJ=AK[d.id];d=N.findAncestorWithAttribute(d,"id")}if(AJ){if(!AJ.isDragEnabled){if(!AN){v()}return false}if(!AN&&AJ.hasHandleSet&&!AB(AJ,AL)){v();AJ=null;return}else{if(!AN&&!AJ.isSelected){v()}AM.returnValue=false}}else{if(!AN){v();if(w){AD(w,false);w=null}}return}if(AN&&w&&!AJ.dragMultiple){AE=true;return false}if(!AJ.dragMultiple){if(!AN){v()}else{AE=true;return false}}e(AJ,AN);AJ.style.zIndex=++P;if(AN){}w=AJ;AF(AM,AJ);for(var AO in Q){AF(AM,Q[AO])}return AL.tagName!=="IMG"}function X(){if(!w){return}p=[];var AL=w.dropTargets,AK,AJ=0,d=AL.length;for(;AJ<d;AJ++){AK=AL[AJ];AK.initCoords();if(typeof AK.ondragover==G||typeof AK.ondragout==G||AK.dragOverClassName){p.push(AK)}}if(p.length===0){p=false}}function AF(AL,d){if(typeof d.onbeforedragstart==G&&d.onbeforedragstart(AL)==false){return true}var AK=getEventCoords(AL),AJ;W=AK.x;V=AK.y;AJ=N.getPixelCoords(d.el);d.origX=d.grabX=AJ.x;d.origY=d.grabY=AJ.y;d.isBeingDragged=false}function n(Ab){if(!w){return}var AL=+new Date;if(AL-r<h){return}r=AL;Ab=Ab||self.event;var AP=getEventCoords(Ab),AX=AP.x,AU=AP.y,AT=AX-W,AR=AU-V,AN=false,Ad=w.origX+AT,Ac=w.origY+AR,AV;if(w.isBeingDragged===false){b(w,Ab);for(AV in Q){b(Q[AV],Ab)}}w.hasBeenDragged=(w.hasBeenDragged||(AT||AR));var AM=Ad<w.minX,AK=Ad>w.maxX,Af=Ac<w.minY,AW=Ac>w.maxY,AJ=w.container!=null,Ag=(typeof w.ondrag==G),d=typeof w.onbeforeexitcontainer==G,Ae=0;if(typeof w.onbeforedrag==G&&w.onbeforedrag(Ab)==false){return}AJ&=(AM||AK||Af||AW);if(AJ&&(d||w.onbeforeexitcontainer()==false)){if(AM){if(!w.isAtLeft){w.moveToX(w.minX);AC(w.minX-w.origX,null);if(Ag){w.ondrag(Ab)}w.isAtRight=false;w.isAtLeft=true;Ae+=1}}else{if(AK){if(!w.isAtRight){w.moveToX(w.maxX);AC(w.maxX-w.origX,null);if(Ag){w.ondrag(Ab)}w.isAtRight=true;w.isAtLeft=false;Ae+=1}}else{w.isAtLeft=w.isAtRight=false;w.moveToX(Ad);AC(AT,null)}}if(Af){if(!w.isAtTop){w.moveToY(w.minY);AC(null,w.minY-w.origY);if(Ag){w.ondrag(Ab)}w.isAtTop=true;w.isAtBottom=false;Ae+=1}}else{if(AW){if(!w.isAtBottom){if(w.maxY>0){w.moveToY(w.maxY)}AC(null,w.maxY-w.origY);if(Ag){w.ondrag(Ab)}w.isAtTop=false;w.isAtBottom=true;Ae+=1}}else{w.isAtTop=w.isAtBottom=false;w.moveToY(Ac);AC(null,AR)}}AN=Ae==2;if(AN&&typeof w.ondragstop==G){w.ondragstop(Ab)}else{if(Ag){w.ondrag(Ab)}}}else{w.isAtLeft=w.isAtRight=w.isAtTop=w.isAtBottom=false;w.moveToX(Ad);w.moveToY(Ac);AC(AT,AR);if(Ag){w.ondrag(Ab)}}if(p!==false){var Aa={x:AX,y:AU},AZ=0,AY=p.length,AS,AQ,AO={domEvent:Ab,dragObj:w};for(;AZ<AY;AZ++){AS=p[AZ];AQ=AS.containsCoords(Aa);if(!AS.hasDropTargetOver&&AQ){AS.hasDropTargetOver=true;if(typeof AS.ondragover==G){AS.ondragover(AO)}if(AS.dragOverClassName){N.addClass(AS.el,AS.dragOverClassName)}}else{if(AS.hasDropTargetOver&&!AQ){if(typeof AS.ondragout==G){AS.ondragout(AO)}if(AS.dragOverClassName){N.removeClass(AS.el,AS.dragOverClassName)}AS.hasDropTargetOver=false}}}}return false}function Y(AP){L=false;var AK=(w&&w.isBeingDragged&&!w.hasBeenDragged);if(!w||!w.hasBeenDragged&&!AK){if(!AE){w=null}return}AE=false;AP=AP||self.event;var AJ,AT;if(w.copyEl){AI(w)}for(AJ in Q){AT=Q[AJ];if(AT.copyEl){AI(AT)}}var AN=w.dropTargets,AO=AN.length,AL,AS,AQ;if(AO>0){var AR=getEventCoords(AP),d,AM=0;for(;AM<AO;AM++){d=AN[AM];if(d.containsCoords(AR)){if(typeof d.ondrop==G){d.ondrop({domEvent:AP,dragObj:w,dropTarget:d})}for(AJ in Q){if(AJ===d.id){continue}if(typeof d.ondrop==G){AL=Q[AJ];d.ondrop({domEvent:AP,dragObj:AL,dropTarget:d})}}if(d.dragOverClassName){N.removeClass(d.el,d.dragOverClassName)}break}}}for(AJ in Q){AL=Q[AJ],AS=AL.x,AQ=AL.y;if(AS<AL.minX){AL.moveToX(AL.minX)}else{if(AS>AL.maxX){AL.moveToX(AL.maxX)}}if(AQ<AL.minY){AL.moveToY(AL.minY)}else{if(AQ>AL.maxY){AL.moveToY(AL.maxY)}}if(AL.hasBeenDragged){U(AL,AP)}}U(w,AP);w=null}function q(d){d=d||self.event;if(d.keyCode==27){if(w){w.release(d)}}}function j(AK,d,AM){if(AK.animTimer){return}AK.startX=d||0;AK.startY=AM||0;var AL=AK.startX-AK.grabX,AJ=AK.startY-AK.grabY;AK.glideDist=Math.ceil(Math.sqrt((AL*AL)+(AJ*AJ)));if(AK.glideDist===0){return}AK.rx=Math.abs(AL)/AK.glideDist;AK.ry=Math.abs(AJ)/AK.glideDist;if(AK.x>AK.grabX){AK.rx=-AK.rx}if(AK.y>AK.grabY){AK.ry=-AK.ry}AK.startTime=+new Date;AK.animTimer=self.setInterval(function(){l(AK,typeof AK.onglide==G)},10)}function l(AJ,AL){var AK=new Date-AJ.startTime,AM=Math.ceil(2*AK+0.5*0.01*AK*AK);if(AM>=AJ.glideDist){AJ.animTimer=self.clearInterval(AJ.animTimer);AJ.moveToX(AJ.grabX);AJ.moveToY(AJ.grabY);if(AJ.copyEl){AJ.el=AJ.origEl;AJ.style=AJ.origEl.style;AJ.copyEl.style.display="none"}if(typeof AJ.onglideend==G){AJ.onglideend()}U(AJ,{})}else{if(AL){AJ.onglide()}AJ.moveToX(AJ.startX+AM*AJ.rx);AJ.moveToY(AJ.startY+AM*AJ.ry)}}function AA(d){if(typeof d.onglideend==G){d.onglideend()}U(d,{})}function s(AJ,d,AK){j(AJ,AJ.x||d,AJ.y||d)}return{dragCopy:false,dragMultiple:false,isSelected:false,onbeforedrag:B,onbeforedragstart:B,ondragstart:B,ondrag:B,ondragstop:B,ondragend:B,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,keepInContainer:false,isDragEnabled:true,selectedClassName:"",activeDragClassName:"",useHandleTree:true,hasHandleSet:false,setHandle:function(d,AJ){this.handle=d;this.hasHandleSet=true;this.useHandleTree=AJ!=false},addDropTarget:function(AL){var AJ=D.getByNode(AL),d=AJ.el,AK=this.dropTargets;if(this.el===d){return AJ}return AK[AK.length]=D.getByNode(d)},grab:function(AN,AP,AL){if(!AN){AN=self.event}var AO=R.getTarget(AN);if(AN.preventDefault){AN.preventDefault()}AN.returnValue=false;if(N.contains(this.el,AO)){return}var AK=N.getPixelCoords(this.el);this.grabX=AK.x;this.grabY=AK.y;var AQ=getEventCoords(AN),AJ=N.getOffsetCoords(N.getContainingBlock(this.el)),AM=AQ.x-AJ.x,d=AM-(0|this.handle.offsetWidth/2);offsetY=AQ.y-AJ.y,newY=(offsetY-(0|this.handle.offsetHeight/2)),handleOffsetCoords=N.getOffsetCoords(this.handle,this.el);if(this.keepInContainer){d=Math.max(d,0);d=Math.min(d,this.container.clientWidth-this.el.offsetWidth);newY=Math.max(newY,0);newY=Math.min(newY,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(d-handleOffsetCoords.x+(AP||0));this.moveToY(newY-handleOffsetCoords.y+(AL||0));AF(AN,this);L=true;w=this},release:function(d){T(d,this);if(typeof this.onrelease==G){this.onrelease(d)}},moveToX:function(d){this.style[c]=(this.x=d)+Z},moveToY:function(d){this.style[m]=(this.y=d)+Z},removeDropTarget:function(AL){var AL=document.getElementById(AL.id),AJ=this.dropTargets,AK,d;for(AK=0,d=AJ.length;AK<d;AK++){if(AJ[AK].el===AL){AJ.splice(AK,1);return AL}}return null},toString:function(){return"Draggable(id="+this.id+")"}}}function H(S){this.el=document.getElementById(S);this.id=S}function O(){return{dragOverClassName:"",initCoords:function(){if(!this.coords){this.coords={}}N.getOffsetCoords(this.el,document,this.coords);this.coords.w=this.el.clientWidth;this.coords.h=this.el.clientHeight},containsCoords:function(S){var U=this.coords.x,T=this.coords.y;return(S.x>=U&&S.x<=U+this.coords.w)&&(S.y>=T&&S.y<=T+this.coords.h)},ondragover:false,ondragout:B,ondrop:B}}})();