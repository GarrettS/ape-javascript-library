APE.namespace("APE.drag");(function(){var M=self.APE,P=M.dom,D=P.getStyle,O=M.drag,T=P.Event,R=1000,S={},B,C=Function.prototype,K=self.parseInt,N,H="function",G=M.createFactory(A,F),E=M.createFactory(I,Q);O.Draggable=G;O.DropTarget=E;G.instanceDestructor=L;function A(Z,U){var X=document,V=X.getElementById(Z),Y,W;this.id=Z;this.el=this.origEl=V;this.style=V.style;this.isRel=D(V,"position").toLowerCase()=="relative";Y=(this.isRel?V.parentNode:P.getContainingBlock(V));if(Y===null){Y=X.documentElement}this.container=Y;this.dropTargets=[];this.handle=V;this.onbeforeexitcontainer=J;if(U){for(W in U){this[W]=U[W]}V.style.zIndex=K(D(V,"zIndex"),10)||R++}}function J(){return !this.keepInContainer}function L(){var U,W,V;for(U in this.instances){V=this.instances[U];for(W in V){delete V[W]}delete this.instances[U]}S={}}function F(){var Ah=document,Y=M.EventPublisher,Aj=Y.add,AQ=T.preventDefault,AO="documentElement",k=Ah[AO].style,j="px",m="left",z="top",Af=false,AE="setCapture" in document.documentElement,c=0,a=0,AM,AD=false,V=false,Ad=false,s=25,AF=-1,i="onmousedown",U="onmousemove",Ai="onmouseup",AI,AJ,AX=T.getCoords;if("ontouchstart" in Ah){AI=true;i="ontouchstart";U="ontouchmove";Ai="ontouchend";Aj(Ah,"ontouchcancel",Ac)}AJ=Y.get(Ah,i);if("pixelLeft" in k){j=0;m="pixelLeft";z="pixelTop"}Aj(Ah,"onkeydown",Ac);Aj(Ah,Ai,h);Ab(Ah,k);AJ.add(p).addAfter(g);Ah=k=null;function Ab(Ar,Aq){var Ao="serSelect",As="MozU"+Ao,Ap="MozU"+Ao,Al="u"+Ao,An=As in k?As:Ap in k?Ap:Al in k?Al:"",d="onselectstart";if(d in Ah){Aj(Ah,d,Am)}else{AJ.addAfter(Am)}function Am(Au){var At=!AM;if(An){this[AO].style[An]=At?"":"none"}else{(Au||window.event||0).returnValue=At}}}function AT(d,Al){return Al===d.handle||(d.useHandleTree&&P.contains(d.handle,Al))}function Ae(d,Al){if(Al){if(d.selectedClassName){P.addClass(d.el,d.selectedClassName)}if(d.dragMultiple&&!(d.id in S)){S[d.id]=d}}else{if(d.selectedClassName){P.removeClass(d.el,d.selectedClassName)}delete S[d.id]}d.isSelected=Al}function x(Ar){var Al=Ar.container,Ao=Ar.el,As=document,An=As.documentElement,Aq=P.getContainingBlock(Ao)||An,Ap,At,Aw=(Aq===Al)?{x:0,y:0}:P.getOffsetCoords(Aq,Al),Am=P.getPixelCoords(Ao),Ax=P.getOffsetCoords(Ao,Ao.parentNode),Av=Ax.x-Am.x+Aw.x,Au=Ax.y-Am.y+Aw.y;if(Ar.keepInContainer){if(Al===As.body){Ap=K(D(Al,"width"),10);At=K(D(Al,"height"),10)}else{Ap=Al.clientWidth;At=Al.clientHeight}Ar.minX=0-Av;Ar.maxX=Ap-Ao.offsetWidth-Av;Ar.minY=0-Au;Ar.maxY=At-Ao.offsetHeight-Au}}function AL(){t(Ae,[false],true);V=false}function X(An){AG(AM);var Am,Al,d;if(AD!==false){for(Al=0,d=AD.length;Al<d;Al++){Am=AD[Al];if(Am.hasDropTargetOver){if(typeof Am.ondragout==H){Am.ondragout(An,AM)}if(Am.dragOverClassName){P.removeClass(Am.el,Am.dragOverClassName)}Am.hasDropTargetOver=false}}}t(AG)}function Z(d,Al){if(d.activeDragClassName){P.removeClass(d.el,d.activeDragClassName)}AN(d);if(AE){d.el.releaseCapture()}d.hasBeenDragged=false}function AY(d){if(AM.dragMultiple){S[AM.id]=AM}else{S={}}Af=false;Y.remove(document,U,AB);AM=null}function n(d,Al){if(Al){if(d.id in S){Ae(d,false)}else{Ae(d,true)}}else{if(!d.isSelected){AL();Ae(d,true)}}}function e(d){var Al=d.el,Am=d.copyEl;if(!Am){Am=d.copyEl=document.getElementById(d.proxyId)}AS(d,Am,Al)}function AP(d){if(!d.copyEl){d.copyEl=d.el.cloneNode(true);d.copyEl.id+="Copy"}AS(d,d.copyEl,d.el)}function AS(Al,Ao,An){var d=Ao.style;Al.origEl=An;d.zIndex=K(An.style.zIndex,10)+100;Al.el=Ao;Al.style=d;var Am=D(An,"display");d.display=Am;if(Al.dragCopy){An.parentNode.insertBefore(Ao,An);if(Al.isRel){v(d,An,Am)}}else{AK(Al,Ao,An)}}function AK(d,An,Am){var Al=P.getOffsetCoords(Am,An.parentNode);d.moveToX(Al.x);d.moveToY(Al.y)}function v(d,Am,Al){if(Al=="inline"){d.marginRight=-Am.offsetWidth+-(K(D(Am,"marginRight"),10)||0)+"px"}else{d.marginBottom=-Am.offsetHeight+-(K(D(Am,"marginBottom"),10)||0)+"px"}}function Ak(d){var Al=d.copyEl;if(!Al){return}d.el=d.origEl;d.style=d.el.style;d.moveToX(d.x);d.moveToY(d.y);Al.style.display="none";if(d.dragCopy&&!d.proxyId){d.el.parentNode.insertBefore(Al,d.el)}}function AV(Al,d){if(!V||Ad){return}t(Aa,[Al,d])}function Aa(Am,Al,d){if(typeof Al=="number"){Am.moveToX(Am.origX+Al)}if(typeof d=="number"){Am.moveToY(Am.origY+d)}}function l(d,Al){if(d.isBeingDragged){return}if(d.dragCopy&&!d.proxyId){AP(d)}if(typeof d.ondragstart==H){d.ondragstart(b(d,Al))}if(AE){d.el.setCapture()}if(d.activeDragClassName){P.addClass(d.el,d.activeDragClassName)}x(d);d.isBeingDragged=true}function b(d,An){var Ao=d.id,Am={},Al=1;Am[Ao]=d;if(V){for(Ao in S){Am[Ao]=S[Ao];Al++}}return{domEvent:An,draggableList:Am,count:Al}}function p(An){if(N){N=false;return}var d=An||window.event;if(AI&&AM){return}An=f(An,"touches");var Am=T.getTarget(d),Ao=An.metaKey||An.ctrlKey,Al=o(Am);if(Al){if(!Al.isDragEnabled){if(!Ao){AL()}return false}if(!Ao&&Al.hasHandleSet&&!AT(Al,Am)){AL();Al=null;return}else{if(!Ao&&!Al.isSelected){AL()}An.returnValue=false}}else{if(!Ao){AL();if(AM){Ae(AM,false);AM=null}}return}if(Ao&&AM&&!Al.dragMultiple){Af=true;return false}if(!Al.dragMultiple){if(!Ao){AL()}else{Af=true;return false}}n(Al,Ao);Al.style.zIndex=++R;if(Ag(Al,An)==false){return}AM=Al;AQ(d);t(Ag,[An]);return Am.tagName!=="IMG"}function o(Al){var d,Am=G.instances;for(;!d&&Al!==null;Al=P.findAncestorWithAttribute(Al,"id")){d=Am[Al.id]}return d}function g(){if(!AM){return}var An=AM.dropTargets,Am,Al,Ao,d;if(!An){return AD=false}AD=[];for(Al=Ao=0,d=An.length;Al<d;Al++){Am=An[Al];Am.initCoords();if(Am.ondragover||Am.ondragout||Am.dragOverClassName){AD[Ao++]=Am}}if(Ao===0){AD=false}}function Ag(d,An){if(typeof d.onbeforedragstart==H&&d.onbeforedragstart(b(d,An))==false){return false}var Am=AX(An),Al;if(d.proxyId&&!d.dragCopy){e(d)}w(d);c=Am.x;a=Am.y;Al=P.getPixelCoords(d.el);d.origX=d.grabX=Al.x;d.origY=d.grabY=Al.y;d.isBeingDragged=false;Aj(document,U,AB)}function w(d){var Al=d.constraint;if(Al==="y"){d.moveToX=C}else{if(Al==="x"){d.moveToY=C}}}function AN(d){delete d.moveToX;delete d.moveToY}function AB(Aq){if(!AM){return}var An=+new Date,Au;if(An-AF<s){return}AF=An;Au=Aq=Aq||event;if(AI){Aq=Aq.touches&&Aq.touches[0];if(!Aq){return}AQ(Au)}var As=AX(Aq),Ao=As.x,Am=As.y,At=Ao-c,Ar=Am-a,d=AM.origX+At,Av=AM.origY+Ar,Al;if(AM.isBeingDragged===false){Ad=!!AM.proxyId;for(Al in S){V=true;break}delete S[AM.id];l(AM,Aq);if(AM.proxyId&&AM.dragCopy){e(AM)}t(l,[Aq])}AM.hasBeenDragged=(AM.hasBeenDragged||!!(At||Ar));if(typeof AM.onbeforedrag==H&&AM.onbeforedrag(Aq)==false){return}var Ap=typeof AM.ondrag===H;if(!AZ(d,Av,At,Ar)){AM.isAtLeft=AM.isAtRight=AM.isAtTop=AM.isAtBottom=false;AM.moveToX(d);AM.moveToY(Av);AV(At,Ar);if(Ap){AM.ondrag(Aq)}}if(AD!==false){AA(AM,Aq,Ao,Am)}return false}function AZ(d,Ax,As,Aq){if(AM.container){var Aw=d<AM.minX,Au=d>AM.maxX,Ao=Ax<AM.minY,At=Ax>AM.maxY,Al=AM.constraint,Ar=Al=="x",Ap=Al=="y",An=!Ar,Am=!Ap,Av;if(Aw||Au||Ao||At&&AM.onbeforeexitcontainer()!=true){if(!Ap){An=AW(d,As,Aw,Au)}if(!Ar){Am=AU(Ax,Aq,Ao,At)}if(An||Am){if(AM.ondrag){AM.ondrag()}}else{AM.ondragstop()}return true}}return false}function AW(Ao,d,An,Al){if(AM.x===Ao){return false}var Am;if(An){if(!AM.isAtLeft){AM.moveToX(AM.minX);AV(AM.minX-AM.origX,null);AM.isAtRight=false;AM.isAtLeft=true}else{Am=true}}else{if(Al){if(!AM.isAtRight){AM.moveToX(AM.maxX);AV(AM.maxX-AM.origX,null);AM.isAtRight=true;AM.isAtLeft=false}else{Am=true}}else{AM.isAtLeft=AM.isAtRight=false;AM.moveToX(Ao);AV(d,null)}}return !Am}function AU(Ao,d,Am,Al,Ap){if(AM.y===Ao){return false}var An;if(Am){if(!AM.isAtTop){AM.moveToY(AM.minY);AV(null,AM.minY-AM.origY);AM.isAtTop=true;AM.isAtBottom=false}else{An=true}}else{if(Al){if(!AM.isAtBottom){if(AM.maxY>0){AM.moveToY(AM.maxY)}AV(null,AM.maxY-AM.origY);AM.isAtTop=false;AM.isAtBottom=true}else{An=true}}else{AM.isAtTop=AM.isAtBottom=false;AM.moveToY(Ao);AV(null,d)}}return !An}function h(Al){N=false;Y.remove(document,U,AB);if(!AM){return}var d=AM.hasBeenDragged,Am=(AM.isBeingDragged&&!d);Al=f(Al,"changedTouches");if(!AM.hasBeenDragged&&!Am){if(!Af){Ak(AM);AY(Al)}return}if(!Ad){t(r)}t(Ak);Ak(AM);q(Al);t(Z,[Al]);S[AM.id]=AM;Z(AM,Al);AM.ondragend({domEvent:Al,draggableList:S});if(AM){AY(Al)}}function r(Al){var d=Al.x,Am=Al.y;if(d<Al.minX){Al.moveToX(Al.minX)}else{if(d>Al.maxX){Al.moveToX(Al.maxX)}}if(Am<Al.minY){Al.moveToY(Al.minY)}else{if(Am>Al.maxY){Al.moveToY(Al.maxY)}}}function t(An,Al,Am){if(!V&&!Am){return}var Ao,d;Al=Al||[];Al.unshift(0);for(Ao in S){d=Al[0]=S[Ao];An.apply(d,Al)}}function Ac(d){if(!AM){return}d=d||event;if(d.keyCode==27||d.type==="touchcancel"){AM.release(d)}}function AA(As,Aq,Am,d){var At={x:Am,y:d},Ap=0,Ao=AD.length,Al,An,Ar={domEvent:Aq,dragObj:As};for(;Ap<Ao;Ap++){Al=AD[Ap];An=Al.containsCoords(At);if(!Al.hasDropTargetOver&&An){Al.hasDropTargetOver=true;if(typeof Al.ondragover==H){Al.ondragover(Ar)}if(Al.dragOverClassName){P.addClass(Al.el,Al.dragOverClassName)}}else{if(Al.hasDropTargetOver&&!An){if(typeof Al.ondragout==H){Al.ondragout(Ar)}if(Al.dragOverClassName){P.removeClass(Al.el,Al.dragOverClassName)}Al.hasDropTargetOver=false}}}}function q(An){var Al=AM.dropTargets,Aq,Ao,d=Al.length,Am,Ap;if(d){Ao=AX(An);for(Am=0;Am<d;Am++){Aq=Al[Am];if(typeof Aq.ondrop===H&&Aq.containsCoords(Ao)){Aq.ondrop(AH(An,AM));t(AC,[Aq,An])}Ap=Aq.dragOverClassName;if(Ap){P.removeClass(Aq.el,Ap)}}}}function AH(Al,d){return{domEvent:Al,dragObj:d}}function AC(d,Am,Al){if(d.id!==Am.id){Am.ondrop(AH(Al,d))}}function f(Al,d){return Al&&Al[d]&&Al[d][0]||Al||event}function u(Al){var Am=M.anim,d=new Am.Animation(0.2);d.transition=Am.Transitions.accel;d.run=y;d.dObj=Al;d.onplay=Al.onglide;d.onend=W;d.start()}function y(An){var Al=this.dObj,Am=Al.x-Al.grabX,d=Al.y-Al.grabY;An=Math.pow(An,3);Al.moveToX(Al.x-(Am*An));Al.moveToY(Al.y-(d*An))}function W(){AR(this.dObj)}function AR(d){if(typeof d.onglideend==H){d.onglideend()}Ak(d)}function AG(d){if(M.anim&&d.useAnim){u(d)}else{d.moveToX(d.grabX);d.moveToY(d.grabY);if(typeof d.onglide==H){d.onglide()}AR(d,{})}}return{dragCopy:false,useAnim:true,dragMultiple:false,selectedClassName:"",activeDragClassName:"",useHandleTree:true,isSelected:false,onbeforedrag:B,onbeforedragstart:C,ondragstart:B,ondrag:B,ondragstop:C,ondragend:C,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,keepInContainer:false,isDragEnabled:true,hasHandleSet:false,setHandle:function(d,Al){this.handle=d;this.hasHandleSet=true;this.useHandleTree=Al!=false},dropTargets:false,addDropTarget:function(An){var Al=E.getByNode(An),d=Al.el,Am=this.dropTargets;if(this.el===d){return Al}return Am[Am.length]=E.getByNode(d)},grab:function(Ar,At,An){Ar=Ar||window.event;var As=T.getTarget(Ar),Am;AQ(Ar);if(P.contains(this.el,As)){return}Am=P.getPixelCoords(this.el);this.grabX=Am.x;this.grabY=Am.y;var Au=AX(Ar),Aq=this.handle,Al=P.getOffsetCoords(P.getContainingBlock(this.el)),Ap=Au.x-Al.x,d=Ap-(0|Aq.offsetWidth/2),Ao=Au.y-Al.y,Aw=(Ao-(0|Aq.offsetHeight/2)),Av=P.getOffsetCoords(Aq,this.el);if(this.keepInContainer){d=Math.max(d,0);d=Math.min(d,this.container.clientWidth-this.el.offsetWidth);Aw=Math.max(Aw,0);Aw=Math.min(Aw,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(d-Av.x+(At||0));this.moveToY(Aw-Av.y+(An||0));Ag(this,Ar);N=true;AM=this},release:function(d){d=d||{};t(Z,[d]);if(typeof this.onrelease==H){this.onrelease(d)}X(d);AY(d)},moveToX:function(d){this.style[m]=(this.x=d)+j},moveToY:function(d){this.style[z]=(this.y=d)+j},removeDropTarget:function(An){var An=document.getElementById(An.id),Al=this.dropTargets,Am,d;for(Am=0,d=Al.length;Am<d;Am++){if(Al[Am].el===An){Al.splice(Am,1);return An}}return null},toString:function(){return"Draggable(id="+this.id+")"}}}function I(U){this.el=document.getElementById(U);this.id=U}function Q(){return{dragOverClassName:"",initCoords:function(){var V=this.coords||(this.coords={}),U=this.el;P.getOffsetCoords(U,document,V);V.w=U.clientWidth;V.h=U.clientHeight},containsCoords:function(V){var U=this.coords,X=U.x,W=U.y;return(V.x>=X&&V.x<=X+U.w)&&(V.y>=W&&V.y<=W+U.h)},ondragover:false,ondragout:B,ondrop:B}}})();