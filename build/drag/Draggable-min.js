APE.namespace("APE.drag");(function(){var E=self.APE,G=E.dom,I=E.drag,J=E.EventPublisher,K=1000,L={},F,B=E.createFactory(N,M);I.Draggable=B;B.instanceDestructor=H;function N(Q){this.id=Q.id;this.el=this.origEl=Q;this.style=Q.style;this.isRel=G.getStyle(Q,"position").toLowerCase()=="relative";this.container=(this.isRel?Q.parentNode:G.getContainingBlock(Q));this.dropTargets=[];this.handle=Q;this.onbeforeexitcontainer=A;Q.style.zIndex=G.getStyle(Q,"zIndex")||K++;P(Q)}function A(){return !this.keepInContainer}function H(){var Q,S,R;for(Q in this.instances){R=this.instances[Q];for(S in R){if(R.hasOwnProperty(S)){delete R[S]}}delete this.instances[Q]}L={};dO=null}function P(W){var V=W.style,U,Q=G.getContainingBlock(W);if(G.IS_COMPUTED_STYLE){U=document.defaultView.getComputedStyle(W,"")}else{U=W.currentStyle||V}var S=U.left,X=U.right,T=U.top,R=U.bottom;if((S===""||S==="auto")){X=parseInt(X,10);if(isFinite(X)){V.left=Q.clientWidth-W.offsetWidth-X+"px"}else{V.left="0"}}if((T===""||T==="auto")){R=parseInt(R,10);if(isFinite(R)){V.top=Q.clientHeight-W.offsetHeight-R+"px"}else{V.top="0"}}}function M(){var AE=self.document,x="documentElement",a=AE[x].style,t="serSelect",AF="MozU"+t,h="MozU"+t,w="u"+t,n=AF in a?AF:h in a?h:w in a?w:"",Z="px",c="left",l="top",AC=false,W=0,V=0,v,o=false,g=25,p=-1,s=J.get(AE,"onmousedown");getEventCoords=G.Event.getCoords;if("onselectstart" in AE){J.get(AE,"onselectstart").addBefore(r)}else{s.addAfter(r);J.get(AE,"onmouseup").addAfter(S)}if("pixelLeft" in a){Z=0;c="pixelLeft";l="pixelTop"}s.add(f).addAfter(X);J.add(AE,"onkeypress",Q);J.add(AE,"onmousemove",m);J.add(AE,"onmouseup",Y);function r(d){if(v===null){S.call(this,d)}else{if(n){this[x].style[n]=v?"none":""}}}function S(d){if(n){this[x].style[n]=""}else{if(!d){window.event.returnValue=true}}}AE=a=null;function z(d,AH){return AH===d.handle||(d.useHandleTree&&G.contains(d.handle,AH))}function AB(d,AH){if(AH){if(d.selectedClassName){G.addClass(d.el,d.selectedClassName)}if(d.dragMultiple&&!(d.id in L)){L[d.id]=d}}else{if(d.selectedClassName){G.removeClass(d.el,d.selectedClassName)}delete L[d.id]}d.isSelected=AH}function j(AL,AK){var d=AK.container,AH=AK.el,AJ=G.getContainingBlock(AH),AO=G.getOffsetCoords(AJ,d),AI=G.getPixelCoords(AH),AP=G.getOffsetCoords(AH,AH.parentNode),AN=AP.x-AI.x+AO.x,AM=AP.y-AI.y+AO.y;if(AK.keepInContainer){AK.minX=0-AN;AK.maxX=d.clientWidth-AK.el.offsetWidth-AN;AK.minY=0-AM;AK.maxY=d.clientHeight-AK.el.offsetHeight-AM}}function u(){for(var d in L){AB(L[d],false)}}function R(){for(var d in L){return true}return false}function T(AJ,AM){q(AM);var AK=G.removeClass,AI,AH=0,d=o.length,AL;if(o!==false){for(;AH<d;AH++){AI=o[AH];if(AI.hasDropTargetOver){if(typeof AI.ondragout=="function"){AI.ondragout(AJ,AM)}if(AI.dragOverClassName){AK(AI.el,AI.dragOverClassName)}AI.hasDropTargetOver=false}}}for(AL in L){q(L[AL])}AM=null}function U(d,AH){if(d.activeDragClassName){G.removeClass(d.el,d.activeDragClassName)}if(typeof d.ondragend=="function"&&d.hasBeenDragged){d.ondragend(AH)}if(d.copyEl){d.el.parentNode.insertBefore(d.copyEl,d.el)}d.hasBeenDragged=false}function e(d,AH){if(AH){if(d.id in L){AB(d,false)}else{AB(d,true)}}else{if(!d.isSelected){u();AB(d,true)}}}function y(AH){var AJ="addClass",AL,AI=AH.el,AK=AI,d;if(!AH.copyEl){AH.origEl=AI;AH.copyEl=AI.cloneNode(true);AH.copyEl.id+="Copy"}AL=AH.copyEl;d=AL.style;d.display="";if(AL.parentNode!==AI.parentNode){AI.parentNode.insertBefore(AL,AI)}d.zIndex=parseInt(AK.style.zIndex)+100;if(AH.origClassName){G[AJ](AI,AH.origClassName)}AH.el=AL;AH.style=d;if(AH.isRel){d.marginBottom=-AK.offsetHeight+-(parseInt(G.getStyle(AK,"marginBottom"))||0)+"px";d.marginright=-AK.offsetWidth+-(parseInt(G.getStyle(AK,"marginRight"))||0)+"px"}}function AG(d){if(d.copyEl.style.display=="none"){return}d.el=d.origEl;d.style=d.origEl.style;d.moveToX(d.x);d.moveToY(d.y);d.copyEl.style.display="none";if(d.origClassName){G.removeClass(d.el,d.origClassName)}}function AA(AH,d){var AI,AJ;for(AJ in L){AI=L[AJ];if(AH!=null){AI.moveToX(AI.origX+AH)}if(d!=null){AI.moveToY(AI.origY+d)}}}function b(d,AH){if(d.isBeingDragged){return}if(d.dragCopy){y(d)}if(typeof d.ondragstart=="function"){d.ondragstart(AH)}if(d.activeDragClassName){G.addClass(d.el,d.activeDragClassName)}j(AH,d);d.isBeingDragged=true}function f(AK){if(!AK){AK=self.event}var AJ=G.Event.getTarget(AK),AH=null,AI=B.instances,d=AJ;for(;AH==null&&d;d=G.findAncestorWithAttribute(d,"id")){AH=AI[d.id]}var AL=AK.metaKey||AK.ctrlKey;if(AH){if(!AH.isDragEnabled){if(!AL){u()}return false}if(!AL&&AH.hasHandleSet&&!z(AH,AJ)){u();AH=null;return}else{if(!AL&&!AH.isSelected){u()}AK.returnValue=false}}else{if(!AL){u();if(v){AB(v,false);v=null}}return}if(AL&&v&&!AH.dragMultiple){AC=true;return false}if(!AH.dragMultiple){if(!AL){u()}else{AC=true;return false}}e(AH,AL);AH.style.zIndex=++K;if(AL){}v=AH;AD(AK,AH);for(var AM in L){AD(AK,L[AM])}return AJ.tagName!=="IMG"}function X(){if(!v){return}o=[];var AJ=v.dropTargets,AI,AH=0,d=AJ.length;for(;AH<d;AH++){AI=AJ[AH];AI.initCoords();if(typeof AI.ondragover=="function"||typeof AI.ondragout=="function"||AI.dragOverClassName){o.push(AI)}}if(o.length===0){o=false}}function AD(AJ,d){if(typeof d.onbeforedragstart=="function"&&d.onbeforedragstart(AJ)==false){return true}var AI=G.Event.getCoords(AJ),AH;W=AI.x;V=AI.y;AH=G.getPixelCoords(d.el);d.origX=d.grabX=AH.x;d.origY=d.grabY=AH.y;d.isBeingDragged=false}function m(AY){if(v==null){return}var AJ=+new Date;if(AJ-p<g){return}p=AJ;AY=AY||window.event;var AM=getEventCoords(AY),AU=AM.x,AS=AM.y,AQ=AU-W,AO=AS-V;if(v.isBeingDragged==false){b(v,AY);for(var AR in L){b(L[AR],AY)}}v.newX=v.origX+AQ;v.newY=v.origY+AO;v.hasBeenDragged=(v.hasBeenDragged||(AQ||AO));var AK=v.newX<v.minX,AH=v.newX>v.maxX,Aa=v.newY<v.minY,AT=v.newY>v.maxY;if(typeof v.onbeforedrag=="function"&&v.onbeforedrag(AY)==false){return}var d=v.container!=null,Ab=(typeof v.ondrag=="function"),AI=typeof v.onbeforeexitcontainer=="function",AZ=0;d&=(AK||AH||Aa||AT);if(d&&(AI||v.onbeforeexitcontainer()==false)){if(AK){if(!v.isAtLeft){v.moveToX(v.minX);AA(v.minX-v.origX,null);if(Ab){v.ondrag(AY)}v.isAtRight=false;v.isAtLeft=true;AZ+=1}}else{if(AH){if(!v.isAtRight){v.moveToX(v.maxX);AA(v.maxX-v.origX,null);if(Ab){v.ondrag(AY)}v.isAtRight=true;v.isAtLeft=false;AZ+=1}}else{v.isAtLeft=v.isAtRight=false;v.moveToX(v.newX);AA(AQ,null)}}if(Aa){if(!v.isAtTop){v.moveToY(v.minY);AA(null,v.minY-v.origY);if(Ab){v.ondrag(AY)}v.isAtTop=true;v.isAtBottom=false;AZ+=1}}else{if(AT){if(!v.isAtBottom){if(v.maxY>0){v.moveToY(v.maxY)}AA(null,v.maxY-v.origY);if(Ab){v.ondrag(AY)}v.isAtTop=false;v.isAtBottom=true;AZ+=1}}else{v.isAtTop=v.isAtBottom=false;v.moveToY(v.newY);AA(null,AO)}}v.isDragStopped=AZ==2;if(v.isDragStopped&&typeof v.ondragstop=="function"){v.ondragstop(AY)}else{if(Ab){v.ondrag(AY)}}}else{v.isDragStopped=v.isAtLeft=v.isAtRight=v.isAtTop=v.isAtBottom=false;v.moveToX(v.newX);v.moveToY(v.newY);AA(AQ,AO);if(Ab){v.ondrag(AY)}}if(o!==false){var AX={x:AU,y:AS},AW=0,AV=o.length,AP,AN,AL={domEvent:AY,dragObj:v};for(;AW<AV;AW++){AP=o[AW],AN=AP.containsCoords(AX);if(!AP.hasDropTargetOver&&AN){AP.hasDropTargetOver=true;if(typeof AP.ondragover=="function"){AP.ondragover(AL)}if(AP.dragOverClassName){G.addClass(AP.el,AP.dragOverClassName)}}else{if(AP.hasDropTargetOver&&!AN){if(typeof AP.ondragout=="function"){AP.ondragout(AL)}if(AP.dragOverClassName){G.removeClass(AP.el,AP.dragOverClassName)}AP.hasDropTargetOver=false}}}}return false}function Y(AN){var AI=(v&&v.isBeingDragged&&!v.hasBeenDragged);if(v===null||!v.hasBeenDragged&&!AI){if(!AC){v=null}return}AC=false;if(!AN){AN=event}var AH,AR;if(v.copyEl){AG(v)}for(AH in L){AR=L[AH];if(AR.copyEl){AG(AR)}}var AL=v.dropTargets,AM=AL.length,AJ,AQ,AO;if(AM>0){var AP=getEventCoords(AN),d,AK=0;for(;AK<AM;AK++){d=AL[AK];if(d.containsCoords(AP)){d.containsCoords(AP);if(typeof d.ondrop=="function"){d.ondrop({domEvent:AN,dragObj:v,dropTarget:d})}for(AH in L){if(AH===d.id){continue}if(typeof d.ondrop=="function"){AJ=L[AH];d.ondrop({domEvent:AN,dragObj:AJ,dropTarget:d})}}if(d.dragOverClassName){G.removeClass(d.el,d.dragOverClassName)}break}}}for(AH in L){AJ=L[AH],AQ=AJ.x,AO=AJ.y;if(AQ<AJ.minX){AJ.moveToX(AJ.minX)}else{if(AQ>AJ.maxX){AJ.moveToX(AJ.maxX)}}if(AO<AJ.minY){AJ.moveToY(AJ.minY)}else{if(AO>AJ.maxY){AJ.moveToY(AJ.maxY)}}if(AJ.hasBeenDragged){U(AJ,AN)}}U(v,AN);v=null}function Q(d){d=d||self.event;if(d.keyCode==27){if(v){v.release(d)}}}function i(AI,d,AK){if(AI.animTimer){return}AI.startX=d;AI.startY=AK;var AJ=AI.startX-AI.grabX,AH=AI.startY-AI.grabY;AI.glideDist=Math.ceil(Math.sqrt((AJ*AJ)+(AH*AH)));if(AI.glideDist===0){return}AI.rx=Math.abs(AJ)/AI.glideDist;AI.ry=Math.abs(AH)/AI.glideDist;if(AI.x>AI.grabX){AI.rx=-AI.rx}if(AI.y>AI.grabY){AI.ry=-AI.ry}AI.startTime=+new Date;AI.animTimer=self.setInterval(function(){k(AI)},10)}function k(AH){var AI=new Date-AH.startTime,AJ=Math.ceil(2*AI+0.5*0.01*AI*AI);if(AJ>=AH.glideDist){AH.animTimer=self.clearInterval(AH.animTimer);AH.moveToX(AH.grabX);AH.moveToY(AH.grabY);if(AH.copyEl){AH.el=AH.origEl;AH.style=AH.origEl.style;AH.copyEl.style.display="none"}if(typeof AH.onglide=="function"){AH.onglide()}if(typeof AH.onglideend=="function"){AH.onglideend()}U(AH,{})}else{AH.moveToX(AH.startX+AJ*AH.rx);AH.moveToY(AH.startY+AJ*AH.ry);if(typeof AH.onglide=="function"){AH.onglide()}}}function q(AH,d,AI){i(AH,AH.x||d,AH.y||d)}return{dragCopy:false,dragMultiple:false,isSelected:false,onbeforedrag:F,onbeforedragstart:F,ondragstart:F,ondrag:F,ondragstop:F,ondragend:F,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,newX:0,newY:0,keepInContainer:false,isDragEnabled:true,selectedClassName:"",activeDragClassName:"",useHandleTree:true,hasHandleSet:false,setHandle:function(d,AH){this.handle=d;this.hasHandleSet=true;this.useHandleTree=AH!=false},addDropTarget:function(AJ){var AH=O.getByNode(AJ),d=AH.el,AI=this.dropTargets;if(this.el===d){return AH}return AI[AI.length]=O.getByNode(d)},grab:function(AM,AO,AJ){if(!AM){AM=self.event}var AQ=G.Event,AN=AQ.getTarget(AM);if(AM.preventDefault){AM.preventDefault()}AM.returnValue=false;if(G.contains(this.el,AN)){return}var AI=G.getPixelCoords(this.el);this.grabX=AI.x;this.grabY=AI.y;var AP=AQ.getCoords(AM),AH=G.getOffsetCoords(G.getContainingBlock(this.el)),AK=AP.y-AH.y,AS=Math.floor(AK-(this.handle.offsetHeight/2)),AR=G.getOffsetCoords(this.handle,this.el);var AL=AP.x-AH.x,d=AL-Math.floor((this.handle.offsetWidth/2));if(this.keepInContainer){d=Math.max(d,0);d=Math.min(d,this.container.clientWidth-this.el.offsetWidth);AS=Math.max(AS,0);AS=Math.min(AS,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(d-AR.x+(AO||0));this.moveToY(AS-AR.y+(AJ||0));AD(AM,this);v=this},release:function(d){T(d,this);if(typeof this.onrelease=="function"){this.onrelease(d)}},moveToX:function(d){this.style[c]=(this.x=d)+Z},moveToY:function(d){this.style[l]=(this.y=d)+Z},removeDropTarget:function(AI){AI=document.getElementById(AI.id);for(var AH=0,d=this.dropTargets.length;AH<d;AH++){if(this.dropTargets[AH].el===AI){this.dropTargets.splice(AH,1);return AI}}return null},toString:function(){return"APE.drag.Draggable(id="+this.id+")"}}}var O=I.DropTarget=E.createFactory(D,C);function D(Q){this.el=Q;this.id=Q.id}function C(){return{coords:F,dragOverClassName:"",initCoords:function(){if(!this.coords){this.coords={}}G.getOffsetCoords(this.el,document,this.coords);this.coords.w=this.el.clientWidth;this.coords.h=this.el.clientHeight},containsCoords:function(Q){var S=this.coords.x,R=this.coords.y;return(Q.x>=S&&Q.x<=S+this.coords.w)&&(Q.y>=R&&Q.y<=R+this.coords.h)},ondragover:false,ondragout:F,ondrop:F}}})();