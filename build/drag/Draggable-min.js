APE.namespace("APE.drag");(function(){var M=self.APE,P=M.dom,D=P.getStyle,O=M.drag,T=P.Event,R=1000,S={},B,C=Function.prototype,K=self.parseInt,N,H="function",G=M.createFactory(A,F),E=M.createFactory(I,Q);O.Draggable=G;O.DropTarget=E;G.instanceDestructor=L;function A(Z,U){var X=document,V=X.getElementById(Z),Y,W;this.id=Z;this.el=this.origEl=V;this.style=V.style;this.isRel=D(V,"position").toLowerCase()=="relative";Y=(this.isRel?V.parentNode:P.getContainingBlock(V));if(Y===null){Y=X.documentElement}this.container=Y;this.dropTargets=[];this.handle=V;this.onbeforeexitcontainer=J;if(U){for(W in U){this[W]=U[W]}V.style.zIndex=K(D(V,"zIndex"),10)||R++}}function J(){return !this.keepInContainer}function L(){var U,W,V;for(U in this.instances){V=this.instances[U];for(W in V){delete V[W]}delete this.instances[U]}S={}}function F(){var Af=document,Y=M.EventPublisher,Ah=Y.add,AQ=T.preventDefault,AO="documentElement",k=Af[AO].style,j="px",m="left",z="top",Ad=false,AE="setCapture" in document.documentElement,c=0,a=0,AM,AD=false,V=false,Ab=false,s=25,AF=-1,i="onmousedown",U="onmousemove",Ag="onmouseup",AI,AJ,AV=T.getCoords;if("ontouchstart" in Af){AI=true;i="ontouchstart";U="ontouchmove";Ag="ontouchend";Ah(Af,"ontouchcancel",Aa)}AJ=Y.get(Af,i);if("pixelLeft" in k){j=0;m="pixelLeft";z="pixelTop"}Ah(Af,"onkeydown",Aa);Ah(Af,Ag,h);AZ(Af,k);AJ.add(p).addAfter(g);Af=k=null;function AZ(Ap,Ao){var Am="serSelect",Aq="MozU"+Am,An="MozU"+Am,Aj="u"+Am,Al=Aq in k?Aq:An in k?An:Aj in k?Aj:"",d="onselectstart";if(d in Af){Ah(Af,d,Ak)}else{AJ.addAfter(Ak)}function Ak(As){var Ar=!AM;if(Al){this[AO].style[Al]=Ar?"":"none"}else{(As||window.event||0).returnValue=Ar}}}function AT(d,Aj){return Aj===d.handle||(d.useHandleTree&&P.contains(d.handle,Aj))}function Ac(d,Aj){if(Aj){if(d.selectedClassName){P.addClass(d.el,d.selectedClassName)}if(d.dragMultiple&&!(d.id in S)){S[d.id]=d}}else{if(d.selectedClassName){P.removeClass(d.el,d.selectedClassName)}delete S[d.id]}d.isSelected=Aj}function x(Ap){var Aj=Ap.container,Am=Ap.el,Aq=document,Al=Aq.documentElement,Ao=P.getContainingBlock(Am)||Al,An,Ar,Au=(Ao===Aj)?{x:0,y:0}:P.getOffsetCoords(Ao,Aj),Ak=P.getPixelCoords(Am),Av=P.getOffsetCoords(Am,Am.parentNode),At=Av.x-Ak.x+Au.x,As=Av.y-Ak.y+Au.y;if(Ap.keepInContainer){if(Aj===Aq.body){An=K(D(Aj,"width"),10);Ar=K(D(Aj,"height"),10)}else{An=Aj.clientWidth;Ar=Aj.clientHeight}Ap.minX=0-At;Ap.maxX=An-Am.offsetWidth-At;Ap.minY=0-As;Ap.maxY=Ar-Am.offsetHeight-As}}function AL(){t(Ac,[false],true);V=false}function X(Al){AG(AM);var Ak,Aj,d;if(AD!==false){for(Aj=0,d=AD.length;Aj<d;Aj++){Ak=AD[Aj];if(Ak.hasDropTargetOver){if(typeof Ak.ondragout==H){Ak.ondragout(Al,AM)}if(Ak.dragOverClassName){P.removeClass(Ak.el,Ak.dragOverClassName)}Ak.hasDropTargetOver=false}}}t(AG)}function Z(d,Aj){if(d.activeDragClassName){P.removeClass(d.el,d.activeDragClassName)}AN(d);if(AE){d.el.releaseCapture()}d.hasBeenDragged=false}function AW(d){if(AM.hasBeenDragged){if(AM.dragMultiple){S[AM.id]=AM}else{S={}}}Ad=false;Y.remove(document,U,AB);AM=null}function n(d,Aj){if(Aj){if(d.id in S){Ac(d,false)}else{Ac(d,true)}}else{if(!d.isSelected){AL();Ac(d,true)}}}function e(d){var Aj=d.el,Ak=d.copyEl;if(!Ak){Ak=d.copyEl=document.getElementById(d.proxyId)}AS(d,Ak,Aj)}function AP(d){if(!d.copyEl){d.copyEl=d.el.cloneNode(true);d.copyEl.id+="Copy"}AS(d,d.copyEl,d.el)}function AS(Aj,Am,Al){var d=Am.style;Aj.origEl=Al;d.zIndex=K(Al.style.zIndex,10)+100;Aj.el=Am;Aj.style=d;var Ak=D(Al,"display");d.display=Ak;if(Aj.dragCopy){Al.parentNode.insertBefore(Am,Al);if(Aj.isRel){v(d,Al,Ak)}}else{AK(Aj,Am,Al)}}function AK(d,Al,Ak){var Aj=P.getOffsetCoords(Ak,Al.parentNode);d.moveToX(Aj.x);d.moveToY(Aj.y)}function v(d,Ak,Aj){if(Aj=="inline"){d.marginRight=-Ak.offsetWidth+-(K(D(Ak,"marginRight"),10)||0)+"px"}else{d.marginBottom=-Ak.offsetHeight+-(K(D(Ak,"marginBottom"),10)||0)+"px"}}function Ai(d){var Aj=d.copyEl;if(!Aj){return}d.el=d.origEl;d.style=d.el.style;d.moveToX(d.x);d.moveToY(d.y);Aj.style.display="none";if(d.dragCopy&&!d.proxyId){d.el.parentNode.insertBefore(Aj,d.el)}}function AU(Aj,d){if(!V||Ab){return}t(AY,[Aj,d])}function AY(Ak,Aj,d){if(typeof Aj=="number"){Ak.moveToX(Ak.origX+Aj)}if(typeof d=="number"){Ak.moveToY(Ak.origY+d)}}function l(d,Aj){if(d.isBeingDragged){return}if(d.dragCopy&&!d.proxyId){AP(d)}if(typeof d.ondragstart==H){d.ondragstart(b(d,Aj))}if(AE){d.el.setCapture()}if(d.activeDragClassName){P.addClass(d.el,d.activeDragClassName)}x(d);d.isBeingDragged=true}function b(d,Al){var Am=d.id,Ak={},Aj=1;Ak[Am]=d;if(V){for(Am in S){Ak[Am]=S[Am];Aj++}}return{domEvent:Al,draggableList:Ak,count:Aj}}function p(Al){if(N){N=false;return}var d=Al||window.event;if(AI&&AM){return}Al=f(Al,"touches");var Ak=T.getTarget(d),Am=Al.metaKey||Al.ctrlKey,Aj=o(Ak);if(Aj){if(!Aj.isDragEnabled){if(!Am){AL()}return false}if(!Am&&Aj.hasHandleSet&&!AT(Aj,Ak)){AL();Aj=null;return}else{if(!Am&&!Aj.isSelected){AL()}Al.returnValue=false}}else{if(!Am){AL();if(AM){Ac(AM,false);AM=null}}return}if(Am&&AM&&!Aj.dragMultiple){Ad=true;return false}if(!Aj.dragMultiple){if(!Am){AL()}else{Ad=true;return false}}n(Aj,Am);Aj.style.zIndex=++R;if(Ae(Aj,Al)==false){return}AM=Aj;AQ(d);t(Ae,[Al]);return Ak.tagName!=="IMG"}function o(Aj){var d,Ak=G.instances;for(;!d&&Aj!==null;Aj=P.findAncestorWithAttribute(Aj,"id")){d=Ak[Aj.id]}return d}function g(){if(!AM){return}var Al=AM.dropTargets,Ak,Aj,Am,d;if(!Al){return AD=false}AD=[];for(Aj=Am=0,d=Al.length;Aj<d;Aj++){Ak=Al[Aj];Ak.initCoords();if(Ak.ondragover||Ak.ondragout||Ak.dragOverClassName){AD[Am++]=Ak}}if(Am===0){AD=false}}function Ae(d,Al){if(typeof d.onbeforedragstart==H&&d.onbeforedragstart(b(d,Al))==false){return false}var Ak=AV(Al),Aj;if(d.proxyId&&!d.dragCopy){e(d)}w(d);c=Ak.x;a=Ak.y;Aj=P.getPixelCoords(d.el);d.origX=d.grabX=Aj.x;d.origY=d.grabY=Aj.y;d.isBeingDragged=false;Ah(document,U,AB)}function w(d){var Aj=d.constraint;if(Aj==="y"){d.moveToX=C}else{if(Aj==="x"){d.moveToY=C}}}function AN(d){delete d.moveToX;delete d.moveToY}function AB(Ao){if(!AM){return}var Al=+new Date,As;if(Al-AF<s){return}AF=Al;As=Ao=Ao||event;if(AI){Ao=Ao.touches&&Ao.touches[0];if(!Ao){return}AQ(As)}var Aq=AV(Ao),Am=Aq.x,Ak=Aq.y,Ar=Am-c,Ap=Ak-a,d=AM.origX+Ar,At=AM.origY+Ap,Aj;if(AM.isBeingDragged===false){Ab=!!AM.proxyId;for(Aj in S){V=true;break}delete S[AM.id];l(AM,Ao);if(AM.proxyId&&AM.dragCopy){e(AM)}t(l,[Ao])}AM.hasBeenDragged=(AM.hasBeenDragged||!!(Ar||Ap));if(typeof AM.onbeforedrag==H&&AM.onbeforedrag(Ao)==false){return}var An=typeof AM.ondrag===H;if(!AX(AM,d,At,Ar,Ap,An,Ao)){AM.isAtLeft=AM.isAtRight=AM.isAtTop=AM.isAtBottom=false;AM.moveToX(d);AM.moveToY(At);AU(Ar,Ap);if(An){AM.ondrag(Ao)}}if(AD!==false){AA(AM,Ao,Am,Ak)}return false}function AX(Ar,d,Au,Ap,An,Ak,Am){if(Ar.container){var At=d<Ar.minX,Aq=d>Ar.maxX,Al=Au<Ar.minY,Ao=Au>Ar.maxY,Aj,As;if(At||Aq||Al||Ao&&Ar.onbeforeexitcontainer()!=true){if(At){if(!Ar.isAtLeft){Ar.moveToX(Ar.minX);AU(Ar.minX-Ar.origX,null);As=Ak;Ar.isAtRight=false;Ar.isAtLeft=true}Aj=true}else{if(Aq){if(!Ar.isAtRight){Ar.moveToX(Ar.maxX);AU(Ar.maxX-Ar.origX,null);As=Ak;Ar.isAtRight=true;Ar.isAtLeft=false}Aj=true}else{Ar.isAtLeft=Ar.isAtRight=false;Ar.moveToX(d);AU(Ap,null)}}if(Al){if(!Ar.isAtTop){Ar.moveToY(Ar.minY);AU(null,Ar.minY-Ar.origY);As=Ak;Ar.isAtTop=true;Ar.isAtBottom=false}Aj=true}else{if(Ao){if(!Ar.isAtBottom){if(Ar.maxY>0){Ar.moveToY(Ar.maxY)}AU(null,Ar.maxY-Ar.origY);As=Ak;Ar.isAtTop=false;Ar.isAtBottom=true}Aj=true}else{Ar.isAtTop=Ar.isAtBottom=false;Ar.moveToY(Au);AU(null,An)}}Ar[Aj&&!As?"ondragstop":"ondrag"](Am);return true}}return false}function h(Aj){N=false;Y.remove(document,U,AB);if(!AM){return}var d=AM.hasBeenDragged,Ak=(AM.isBeingDragged&&!d);Aj=f(Aj,"changedTouches");if(!AM.hasBeenDragged&&!Ak){if(!Ad){Ai(AM);AW(Aj)}return}if(!Ab){t(r)}t(Ai);Ai(AM);q(Aj);t(Z,[Aj]);S[AM.id]=AM;Z(AM,Aj);AM.ondragend({domEvent:Aj,draggableList:S});if(AM){AW(Aj)}}function r(Aj){var d=Aj.x,Ak=Aj.y;if(d<Aj.minX){Aj.moveToX(Aj.minX)}else{if(d>Aj.maxX){Aj.moveToX(Aj.maxX)}}if(Ak<Aj.minY){Aj.moveToY(Aj.minY)}else{if(Ak>Aj.maxY){Aj.moveToY(Aj.maxY)}}}function t(Al,Aj,Ak){if(!V&&!Ak){return}var Am,d;Aj=Aj||[];Aj.unshift(0);for(Am in S){d=Aj[0]=S[Am];Al.apply(d,Aj)}}function Aa(d){if(!AM){return}d=d||event;if(d.keyCode==27||d.type==="touchcancel"){AM.release(d)}}function AA(Aq,Ao,Ak,d){var Ar={x:Ak,y:d},An=0,Am=AD.length,Aj,Al,Ap={domEvent:Ao,dragObj:Aq};for(;An<Am;An++){Aj=AD[An];Al=Aj.containsCoords(Ar);if(!Aj.hasDropTargetOver&&Al){Aj.hasDropTargetOver=true;if(typeof Aj.ondragover==H){Aj.ondragover(Ap)}if(Aj.dragOverClassName){P.addClass(Aj.el,Aj.dragOverClassName)}}else{if(Aj.hasDropTargetOver&&!Al){if(typeof Aj.ondragout==H){Aj.ondragout(Ap)}if(Aj.dragOverClassName){P.removeClass(Aj.el,Aj.dragOverClassName)}Aj.hasDropTargetOver=false}}}}function q(Al){var Aj=AM.dropTargets,Ao,Am,d=Aj.length,Ak,An;if(d){Am=AV(Al);for(Ak=0;Ak<d;Ak++){Ao=Aj[Ak];if(typeof Ao.ondrop===H&&Ao.containsCoords(Am)){Ao.ondrop(AH(Al,AM));t(AC,[Ao,Al])}An=Ao.dragOverClassName;if(An){P.removeClass(Ao.el,An)}}}}function AH(Aj,d){return{domEvent:Aj,dragObj:d}}function AC(d,Ak,Aj){if(d.id!==Ak.id){Ak.ondrop(AH(Aj,d))}}function f(Aj,d){return Aj&&Aj[d]&&Aj[d][0]||Aj||event}function u(Aj){var Ak=M.anim,d=new Ak.Animation(0.2);d.transition=Ak.Transitions.accel;d.run=y;d.dObj=Aj;d.onplay=Aj.onglide;d.onend=W;d.start()}function y(Al){var Aj=this.dObj,Ak=Aj.x-Aj.grabX,d=Aj.y-Aj.grabY;Al=Math.pow(Al,3);Aj.moveToX(Aj.x-(Ak*Al));Aj.moveToY(Aj.y-(d*Al))}function W(){AR(this.dObj)}function AR(d){if(typeof d.onglideend==H){d.onglideend()}Ai(d)}function AG(d){if(M.anim&&d.useAnim){u(d)}else{d.moveToX(d.grabX);d.moveToY(d.grabY);if(typeof d.onglide==H){d.onglide()}AR(d,{})}}return{dragCopy:false,useAnim:true,dragMultiple:false,selectedClassName:"",activeDragClassName:"",useHandleTree:true,isSelected:false,onbeforedrag:B,onbeforedragstart:C,ondragstart:B,ondrag:B,ondragstop:C,ondragend:C,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,keepInContainer:false,isDragEnabled:true,hasHandleSet:false,setHandle:function(d,Aj){this.handle=d;this.hasHandleSet=true;this.useHandleTree=Aj!=false},dropTargets:false,addDropTarget:function(Al){var Aj=E.getByNode(Al),d=Aj.el,Ak=this.dropTargets;if(this.el===d){return Aj}return Ak[Ak.length]=E.getByNode(d)},grab:function(Ap,Ar,Al){Ap=Ap||window.event;var Aq=T.getTarget(Ap),Ak;AQ(Ap);if(P.contains(this.el,Aq)){return}Ak=P.getPixelCoords(this.el);this.grabX=Ak.x;this.grabY=Ak.y;var As=AV(Ap),Ao=this.handle,Aj=P.getOffsetCoords(P.getContainingBlock(this.el)),An=As.x-Aj.x,d=An-(0|Ao.offsetWidth/2),Am=As.y-Aj.y,Au=(Am-(0|Ao.offsetHeight/2)),At=P.getOffsetCoords(Ao,this.el);if(this.keepInContainer){d=Math.max(d,0);d=Math.min(d,this.container.clientWidth-this.el.offsetWidth);Au=Math.max(Au,0);Au=Math.min(Au,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(d-At.x+(Ar||0));this.moveToY(Au-At.y+(Al||0));Ae(this,Ap);N=true;AM=this},release:function(d){d=d||{};t(Z,[d]);if(typeof this.onrelease==H){this.onrelease(d)}X(d);AW(d)},moveToX:function(d){this.style[m]=(this.x=d)+j},moveToY:function(d){this.style[z]=(this.y=d)+j},removeDropTarget:function(Al){var Al=document.getElementById(Al.id),Aj=this.dropTargets,Ak,d;for(Ak=0,d=Aj.length;Ak<d;Ak++){if(Aj[Ak].el===Al){Aj.splice(Ak,1);return Al}}return null},toString:function(){return"Draggable(id="+this.id+")"}}}function I(U){this.el=document.getElementById(U);this.id=U}function Q(){return{dragOverClassName:"",initCoords:function(){var V=this.coords||(this.coords={}),U=this.el;P.getOffsetCoords(U,document,V);V.w=U.clientWidth;V.h=U.clientHeight},containsCoords:function(V){var U=this.coords,X=U.x,W=U.y;return(V.x>=X&&V.x<=X+U.w)&&(V.y>=W&&V.y<=W+U.h)},ondragover:false,ondragout:B,ondrop:B}}})();