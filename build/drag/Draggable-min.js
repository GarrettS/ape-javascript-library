APE.namespace("APE.drag");
(function(){function ra(j,k){var l=document,n=l.getElementById(j),p;this.id=j;this.el=this.origEl=n;this.style=n.style;j=(this.isRel=x(n,"position").toLowerCase()=="relative")?n.parentNode:i.getContainingBlock(n);if(j===null)j=l.documentElement;this.container=j;this.dropTargets=[];this.handle=n;this.onbeforeexitcontainer=sa;if(k){for(p in k)this[p]=k[p];n.style.zIndex=A(x(n,"zIndex"),10)||X++}}function sa(){return!this.keepInContainer}function ta(){var j,k,l;for(j in this.instances){l=this.instances[j];
for(k in l)delete l[k];delete this.instances[j]}m={}}function ua(){function j(){function a(h){var g=!c;if(f)this[Y].style[f]=g?"":"none";else(h||window.event||0).returnValue=g}var b="serSelect",d="MozU"+b,e="MozU"+b;b="u"+b;var f=d in B?d:e in B?e:b in B?b:"";d="onselectstart";d in q?C(q,d,a):M.addAfter(a)}function k(a,b){return b===a.handle||a.useHandleTree&&i.contains(a.handle,b)}function l(a,b){if(b){a.selectedClassName&&i.addClass(a.el,a.selectedClassName);if(a.dragMultiple&&!(a.id in m))m[a.id]=
a}else{a.selectedClassName&&i.removeClass(a.el,a.selectedClassName);delete m[a.id]}a.isSelected=b}function n(a){var b=a.container,d=a.el,e=document,f=e.documentElement;f=i.getContainingBlock(d)||f;var h=f===b?{x:0,y:0}:i.getOffsetCoords(f,b),g=i.getPixelCoords(d),t=i.getOffsetCoords(d,d.parentNode);f=t.x-g.x+h.x;h=t.y-g.y+h.y;if(a.keepInContainer){if(b===e.body){e=A(x(b,"width"),10);b=A(x(b,"height"),10)}else{e=b.clientWidth;b=b.clientHeight}a.minX=0-f;a.maxX=e-d.offsetWidth-f;a.minY=0-h;a.maxY=b-
d.offsetHeight-h}}function p(){r(l,[false],true);D=false}function va(a){Z(c);var b,d,e;if(s!==false){d=0;for(e=s.length;d<e;d++){b=s[d];if(b.hasDropTargetOver){typeof b.ondragout==o&&b.ondragout(a,c);b.dragOverClassName&&i.removeClass(b.el,b.dragOverClassName);b.hasDropTargetOver=false}}}r(Z)}function N(a){a.activeDragClassName&&i.removeClass(a.el,a.activeDragClassName);wa(a);a.hasBeenDragged=false}function $(){if(c.hasBeenDragged)if(c.dragMultiple)m[c.id]=c;else m={};G=false;H.remove(document,I,
O);c=null}function xa(a,b){if(b)a.id in m?l(a,false):l(a,true);else if(!a.isSelected){p();l(a,true)}}function aa(a){var b=a.el,d=a.copyEl;if(!d)d=a.copyEl=document.getElementById(a.proxyId);ba(a,d,b)}function ya(a){if(!a.copyEl){a.copyEl=a.el.cloneNode(true);a.copyEl.id+="Copy"}ba(a,a.copyEl,a.el)}function ba(a,b,d){var e=b.style;a.origEl=d;e.zIndex=A(d.style.zIndex,10)+100;a.origClassName&&i.addClass(d,a.origClassName);a.el=b;a.style=e;var f=x(d,"display");e.display=f;if(a.dragCopy){d.parentNode.insertBefore(b,
d);a.isRel&&za(e,d,f)}else Aa(a,b,d)}function Aa(a,b,d){b=i.getOffsetCoords(d,b.parentNode);a.moveToX(b.x);a.moveToY(b.y)}function za(a,b,d){if(d=="inline")a.marginRight=-b.offsetWidth+-(A(x(b,"marginRight"),10)||0)+"px";else a.marginBottom=-b.offsetHeight+-(A(x(b,"marginBottom"),10)||0)+"px"}function P(a){a.el=a.origEl;a.style=a.el.style;a.moveToX(a.x);a.moveToY(a.y);if(a.copyEl)a.copyEl.style.display="none";a.origClassName&&i.removeClass(a.el,a.origClassName);a.dragCopy&&!a.proxyId&&a.el.parentNode.insertBefore(a.copyEl,
a.el)}function y(a,b){!D||Q||r(Ba,[a,b])}function Ba(a,b,d){typeof b=="number"&&a.moveToX(a.origX+b);typeof d=="number"&&a.moveToY(a.origY+d)}function ca(a,b){if(!a.isBeingDragged){a.dragCopy&&!a.proxyId&&ya(a);typeof a.ondragstart==o&&a.ondragstart(da(a,b));a.activeDragClassName&&i.addClass(a.el,a.activeDragClassName);n(a);a.isBeingDragged=true}}function da(a,b){var d=a.id,e={},f=1;e[d]=a;if(D)for(d in m){e[d]=m[d];f++}return{domEvent:b,draggableList:e,count:f}}function Ca(a){if(J)J=false;else{var b=
a||window.event;if(!(R&&c)){a=ea(a,"touches");for(var d=K.getTarget(b),e=S.instances,f,h=d,g=a.metaKey||a.ctrlKey;!f&&h!==null;){f=e[h.id];h=i.findAncestorWithAttribute(h,"id")}if(f){if(!f.isDragEnabled){g||p();return false}if(!g&&f.hasHandleSet&&!k(f,d))p();else{!g&&!f.isSelected&&p();a.returnValue=false;if(g&&c&&!f.dragMultiple){G=true;return false}if(!f.dragMultiple)if(g){G=true;return false}else p();xa(f,g);f.style.zIndex=++X;if(T(f,a)!=false){c=f;U(b);r(T,[a]);return d.tagName!=="IMG"}}}else if(!g){p();
if(c){l(c,false);c=null}}}}}function Da(){if(c){s=[];for(var a=c.dropTargets,b,d=0,e=a.length;d<e;d++){b=a[d];b.initCoords();if(typeof b.ondragover==o||typeof b.ondragout==o||b.dragOverClassName)s.push(b)}if(s.length===0)s=false}}function T(a,b){if(typeof a.onbeforedragstart==o&&a.onbeforedragstart(da(a,b))==false)return false;b=L(b);a.proxyId&&!a.dragCopy&&aa(a);Ea(a);fa=b.x;ga=b.y;b=i.getPixelCoords(a.el);a.origX=a.grabX=b.x;a.origY=a.grabY=b.y;a.isBeingDragged=false;C(document,I,O)}function Ea(a){var b=
a.constraint;if(b=="y")a.moveToX=E;else if(b=="x")a.moveToY=E}function wa(a){delete a.moveToX;delete a.moveToY}function O(a){if(c){var b=+new Date;if(!(b-ha<Fa)){ha=b;b=a=a||event;if(R){a=a.touches&&a.touches[0];if(!a)return;U(b)}var d=L(a);b=d.x;d=d.y;var e=b-fa,f=d-ga,h=c.origX+e,g=c.origY+f,t;if(c.isBeingDragged===false){Q=!!c.proxyId;for(t in m){D=true;break}delete m[c.id];ca(c,a);c.proxyId&&c.dragCopy&&aa(c);r(ca,[a])}c.hasBeenDragged=c.hasBeenDragged||!!(e||f);t=h<c.minX;var v=h>c.maxX,u=g<
c.minY,w=g>c.maxY,ia=typeof c.ondrag===o;if(!(typeof c.onbeforedrag==o&&c.onbeforedrag(a)==false)){if(c.container!=null&&t||v||u||w&&c.onbeforeexitcontainer()!=true)Ga(t,v,u,w,h,g,e,f,ia,a);else{c.isAtLeft=c.isAtRight=c.isAtTop=c.isAtBottom=false;c.moveToX(h);c.moveToY(g);y(e,f);ia&&c.ondrag(a)}s!==false&&Ha(c,a,b,d);return false}}}}function Ia(a){J=false;H.remove(document,I,O);if(c){var b=c.hasBeenDragged;b=c.isBeingDragged&&!b;if(!c.hasBeenDragged&&!b)G||(c=null);else{a=ea(a,"changedTouches");Q||
r(Ja);r(P);P(c);Ka(a);r(N,[a]);m[c.id]=c;N(c,a);c.ondragend({domEvent:a,draggableList:m});c&&$(a)}}}function Ga(a,b,d,e,f,h,g,t,v,u){var w=0;if(a){if(!c.isAtLeft){c.moveToX(c.minX);y(c.minX-c.origX,null);v&&c.ondrag(u);c.isAtRight=false;c.isAtLeft=true}w+=1}else if(b){if(!c.isAtRight){c.moveToX(c.maxX);y(c.maxX-c.origX,null);v&&c.ondrag(u);c.isAtRight=true;c.isAtLeft=false}w+=1}else{c.isAtLeft=c.isAtRight=false;c.moveToX(f);y(g,null)}if(d){if(!c.isAtTop){c.moveToY(c.minY);y(null,c.minY-c.origY);v&&
c.ondrag(u);c.isAtTop=true;c.isAtBottom=false}w+=1}else if(e){if(!c.isAtBottom){c.maxY>0&&c.moveToY(c.maxY);y(null,c.maxY-c.origY);v&&c.ondrag(u);c.isAtTop=false;c.isAtBottom=true}w+=1}else{c.isAtTop=c.isAtBottom=false;c.moveToY(h);y(null,t)}if(w>=1)c.ondragstop(u);else v&&c.ondrag(u)}function Ja(a){var b=a.x,d=a.y;if(b<a.minX)a.moveToX(a.minX);else b>a.maxX&&a.moveToX(a.maxX);if(d<a.minY)a.moveToY(a.minY);else d>a.maxY&&a.moveToY(a.maxY)}function r(a,b,d){if(D||d){var e;b=b||[];b.unshift(0);for(e in m){d=
b[0]=m[e];a.apply(d,b)}}}function ja(a){if(c){a=a||event;if(a.keyCode==27||a.type==="touchcancel")c.release(a)}}function Ha(a,b,d,e){d={x:d,y:e};e=0;for(var f=s.length,h={domEvent:b,dragObj:a};e<f;e++){a=s[e];b=a.containsCoords(d);if(!a.hasDropTargetOver&&b){a.hasDropTargetOver=true;typeof a.ondragover==o&&a.ondragover(h);a.dragOverClassName&&i.addClass(a.el,a.dragOverClassName)}else if(a.hasDropTargetOver&&!b){typeof a.ondragout==o&&a.ondragout(h);a.dragOverClassName&&i.removeClass(a.el,a.dragOverClassName);
a.hasDropTargetOver=false}}}function Ka(a){var b=c.dropTargets,d,e,f=b.length,h,g;if(f){e=L(a);for(h=0;h<f;h++){d=b[h];if(typeof d.ondrop===o&&d.containsCoords(e)){d.ondrop(ka(a,c));r(La,[d,a])}(g=d.dragOverClassName)&&i.removeClass(d.el,g)}}}function ka(a,b){return{domEvent:a,dragObj:b}}function La(a,b,d){a.id!==b.id&&b.ondrop(ka(d,a))}function ea(a,b){return a&&a[b]&&a[b][0]||a||event}function Ma(a){var b=z.anim,d=new b.Animation(0.2);d.transition=b.Transitions.accel;d.run=Na;d.dObj=a;d.onplay=
a.onglide;d.onend=Oa;d.start()}function Na(a){var b=this.dObj,d=b.x-b.grabX,e=b.y-b.grabY;a=Math.pow(a,3);b.moveToX(b.x-d*a);b.moveToY(b.y-e*a)}function Oa(){la(this.dObj)}function la(a){typeof a.onglideend==o&&a.onglideend();P(a)}function Z(a){if(z.anim&&a.useAnim)Ma(a);else{a.moveToX(a.grabX);a.moveToY(a.grabY);typeof a.onglide==o&&a.onglide();la(a,{})}}var q=document,H=z.EventPublisher,C=H.add,U=K.preventDefault,Y="documentElement",B=q[Y].style,V="px",ma="left",na="top",G=false,fa=0,ga=0,c,s=false,
D=false,Q=false,Fa=25,ha=-1,oa="onmousedown",I="onmousemove",pa="onmouseup",R,M,L=K.getCoords;if("ontouchstart"in q){R=true;oa="ontouchstart";I="ontouchmove";pa="ontouchend";C(q,"ontouchcancel",ja)}M=H.get(q,oa);if("pixelLeft"in B){V=0;ma="pixelLeft";na="pixelTop"}C(q,"onkeydown",ja);C(q,pa,Ia);j(q,B);M.add(Ca).addAfter(Da);q=B=null;return{dragCopy:false,useAnim:true,dragMultiple:false,selectedClassName:"",activeDragClassName:"",useHandleTree:true,isSelected:false,onbeforedrag:F,onbeforedragstart:E,
ondragstart:F,ondrag:F,ondragstop:E,ondragend:E,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,keepInContainer:false,isDragEnabled:true,hasHandleSet:false,setHandle:function(a,b){this.handle=a;this.hasHandleSet=true;this.useHandleTree=b!=false},dropTargets:false,addDropTarget:function(a){a=W.getByNode(a);var b=a.el,d=this.dropTargets;if(this.el===b)return a;return d[d.length]=W.getByNode(b)},grab:function(a,b,d){a=a||window.event;var e=K.getTarget(a);U(a);if(!i.contains(this.el,e)){e=i.getPixelCoords(this.el);
this.grabX=e.x;this.grabY=e.y;var f=L(a);e=this.handle;var h=i.getOffsetCoords(i.getContainingBlock(this.el)),g=f.x-h.x;g=g-(0|e.offsetWidth/2);f=f.y-h.y;f=f-(0|e.offsetHeight/2);e=i.getOffsetCoords(e,this.el);if(this.keepInContainer){g=Math.max(g,0);g=Math.min(g,this.container.clientWidth-this.el.offsetWidth);f=Math.max(f,0);f=Math.min(f,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(g-e.x+(b||0));this.moveToY(f-e.y+(d||0));T(this,a);J=true;c=this}},release:function(a){a=a||{};r(N,
[a]);typeof this.onrelease==o&&this.onrelease(a);va(a);$(a)},moveToX:function(a){this.style[ma]=(this.x=a)+V},moveToY:function(a){this.style[na]=(this.y=a)+V},removeDropTarget:function(a){a=document.getElementById(a.id);var b=this.dropTargets,d,e;d=0;for(e=b.length;d<e;d++)if(b[d].el===a){b.splice(d,1);return a}return null},toString:function(){return"Draggable(id="+this.id+")"}}}function Pa(j){this.el=document.getElementById(j);this.id=j}function Qa(){return{dragOverClassName:"",initCoords:function(){var j=
this.coords||(this.coords={}),k=this.el;i.getOffsetCoords(k,document,j);j.w=k.clientWidth;j.h=k.clientHeight},containsCoords:function(j){var k=this.coords,l=k.x,n=k.y;return j.x>=l&&j.x<=l+k.w&&j.y>=n&&j.y<=n+k.h},ondragover:false,ondragout:F,ondrop:F}}var z=self.APE,i=z.dom,x=i.getStyle,qa=z.drag,K=i.Event,X=1E3,m={},F,E=Function.prototype,A=self.parseInt,J,o="function",S=z.createFactory(ra,ua),W=z.createFactory(Pa,Qa);qa.Draggable=S;qa.DropTarget=W;S.instanceDestructor=ta})();
