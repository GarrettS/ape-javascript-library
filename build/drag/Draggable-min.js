APE.namespace("APE.drag");(function(){var F=self.APE,G=F.dom,I=F.drag,J=F.EventPublisher,K=1000,L={},B=F.createFactory(N,M);I.Draggable=B;B.instanceDestructor=H;function N(Q){this.id=Q.id;this.el=this.origEl=Q;this.style=Q.style;this.isRel=G.getStyle(Q,"position").toLowerCase()=="relative";this.container=(this.isRel?Q.parentNode:G.getContainingBlock(Q));this.dropTargets=[];this.handle=Q;this.onbeforeexitcontainer=A;Q.style.zIndex=G.getStyle(Q,"zIndex")||K++;P(Q)}function A(){return !this.keepInContainer}function H(){var Q,S,R;for(Q in this.instances){R=this.instances[Q];for(S in R){if(R.hasOwnProperty(S)){delete R[S]}}delete this.instances[Q]}L={};dO=null}function P(W){var V=W.style,U,Q=G.getContainingBlock(W);if(G.IS_COMPUTED_STYLE){U=document.defaultView.getComputedStyle(W,"")}else{U=W.currentStyle||V}var S=U.left,X=U.right,T=U.top,R=U.bottom;if((S===""||S==="auto")){X=parseInt(X,10);if(isFinite(X)){V.left=Q.clientWidth-W.offsetWidth-X+"px"}else{V.left="0"}}if((T===""||T==="auto")){R=parseInt(R,10);if(isFinite(R)){V.top=Q.clientHeight-W.offsetHeight-R+"px"}else{V.top="0"}}}function M(){var v=self.document,m=v.documentElement.style,y="serSelect",q="MozU"+y,j="MozU"+y,Z="u"+y,Y=q in m?q:j in m?j:Z in m?Z:"",w="unselectable" in v.documentElement,U="px",g="left",h="top",e=0,c=0,X,l=0,i=-1,n=G.Event.getCoords;if("onselectstart" in v){J.get(v,"onselectstart").addBefore(T)}else{J.get(v,"onmousedown").addAfter(T);J.get(v,"onmouseup").addAfter(T)}if("pixelLeft" in m){U=0;g="pixelLeft";h="pixelTop"}J.add(v,"onmousedown",x);J.add(v,"onkeypress",a);J.add(v,"onmousemove",R);J.add(v,"onmouseup",t);function T(d){if(Y){this.documentElement.style[Y]=X?"none":""}else{if(!d){window.event.returnValue=false}}}v=m=null;function b(d,AA){return AA===d.handle||(d.useHandleTree&&G.contains(d.handle,AA))}function o(d,AA){if(AA){if(d.selectedClassName){G.addClass(d.el,d.selectedClassName)}if(d.dragMultiple&&!(d.id in L)){L[d.id]=d}}else{if(d.selectedClassName){G.removeClass(d.el,d.selectedClassName)}delete L[d.id]}d.isSelected=Boolean(AA)}function Q(AE,AD){var d=AD.container,AA=AD.el,AC=G.getContainingBlock(AA),AH=G.getOffsetCoords(AC,d),AB=G.getPixelCoords(AA),AI=G.getOffsetCoords(AA,AA.parentNode),AG=AI.x-AB.x+AH.x,AF=AI.y-AB.y+AH.y;if(AD.keepInContainer){AD.minX=0-AG;AD.maxX=d.clientWidth-AD.el.offsetWidth-AG;AD.minY=0-AF;AD.maxY=d.clientHeight-AD.el.offsetHeight-AF}}function k(){for(var d in L){o(L[d],false)}}function S(){for(var d in L){return true}return false}function s(AC,AF){AF.animateBack();var AD=G.removeClass,AB,AA=0,d=AF._dragOverTargets.length,AE;if(AF._dragOverTargets!==false){for(;AA<d;AA++){AB=AF._dragOverTargets[AA];if(AB.hasDropTargetOver){if(typeof AB.ondragout=="function"){AB.ondragout(AC,AF)}if(AB.dragOverClassName){AD(AB.el,AB.dragOverClassName)}AB.hasDropTargetOver=false}}}for(AE in L){L[AE].animateBack()}AF=null}function r(d,AA){if(d.activeDragClassName){G.removeClass(d.el,d.activeDragClassName)}if(typeof d.ondragend=="function"&&d.hasBeenDragged){d.ondragend(AA)}if(d.copyEl){d.el.parentNode.insertBefore(d.copyEl,d.el)}d.hasBeenDragged=false}function W(d,AA){if(AA){if(d.id in L){o(d,false)}else{o(d,true)}}else{if(!d.isSelected){k();o(d,true)}}}function f(AA){var AC="addClass",AE,AB=AA.el,AD=AB,d;if(!AA.copyEl){AA.origEl=AB;AA.copyEl=AB.cloneNode(true);AA.copyEl.id+="Copy"}AE=AA.copyEl;d=AE.style;d.display="";if(AE.parentNode!==AB.parentNode){AB.parentNode.insertBefore(AE,AB)}d.zIndex=parseInt(AD.style.zIndex)+100;if(AA.origClassName){G[AC](AB,AA.origClassName)}AA.el=AE;AA.style=d;if(AA.isRel){d.marginBottom=-AD.offsetHeight+-(parseInt(G.getStyle(AD,"marginBottom"))||0)+"px";d.marginright=-AD.offsetWidth+-(parseInt(G.getStyle(AD,"marginRight"))||0)+"px"}}function z(d){if(d.copyEl.style.display=="none"){return}d.el=d.origEl;d.style=d.origEl.style;d.moveToX(d.x);d.moveToY(d.y);d.copyEl.style.display="none";if(d.origClassName){G.removeClass(d.el,d.origClassName)}}function V(AA,d){var AB,AC;for(AC in L){AB=L[AC];if(AA!=null){AB.moveToX(AB.origX+AA)}if(d!=null){AB.moveToY(AB.origY+d)}}}function u(d,AA){if(d.isBeingDragged){return}if(d.dragCopy){f(d)}if(typeof d.ondragstart=="function"){d.ondragstart(AA)}if(d.activeDragClassName){G.addClass(d.el,d.activeDragClassName)}Q(AA,d);d.isBeingDragged=true}function x(AD){if(!AD){AD=self.event}var AC=G.Event.getTarget(AD),AA=null,AB=B.instances,d=AC;for(;AA==null&&d;d=G.findAncestorWithAttribute(d,"id")){AA=AB[d.id]}var AE=AD.metaKey||(/Win/.test(navigator.platform)&&AD.ctrlKey);if(AA){if(!AA.isDragEnabled){if(!AE){k()}return false}if(!AE&&AA.hasHandleSet&&!b(AA,AC)){k();AA=null;return}else{if(!AE&&!AA.isSelected){k()}AD.returnValue=false}}else{if(!AE){k();if(X){o(X,false);X=null}}return}if(AE&&X&&!AA.dragMultiple){return false}if(!AA.dragMultiple){if(!AE){k()}else{return false}}W(AA,AE);AA.style.zIndex=++K;if(AE){}C(AA);p(AD,AA);for(var AF in L){p(AD,L[AF])}X=AA;return AC.tagName!=="IMG"}function p(AC,d){if(typeof d.onbeforedragstart=="function"&&d.onbeforedragstart(AC)==false){return true}var AB=G.Event.getCoords(AC),AA;e=AB.x;c=AB.y;AA=G.getPixelCoords(d.el);d.origX=d.grabX=AA.x;d.origY=d.grabY=AA.y;d.isBeingDragged=false}function R(AS){if(X==null){return}var AC=+new Date;if(AC-i<l){return}i=AC;AS=AS||window.event;var AF=n(AS),AN=AF.x,AL=AF.y,AJ=AN-e,AH=AL-c;if(X.isBeingDragged==false){u(X,AS);for(var AK in L){u(L[AK],AS)}}X.newX=X.origX+AJ;X.newY=X.origY+AH;X.hasBeenDragged=(X.hasBeenDragged||(AJ||AH));var AD=X.newX<X.minX,AA=X.newX>X.maxX,AU=X.newY<X.minY,AM=X.newY>X.maxY;if(typeof X.onbeforedrag=="function"&&X.onbeforedrag(AS)==false){return}var d=X.container!=null,AV=(typeof X.ondrag=="function"),AB=typeof X.onbeforeexitcontainer=="function",AT=0;d&=(AD||AA||AU||AM);if(d&&(AB||X.onbeforeexitcontainer()==false)){if(AD){if(!X.isAtLeft){X.moveToX(X.minX);V(X.minX-X.origX,null);if(AV){X.ondrag(AS)}X.isAtRight=false;X.isAtLeft=true;AT+=1}}else{if(AA){if(!X.isAtRight){X.moveToX(X.maxX);V(X.maxX-X.origX,null);if(AV){X.ondrag(AS)}X.isAtRight=true;X.isAtLeft=false;AT+=1}}else{X.isAtLeft=X.isAtRight=false;X.moveToX(X.newX);V(AJ,null)}}if(AU){if(!X.isAtTop){X.moveToY(X.minY);V(null,X.minY-X.origY);if(AV){X.ondrag(AS)}X.isAtTop=true;X.isAtBottom=false;AT+=1}}else{if(AM){if(!X.isAtBottom){if(X.maxY>0){X.moveToY(X.maxY)}V(null,X.maxY-X.origY);if(AV){X.ondrag(AS)}X.isAtTop=false;X.isAtBottom=true;AT+=1}}else{X.isAtTop=X.isAtBottom=false;X.moveToY(X.newY);V(null,AH)}}X.isDragStopped=AT==2;if(X.isDragStopped&&typeof X.ondragstop=="function"){X.ondragstop(AS)}else{if(AV){X.ondrag(AS)}}}else{X.isDragStopped=X.isAtLeft=X.isAtRight=X.isAtTop=X.isAtBottom=false;X.moveToX(X.newX);X.moveToY(X.newY);V(AJ,AH);if(AV){X.ondrag(AS)}}var AO=X._dragOverTargets;if(AO!==false){var AR={x:AN,y:AL},AQ=0,AP=AO.length,AI,AG,AE={domEvent:AS,dragObj:X};for(;AQ<AP;AQ++){AI=AO[AQ],AG=AI.containsCoords(AR);if(!AI.hasDropTargetOver&&AG){AI.hasDropTargetOver=true;if(typeof AI.ondragover=="function"){AI.ondragover(AE)}if(AI.dragOverClassName){G.addClass(AI.el,AI.dragOverClassName)}}else{if(AI.hasDropTargetOver&&!AG){if(typeof AI.ondragout=="function"){AI.ondragout(AE)}if(AI.dragOverClassName){G.removeClass(AI.el,AI.dragOverClassName)}AI.hasDropTargetOver=false}}}}return false}function t(AG){var AB=(X&&X.isBeingDragged&&!X.hasBeenDragged);if(X===null||!X.hasBeenDragged&&!AB){return}if(!AG){AG=event}var AA,AK;if(X.copyEl){z(X)}for(AA in L){AK=L[AA];if(AK.copyEl){z(AK)}}var AE=X.dropTargets,AF=AE.length,AC,AJ,AH;if(AF>0){var AI=n(AG),d,AD=0;for(;AD<AF;AD++){d=AE[AD];if(d.containsCoords(AI)){d.containsCoords(AI);if(typeof d.ondrop=="function"){d.ondrop({domEvent:AG,dragObj:X,dropTarget:d})}for(AA in L){if(AA===d.id){continue}if(typeof d.ondrop=="function"){AC=L[AA];d.ondrop({domEvent:AG,dragObj:AC,dropTarget:d})}}if(d.dragOverClassName){G.removeClass(d.el,d.dragOverClassName)}break}}}for(AA in L){AC=L[AA],AJ=AC.x,AH=AC.y;if(AJ<AC.minX){AC.moveToX(AC.minX)}else{if(AJ>AC.maxX){AC.moveToX(AC.maxX)}}if(AH<AC.minY){AC.moveToY(AC.minY)}else{if(AH>AC.maxY){AC.moveToY(AC.maxY)}}if(AC.hasBeenDragged){r(AC,AG)}}r(X,AG);X=null}function a(d){d=d||self.event;if(d.keyCode==27){if(X){X.release(d)}}}return{dragCopy:false,dragMultiple:false,isSelected:false,_dragOverTargets:false,onbeforedrag:undefined,onbeforedragstart:undefined,ondragstart:undefined,ondrag:undefined,ondragstop:undefined,ondragend:undefined,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,newX:0,newY:0,keepInContainer:false,isDragEnabled:true,selectedClassName:"",activeDragClassName:"",useHandleTree:true,hasHandleSet:false,setHandle:function(d,AA){this.handle=d;this.hasHandleSet=true;this.useHandleTree=AA!=false},addDropTarget:function(AC){var AA=O.getByNode(AC),d=AA.el,AB=this.dropTargets;if(this.el===d){return AA}return AB[AB.length]=O.getByNode(d)},grab:function(AF,AH,AC){if(!AF){AF=self.event}var AJ=G.Event,AG=AJ.getTarget(AF);if(AF.preventDefault){AF.preventDefault()}AF.returnValue=false;if(G.contains(this.el,AG)){return}var AB=G.getPixelCoords(this.el);this.grabX=AB.x;this.grabY=AB.y;var AI=AJ.getCoords(AF),AA=G.getOffsetCoords(G.getContainingBlock(this.el)),AD=AI.y-AA.y,AL=Math.floor(AD-(this.handle.offsetHeight/2)),AK=G.getOffsetCoords(this.handle,this.el);var AE=AI.x-AA.x,d=AE-Math.floor((this.handle.offsetWidth/2));if(this.keepInContainer){d=Math.max(d,0);d=Math.min(d,this.container.clientWidth-this.el.offsetWidth);AL=Math.max(AL,0);AL=Math.min(AL,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(d-AK.x+(AH||0));this.moveToY(AL-AK.y+(AC||0));p(AF,this);X=this},_dragOverTargets:false,release:function(d){s(d,this);if(typeof this.onrelease=="function"){this.onrelease(d)}},moveToX:function(d){this.style[g]=(this.x=d)+U},moveToY:function(d){this.style[h]=(this.y=d)+U},glideStart:function(d,AC){if(this.animTimer){return}this.startX=d;this.startY=AC;var AB=this.startX-this.grabX,AA=this.startY-this.grabY;this.glideDist=Math.ceil(Math.sqrt((AB*AB)+(AA*AA)));if(this.glideDist===0){return}this.rx=Math.abs(AB)/this.glideDist;this.ry=Math.abs(AA)/this.glideDist;if(this.x>this.grabX){this.rx=-this.rx}if(this.y>this.grabY){this.ry=-this.ry}this.startTime=+new Date;this.animTimer=self.setInterval("APE.drag.Draggable.instances['"+this.id+"'].glide()",10)},glide:function(){var AA=new Date-this.startTime,AB=Math.ceil(2*AA+0.5*0.01*AA*AA);if(AB>=this.glideDist){this.animTimer=self.clearInterval(this.animTimer);this.moveToX(this.grabX);this.moveToY(this.grabY);if(this.copyEl){this.el=this.origEl;this.style=this.origEl.style;this.copyEl.style.display="none"}if(typeof this.onglide=="function"){this.onglide()}if(typeof this.onglideend=="function"){this.onglideend()}r(this,{})}else{this.moveToX(this.startX+AB*this.rx);this.moveToY(this.startY+AB*this.ry);if(typeof this.onglide=="function"){this.onglide()}}},animateBack:function(d,AA){this.glideStart(d||this.x,AA||this.y)},removeDropTarget:function(AB){AB=document.getElementById(AB.id);for(var AA=0,d=this.dropTargets.length;AA<d;AA++){if(this.dropTargets[AA].el===AB){this.dropTargets.splice(AA,1);return AB}}return null},toString:function(){return"APE.drag.Draggable(id="+this.id+")"}}}function C(U){U._dragOverTargets=[];var T=U.dropTargets,S,R=0,Q=T.length;for(;R<Q;R++){S=T[R];S.initCoords();if(typeof S.ondragover=="function"||typeof S.ondragout=="function"||S.dragOverClassName){U._dragOverTargets.push(S)}}if(U._dragOverTargets.length===0){U._dragOverTargets=false}}var O=I.DropTarget=F.createFactory(E,D);function E(Q){this.el=Q;this.id=Q.id}function D(){return{coords:undefined,dragOverClassName:"",initCoords:function(){if(!this.coords){this.coords={}}G.getOffsetCoords(this.el,document,this.coords);this.coords.w=this.el.clientWidth;this.coords.h=this.el.clientHeight},containsCoords:function(Q){var S=this.coords.x,R=this.coords.y;return(Q.x>=S&&Q.x<=S+this.coords.w)&&(Q.y>=R&&Q.y<=R+this.coords.h)},ondragover:false,ondragout:undefined,ondrop:undefined}}})();