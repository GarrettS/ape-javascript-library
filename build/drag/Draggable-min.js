APE.namespace("APE.drag");(function(){var E=self.APE,G=E.dom,I=E.drag,J=E.EventPublisher,K=1000,L={},F,O="function",B=E.createFactory(N,M);DropTarget=E.createFactory(D,C);I.Draggable=B;I.DropTarget=DropTarget;B.instanceDestructor=H;function N(Q){this.id=Q.id;this.el=this.origEl=Q;this.style=Q.style;this.isRel=G.getStyle(Q,"position").toLowerCase()=="relative";var R=(this.isRel?Q.parentNode:G.getContainingBlock(Q));if(R===null){R=document.documentElement}this.container=R;this.dropTargets=[];this.handle=Q;this.onbeforeexitcontainer=A;Q.style.zIndex=G.getStyle(Q,"zIndex")||K++;P(Q)}function A(){return !this.keepInContainer}function H(){var Q,S,R;for(Q in this.instances){R=this.instances[Q];for(S in R){if(R.hasOwnProperty(S)){delete R[S]}}delete this.instances[Q]}L={};dO=null}function P(W){var V=W.style,U,Q=G.getContainingBlock(W);if(G.IS_COMPUTED_STYLE){U=document.defaultView.getComputedStyle(W,"")}else{U=W.currentStyle||V}var S=U.left,X=U.right,T=U.top,R=U.bottom;if((S===""||S==="auto")){X=parseInt(X,10);if(isFinite(X)){V.left=Q.clientWidth-W.offsetWidth-X+"px"}else{V.left="0"}}if((T===""||T==="auto")){R=parseInt(R,10);if(isFinite(R)){V.top=Q.clientHeight-W.offsetHeight-R+"px"}else{V.top="0"}}}function M(){var AE=self.document,x="documentElement",a=AE[x].style,t="serSelect",AF="MozU"+t,h="MozU"+t,w="u"+t,n=AF in a?AF:h in a?h:w in a?w:"",Z="px",c="left",l="top",AC=false,W=0,V=0,v,o=false,g=25,p=-1,s=J.get(AE,"onmousedown");getEventCoords=G.Event.getCoords;if("onselectstart" in AE){J.get(AE,"onselectstart").addBefore(r)}else{s.addAfter(r);J.get(AE,"onmouseup").addAfter(S)}if("pixelLeft" in a){Z=0;c="pixelLeft";l="pixelTop"}s.add(f).addAfter(X);J.add(AE,"onkeypress",Q);J.add(AE,"onmousemove",m);J.add(AE,"onmouseup",Y);function r(d){if(v===null){S.call(this,d)}else{if(n){this[x].style[n]=v?"none":""}}}function S(d){if(n){this[x].style[n]=""}else{if(!d){window.event.returnValue=true}}}AE=a=null;function z(d,AH){return AH===d.handle||(d.useHandleTree&&G.contains(d.handle,AH))}function AB(d,AH){if(AH){if(d.selectedClassName){G.addClass(d.el,d.selectedClassName)}if(d.dragMultiple&&!(d.id in L)){L[d.id]=d}}else{if(d.selectedClassName){G.removeClass(d.el,d.selectedClassName)}delete L[d.id]}d.isSelected=AH}function j(AN,AM){var AH=AM.container,AJ=AM.el,AP=document,AI=AP.documentElement,AL=G.getContainingBlock(AJ)||AI,AK,AO,AQ=(AL===AH)?{x:0,y:0}:G.getOffsetCoords(AL,AH);pixelCoords=G.getPixelCoords(AJ),offsetFromParent=G.getOffsetCoords(AJ,AJ.parentNode),inFlowOffsetX=offsetFromParent.x-pixelCoords.x+AQ.x,inFlowOffsetY=offsetFromParent.y-pixelCoords.y+AQ.y;if(AM.keepInContainer){if(AH===AP.body){AK=parseInt(G.getStyle(AH,"width"),10);AO=parseInt(G.getStyle(AH,"height"),10)}else{AK=AH.clientWidth;AO=AH.clientHeight}AM.minX=0-inFlowOffsetX;AM.maxX=AK-AJ.offsetWidth-inFlowOffsetX;AM.minY=0-inFlowOffsetY;AM.maxY=AO-AJ.offsetHeight-inFlowOffsetY}}function u(){for(var d in L){AB(L[d],false)}}function R(){for(var d in L){return true}return false}function T(AJ,AM){q(AM);var AK=G.removeClass,AI,AH=0,d=o.length,AL;if(o!==false){for(;AH<d;AH++){AI=o[AH];if(AI.hasDropTargetOver){if(typeof AI.ondragout==O){AI.ondragout(AJ,AM)}if(AI.dragOverClassName){AK(AI.el,AI.dragOverClassName)}AI.hasDropTargetOver=false}}}for(AL in L){q(L[AL])}AM=null}function U(d,AH){if(d.activeDragClassName){G.removeClass(d.el,d.activeDragClassName)}if(typeof d.ondragend==O&&d.hasBeenDragged){d.ondragend(AH)}if(d.copyEl){d.el.parentNode.insertBefore(d.copyEl,d.el)}d.hasBeenDragged=false}function e(d,AH){if(AH){if(d.id in L){AB(d,false)}else{AB(d,true)}}else{if(!d.isSelected){u();AB(d,true)}}}function y(AH){var AJ="addClass",AL,AI=AH.el,AK=AI,d;if(!AH.copyEl){AH.origEl=AI;AH.copyEl=AI.cloneNode(true);AH.copyEl.id+="Copy"}AL=AH.copyEl;d=AL.style;d.display="";if(AL.parentNode!==AI.parentNode){AI.parentNode.insertBefore(AL,AI)}d.zIndex=parseInt(AK.style.zIndex)+100;if(AH.origClassName){G[AJ](AI,AH.origClassName)}AH.el=AL;AH.style=d;if(AH.isRel){d.marginBottom=-AK.offsetHeight+-(parseInt(G.getStyle(AK,"marginBottom"))||0)+"px";d.marginright=-AK.offsetWidth+-(parseInt(G.getStyle(AK,"marginRight"))||0)+"px"}}function AG(d){if(d.copyEl.style.display=="none"){return}d.el=d.origEl;d.style=d.origEl.style;d.moveToX(d.x);d.moveToY(d.y);d.copyEl.style.display="none";if(d.origClassName){G.removeClass(d.el,d.origClassName)}}function AA(AH,d){var AI,AJ;for(AJ in L){AI=L[AJ];if(AH!=null){AI.moveToX(AI.origX+AH)}if(d!=null){AI.moveToY(AI.origY+d)}}}function b(d,AH){if(d.isBeingDragged){return}if(d.dragCopy){y(d)}if(typeof d.ondragstart==O){d.ondragstart(AH)}if(d.activeDragClassName){G.addClass(d.el,d.activeDragClassName)}j(AH,d);d.isBeingDragged=true}function f(AK){if(!AK){AK=self.event}var AJ=G.Event.getTarget(AK),AH=null,AI=B.instances,d=AJ;for(;AH==null&&d;d=G.findAncestorWithAttribute(d,"id")){AH=AI[d.id]}var AL=AK.metaKey||AK.ctrlKey;if(AH){if(!AH.isDragEnabled){if(!AL){u()}return false}if(!AL&&AH.hasHandleSet&&!z(AH,AJ)){u();AH=null;return}else{if(!AL&&!AH.isSelected){u()}AK.returnValue=false}}else{if(!AL){u();if(v){AB(v,false);v=null}}return}if(AL&&v&&!AH.dragMultiple){AC=true;return false}if(!AH.dragMultiple){if(!AL){u()}else{AC=true;return false}}e(AH,AL);AH.style.zIndex=++K;if(AL){}v=AH;AD(AK,AH);for(var AM in L){AD(AK,L[AM])}return AJ.tagName!=="IMG"}function X(){if(!v){return}o=[];var AJ=v.dropTargets,AI,AH=0,d=AJ.length;for(;AH<d;AH++){AI=AJ[AH];AI.initCoords();if(typeof AI.ondragover==O||typeof AI.ondragout==O||AI.dragOverClassName){o.push(AI)}}if(o.length===0){o=false}}function AD(AJ,d){if(typeof d.onbeforedragstart==O&&d.onbeforedragstart(AJ)==false){return true}var AI=G.Event.getCoords(AJ),AH;W=AI.x;V=AI.y;AH=G.getPixelCoords(d.el);d.origX=d.grabX=AH.x;d.origY=d.grabY=AH.y;d.isBeingDragged=false}function m(AZ){if(v==null){return}var AJ=+new Date;if(AJ-p<g){return}p=AJ;AZ=AZ||window.event;var AN=getEventCoords(AZ),AV=AN.x,AS=AN.y,AR=AV-W,AP=AS-V,AL=false,Ab=v.origX+AR,Aa=v.origY+AP,AT;if(v.isBeingDragged==false){b(v,AZ);for(AT in L){b(L[AT],AZ)}}v.hasBeenDragged=(v.hasBeenDragged||(AR||AP));var AK=Ab<v.minX,AI=Ab>v.maxX,Ad=Aa<v.minY,AU=Aa>v.maxY,AH=v.container!=null,Ae=(typeof v.ondrag==O),d=typeof v.onbeforeexitcontainer==O,Ac=0;if(typeof v.onbeforedrag==O&&v.onbeforedrag(AZ)==false){return}AH&=(AK||AI||Ad||AU);if(AH&&(d||v.onbeforeexitcontainer()==false)){if(AK){if(!v.isAtLeft){v.moveToX(v.minX);AA(v.minX-v.origX,null);if(Ae){v.ondrag(AZ)}v.isAtRight=false;v.isAtLeft=true;Ac+=1}}else{if(AI){if(!v.isAtRight){v.moveToX(v.maxX);AA(v.maxX-v.origX,null);if(Ae){v.ondrag(AZ)}v.isAtRight=true;v.isAtLeft=false;Ac+=1}}else{v.isAtLeft=v.isAtRight=false;v.moveToX(Ab);AA(AR,null)}}if(Ad){if(!v.isAtTop){v.moveToY(v.minY);AA(null,v.minY-v.origY);if(Ae){v.ondrag(AZ)}v.isAtTop=true;v.isAtBottom=false;Ac+=1}}else{if(AU){if(!v.isAtBottom){if(v.maxY>0){v.moveToY(v.maxY)}AA(null,v.maxY-v.origY);if(Ae){v.ondrag(AZ)}v.isAtTop=false;v.isAtBottom=true;Ac+=1}}else{v.isAtTop=v.isAtBottom=false;v.moveToY(Aa);AA(null,AP)}}AL=Ac==2;if(AL&&typeof v.ondragstop==O){v.ondragstop(AZ)}else{if(Ae){v.ondrag(AZ)}}}else{AL=v.isAtLeft=v.isAtRight=v.isAtTop=v.isAtBottom=false;v.moveToX(Ab);v.moveToY(Aa);AA(AR,AP);if(Ae){v.ondrag(AZ)}}if(o!==false){var AY={x:AV,y:AS},AX=0,AW=o.length,AQ,AO,AM={domEvent:AZ,dragObj:v};for(;AX<AW;AX++){AQ=o[AX],AO=AQ.containsCoords(AY);if(!AQ.hasDropTargetOver&&AO){AQ.hasDropTargetOver=true;if(typeof AQ.ondragover==O){AQ.ondragover(AM)}if(AQ.dragOverClassName){G.addClass(AQ.el,AQ.dragOverClassName)}}else{if(AQ.hasDropTargetOver&&!AO){if(typeof AQ.ondragout==O){AQ.ondragout(AM)}if(AQ.dragOverClassName){G.removeClass(AQ.el,AQ.dragOverClassName)}AQ.hasDropTargetOver=false}}}}return false}function Y(AN){var AI=(v&&v.isBeingDragged&&!v.hasBeenDragged);if(v===null||!v.hasBeenDragged&&!AI){if(!AC){v=null}return}AC=false;if(!AN){AN=event}var AH,AR;if(v.copyEl){AG(v)}for(AH in L){AR=L[AH];if(AR.copyEl){AG(AR)}}var AL=v.dropTargets,AM=AL.length,AJ,AQ,AO;if(AM>0){var AP=getEventCoords(AN),d,AK=0;for(;AK<AM;AK++){d=AL[AK];if(d.containsCoords(AP)){d.containsCoords(AP);if(typeof d.ondrop==O){d.ondrop({domEvent:AN,dragObj:v,dropTarget:d})}for(AH in L){if(AH===d.id){continue}if(typeof d.ondrop==O){AJ=L[AH];d.ondrop({domEvent:AN,dragObj:AJ,dropTarget:d})}}if(d.dragOverClassName){G.removeClass(d.el,d.dragOverClassName)}break}}}for(AH in L){AJ=L[AH],AQ=AJ.x,AO=AJ.y;if(AQ<AJ.minX){AJ.moveToX(AJ.minX)}else{if(AQ>AJ.maxX){AJ.moveToX(AJ.maxX)}}if(AO<AJ.minY){AJ.moveToY(AJ.minY)}else{if(AO>AJ.maxY){AJ.moveToY(AJ.maxY)}}if(AJ.hasBeenDragged){U(AJ,AN)}}U(v,AN);v=null}function Q(d){d=d||self.event;if(d.keyCode==27){if(v){v.release(d)}}}function i(AI,d,AK){if(AI.animTimer){return}AI.startX=d;AI.startY=AK;var AJ=AI.startX-AI.grabX,AH=AI.startY-AI.grabY;AI.glideDist=Math.ceil(Math.sqrt((AJ*AJ)+(AH*AH)));if(AI.glideDist===0){return}AI.rx=Math.abs(AJ)/AI.glideDist;AI.ry=Math.abs(AH)/AI.glideDist;if(AI.x>AI.grabX){AI.rx=-AI.rx}if(AI.y>AI.grabY){AI.ry=-AI.ry}AI.startTime=+new Date;AI.animTimer=self.setInterval(function(){k(AI)},10)}function k(AH){var AI=new Date-AH.startTime,AJ=Math.ceil(2*AI+0.5*0.01*AI*AI);if(AJ>=AH.glideDist){AH.animTimer=self.clearInterval(AH.animTimer);AH.moveToX(AH.grabX);AH.moveToY(AH.grabY);if(AH.copyEl){AH.el=AH.origEl;AH.style=AH.origEl.style;AH.copyEl.style.display="none"}if(typeof AH.onglideend==O){AH.onglideend()}U(AH,{})}else{AH.moveToX(AH.startX+AJ*AH.rx);AH.moveToY(AH.startY+AJ*AH.ry)}}function q(AH,d,AI){i(AH,AH.x||d,AH.y||d)}return{dragCopy:false,dragMultiple:false,isSelected:false,onbeforedrag:F,onbeforedragstart:F,ondragstart:F,ondrag:F,ondragstop:F,ondragend:F,x:0,y:0,origX:0,origY:0,grabX:0,grabY:0,keepInContainer:false,isDragEnabled:true,selectedClassName:"",activeDragClassName:"",useHandleTree:true,hasHandleSet:false,setHandle:function(d,AH){this.handle=d;this.hasHandleSet=true;this.useHandleTree=AH!=false},addDropTarget:function(AJ){var AH=DropTarget.getByNode(AJ),d=AH.el,AI=this.dropTargets;if(this.el===d){return AH}return AI[AI.length]=DropTarget.getByNode(d)},grab:function(AL,AN,AJ){if(!AL){AL=self.event}var AP=G.Event,AM=AP.getTarget(AL);if(AL.preventDefault){AL.preventDefault()}AL.returnValue=false;if(G.contains(this.el,AM)){return}var AI=G.getPixelCoords(this.el);this.grabX=AI.x;this.grabY=AI.y;var AO=AP.getCoords(AL),AH=G.getOffsetCoords(G.getContainingBlock(this.el)),AK=AO.x-AH.x,d=AK-Math.floor((this.handle.offsetWidth/2));offsetY=AO.y-AH.y,newY=Math.floor(offsetY-(this.handle.offsetHeight/2)),handleOffsetCoords=G.getOffsetCoords(this.handle,this.el);if(this.keepInContainer){d=Math.max(d,0);d=Math.min(d,this.container.clientWidth-this.el.offsetWidth);newY=Math.max(newY,0);newY=Math.min(newY,this.container.clientHeight-this.el.offsetHeight)}this.moveToX(d-handleOffsetCoords.x+(AN||0));this.moveToY(newY-handleOffsetCoords.y+(AJ||0));AD(AL,this);v=this},release:function(d){T(d,this);if(typeof this.onrelease==O){this.onrelease(d)}},moveToX:function(d){this.style[c]=(this.x=d)+Z},moveToY:function(d){this.style[l]=(this.y=d)+Z},removeDropTarget:function(AJ){var AJ=document.getElementById(AJ.id),AH=this.dropTargets,AI,d;for(AI=0,d=AH.length;AI<d;AI++){if(AH[AI].el===AJ){AH.splice(AI,1);return AJ}}return null},toString:function(){return"Draggable(id="+this.id+")"}}}function D(Q){this.el=Q;this.id=Q.id}function C(){return{coords:F,dragOverClassName:"",initCoords:function(){if(!this.coords){this.coords={}}G.getOffsetCoords(this.el,document,this.coords);this.coords.w=this.el.clientWidth;this.coords.h=this.el.clientHeight},containsCoords:function(Q){var S=this.coords.x,R=this.coords.y;return(Q.x>=S&&Q.x<=S+this.coords.w)&&(Q.y>=R&&Q.y<=R+this.coords.h)},ondragover:false,ondragout:F,ondrop:F}}})();