APE.EventPublisher=function(B,A){this.src=B;this._callStack=[];this.type=A};APE.EventPublisher.prototype={add:function(B,A){this._callStack.push([B,A||this.src]);return this},addBefore:function(B,A){return APE.EventPublisher.add(this,"beforeFire",B,A||this.src)},addAfter:function(B,A){return APE.EventPublisher.add(this,"afterFire",B,A||this.src)},getEvent:function(A){return APE.EventPublisher.get(this,A)},remove:function(B,A){var E=this._callStack,C,D;if(!A){A=this.src}for(C=0;C<E.length;C++){D=E[C];if(D[0]===B&&D[1]===A){return E.splice(C,1)}}return null},removeBefore:function(B,A){return this.getEvent("beforeFire").remove(B,A||this.src)},removeAfter:function(B,A){return this.getEvent("afterFire").remove(B,A||this.src)},fire:function(A){return APE.EventPublisher.fire(this)(A)},toString:function(){return"APE.EventPublisher: {src="+this.src+", type="+this.type+", length="+this._callStack.length+"}"}};APE.EventPublisher.add=function(D,C,B,A){return APE.EventPublisher.get(D,C).add(B,A)};APE.EventPublisher.fire=function(B){return A;function A(H){var D=false,F,G=B._callStack,C;if(typeof B.beforeFire=="function"){try{if(B.beforeFire(H)==false){D=true}}catch(E){APE.deferError(E)}}for(F=0;F<G.length;F++){C=G[F];try{if(C[0].call(C[1],H)==false){D=true}}catch(E){APE.deferError(E)}}if(typeof B.afterFire=="function"){if(B.afterFire(H)==false){D=true}}return !D}};APE.EventPublisher.get=function(E,D){var C=this.Registry[D]||(this.Registry[D]=[]),A,B;for(A=0;A<C.length;A++){if(C[A].src===E){return C[A]}}B=new APE.EventPublisher(E,D);if(E[D]){B.add(E[D],E)}E[D]=this.fire(B);C[C.length]=B;return B};APE.EventPublisher.Registry={};APE.EventPublisher.cleanUp=function(){var C,E,D,B,A;for(C in this.Registry){E=this.Registry[C];for(B=0,A=E.length;B<A;B++){D=E[B];D.src[D.type]=null}}};if(window.CollectGarbage){APE.EventPublisher.get(window,"onunload").addAfter(APE.EventPublisher.cleanUp,APE.EventPublisher)};