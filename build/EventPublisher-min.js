(function(){var E=self.APE,B={};E.EventPublisher=D;E.mixin(D,{get:A,add:G,fire:C,cleanUp:F});function D(I,H){this.src=I;this._callStack=[];this.type=H}D.prototype={add:function(I,H){this._callStack.push([I,H||this.src]);return this},addBefore:function(I,H){return G(this,"beforeFire",I,H||this.src)},addAfter:function(I,H){return G(this,"afterFire",I,H||this.src)},getEvent:function(H){return A(this,H)},remove:function(I,H){var L=this._callStack,J,K;H=H||this.src;for(J=0;J<L.length;J++){K=L[J];if(K[0]===I&&K[1]===H){return L.splice(J,1)}}return null},removeBefore:function(I,H){return A(this,"beforeFire").remove(I,H||this.src)},removeAfter:function(I,H){return A(this,"afterFire").remove(I,H||this.src)},fire:function(H){return C(this)(H)},toString:function(){return"APE.EventPublisher: {src="+this.src+", type="+this.type+", length="+this._callStack.length+"}"}};function F(){var J,L,K,I,H;for(J in B){L=B[J];for(I=0,H=L.length;I<H;I++){K=L[I];K.src[K.type]=null}}}function G(K,J,I,H){return A(K,J).add(I,H)}function C(I){return H;function H(O){var K=false,M,N=I._callStack,J;if(typeof I.beforeFire=="function"){try{if(I.beforeFire(O)==false){K=true}}catch(L){E.deferError(L)}}for(M=0;M<N.length;M++){J=N[M];try{if(J[0].call(J[1],O)==false){K=true}}catch(L){E.deferError(L)}}if(typeof I.afterFire=="function"){if(I.afterFire(O)==false){K=true}}return !K}}function A(M,L){var K=B[L]||(B[L]=[]),I,H,J;for(I=0,H=K.length;I<H;I++){J=K[I];if(J.src===M){return J}}J=new D(M,L);if(M[L]){J.add(M[L],M)}M[L]=C(J);K[H]=J;return J}if(self.CollectGarbage){D.get(self,"onunload").addAfter(F,D)}})();