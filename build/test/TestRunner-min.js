APE.namespace("APE.test").defineCustomFactory("TestRunner",function(E){E.newInstance=function(){return E.getById(new Date)};E.runTests=V;function M(b){return a}function V(c){var e=TestRunnerFactory.getById("Test Runner"),b;e.addTestCase(c);F.add(e,"oncomplete",d);function d(){if(c.oncomplete){c.oncomplete()}else{b=new APE.test.TestReporter(e,document.body)}}e.start()}var F=APE.EventPublisher,D=Function.prototype,L={add:function(b){return A(this,b)},start:function(){W(this)},toString:function(){return this.name}};function X(b){b.testableList=b.queuedTestLoads=b.errorList.length=[]}function A(d,c,b){if(typeof c=="string"){Z(d,c,c)}else{b=b||c.name||d.name+"."+d.testableList.length;if(typeof c=="function"){c=new B(b,c,d)}d.testableList.push(c)}return d}function H(b){this.oncomplete=D;this.onload=D;this.onfail=null;this.name="";this.id="";this.add=L.add;this.start=L.start;this.toString=L.toString;this.addCallback=K}function T(c){var b=/[^A-Za-z0-9\-_:\.]+/g;return c.replace(b,":")}function K(b,c){F.add(this,b,c)}function a(){this.name="Test Runner";this.id=T(name);this.testableList=[];this.queuedTestLoads=[];this.errorList=[]}a.prototype=APE.createMixin(new H(),{addSuite:function(b){this.add(new S(b,this));return this},addTestCase:function(b){return this.add(new U(b,this))}});S.prototype=new H();U.prototype=new H();function W(d,c){c=c||0;var b=d.testableList[c];if(b){F.add(b,"oncomplete",e);b.start()}else{d.oncomplete()}function e(){if(this.errorList.length>0){d.errorList.push(new P({name:"TestError",message:""},this))}if(++c in d.testableList){W(d,c)}else{d.oncomplete()}}}function S(){this.testableList=[]}function U(b,c){this.testableList=[];this.queuedTestLoads=[];G(this,b);this.name=b.name||("TestCase:"+c.testableList.length);this.id=T(name);this.parent=c;this.errorList=[]}function G(c,d){var b,e;for(b in d){if(b.indexOf("test")===0){A(c,d[b],b)}}}function Z(c,b,d){var f={method:"GET",action:d},h=APE.ajax.AsyncRequest.getById(d,f),g=c.testableList.length;c.queuedTestLoads.push(h);F.add(h,"oncomplete",e);h.send();function e(){var l=h.req.responseText,k=h.id,j,i;if(l){j=Function("return ("+l+")")}else{j={};j["test "+k]=function(){return"Remote TestCase did not load. "+k}}c.add(j);if(c.queuedTestLoads.length==0){}}}function Y(f,d,e){var c=f.slice(e);var b=f.slice(0,e);b=b.concat(d,c);return b}var C=/@throws\s+([a-zA-Z_$]+[a-zA-Z_$]|$)/;function B(c,e,d){this.name=c||e.name||d.testableList.length;this.parent=d;this.id=T(c);this.func=e;this.shouldThrow=C.test(c);if(this.shouldThrow){var b=C.exec(c);this.expectedErrorName=b&&b[1]||""}this.testableList=[];this.errorList=[]}function N(f){var c,e,b="";if(f.func){try{f.func()}catch(d){e=true;I(f,d);b=d.stack||""}if(f.shouldThrow&&!e){c=f.expectedErrorName||"Some error";f.errorList.push(new P({name:"TestFailure",message:c+" expected but not thrown",stack:b},f))}}Q(f)}function I(c,b){if(c.shouldThrow){if(c.expectedErrorName&&c.expectedErrorName!==b.name){c.errorList.push(b)}}else{c.errorList.push(b)}}function Q(c){if(c.testableList.length){O(c,function(d){if(!d.done){F.add(d,"oncomplete",b)}else{if(R(c)){c.oncomplete()}}})}else{c.oncomplete()}function b(d){this.done=true;if(d){d=new P(d,this);c.errorList.push(d);c.oncomplete(d)}else{if(R(c)){c.oncomplete()}}}}function R(e){var c,d=e.testableList,b=d.length;for(c=0;c<b;c++){if(!d[c].done){return false}}return true}function O(f,e){var c,d=f.testableList,b=d.length;for(c=0;c<b;c++){e.call(f,d[c])}}function P(b,c){this.name=b.name;this.message=b.message;this.stack=b.stack||"(not available)"}B.prototype=APE.createMixin(new H(),{wait:function(g,d){var c="Wait "+this.testableList.length,b=new B(c,g),f=this;this.testableList.push(b);F.add(b,"oncomplete",e);b.startTimer=setTimeout(function(){b.start()},d);function e(h){if(h){f.errorList.push(h);f.oncomplete()}J(f)}},toString:function(){return"Test: "+this.name},start:function(){N(this)}});function J(b){O(b,function(c){clearTimeout(c.startTimer)})}return M});