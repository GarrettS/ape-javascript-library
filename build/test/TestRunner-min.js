APE.namespace("APE.test").defineCustomFactory("TestRunner",function(F){F.newInstance=function(){return F.getById(new Date)};function N(Z){Z.testSimple=C;return Y}function C(a){var c=TestRunnerFactory.getById("Test Runner"),Z;c.addTestCase(a);G.add(c,"oncomplete",b);function b(){if(a.oncomplete){a.oncomplete()}else{Z=new APE.test.TestReporter(c);Z.insertBefore(document.body)}}c.start()}var G=APE.EventPublisher,E=Function.prototype,M={add:function(Z){return A(this,Z)},start:function(){W(this)},toString:function(){return this.name}};function A(b,a,Z){if(typeof a=="string"){X(b,a,a)}else{Z=Z||a.name||b.name+"."+b.testableList.length;if(typeof a=="function"){a=new B(Z,a,b)}b.testableList.push(a)}return b}function I(Z){this.oncomplete=E;this.onload=E;this.onfail=null;this.name="";this.id="";this.add=M.add;this.start=M.start;this.toString=M.toString;this.addCallback=L;this.errorList=[]}function U(a){var Z=/[^A-Za-z0-9\-_:\.]+/g;return a.replace(Z,":")}function L(Z,a){G.add(this,Z,a)}function Y(){this.name="Test Runner";this.id=U(name);this.testableList=[];this.queuedTestLoads=[]}Y.prototype=APE.createMixin(new I(),{addSuite:function(Z){this.add(new T(Z,this));return this},addTestCase:function(Z){return this.add(new V(Z,this))}});T.prototype=new I();V.prototype=new I();function W(b,a){a=a||0;var Z=b.testableList[a];if(Z){G.add(Z,"oncomplete",c);Z.start()}else{b.oncomplete()}function c(){if(this.errorList.length>0){b.errorList.push(new Q({name:"TestError",message:""},this))}if(++a in b.testableList){W(b,a)}else{b.oncomplete()}}}function T(){this.testableList=[]}function V(Z,a){this.testableList=[];this.queuedTestLoads=[];H(this,Z);this.name=Z.name||("TestCase:"+a.testableList.length);this.id=U(name);this.parent=a}function H(a,b){var Z,c;for(Z in b){if(Z.indexOf("test")===0){A(a,b[Z],Z)}}}function X(a,Z,b){var d={method:"GET",action:b},f=APE.ajax.AsyncRequest.getById(b,d),e=a.testableList;a.queuedTestLoads.push(f);G.add(f,"oncomplete",c);f.send();function c(){alert("addRemoteTestToList called");var h=f.req.responseText,g;if(h){g=Function(h)}else{g=function(){return"Test did not load. "+f.id}}if(a.queuedTestLoads.length==0){a.onload()}a.queuedTestLoads.splice(e,1);a.testableList[e]=new B(Z,g)}}var D=/@throws\s*([a-zA-Z_$]+[a-zA-Z_$]|$)/;function B(Z,b,a){this.name=Z||b.name||a.testableList.length;this.parent=a;this.id=U(Z);this.func=b;this.shouldThrow=D.test(Z);if(this.shouldThrow){this.expectedErrorName=expectedErrorName[1]||""}this.testableList=[];this.errorList=[]}function O(d){var a,c,Z="";if(d.func){try{d.func()}catch(b){c=true;J(d,b);Z=b.stack||""}if(d.shouldThrow&&!c){a=d.expectedErrorName||"Some error";d.errorList.push(new Q({name:"TestFailure",message:a+" expected but not thrown",stack:Z},d));console.log(d.errorList[0])}}R(d)}function J(a,Z){if(a.shouldThrow){if(a.expectedErrorName&&a.expectedErrorName!==Z.name){a.errorList.push(Z)}}else{a.errorList.push(Z)}}function R(a){if(a.testableList.length){P(a,function(b){if(!b.done){G.add(b,"oncomplete",Z)}else{if(S(a)){a.oncomplete()}}})}else{a.oncomplete()}function Z(b){this.done=true;if(b){b=new Q(b,this);a.errorList.push(b);a.oncomplete(b)}else{if(S(a)){a.oncomplete()}}}}function S(c){var a,b=c.testableList,Z=b.length;for(a=0;a<Z;a++){if(!b[a].done){return false}}return true}function P(d,c){var a,b=d.testableList,Z=b.length;for(a=0;a<Z;a++){c.call(d,b[a])}}function Q(Z,a){this.name=Z.name;this.message=Z.message;this.stack=Z.stack||"(not available)"}B.prototype=APE.createMixin(new I(),{wait:function(e,b){var a="Wait "+this.testableList.length,Z=new B(a,e),d=this;this.testableList.push(Z);G.add(Z,"oncomplete",c);Z.startTimer=setTimeout(function(){Z.start()},b);function c(f){if(f){d.errorList.push(f);d.oncomplete()}K(d)}},toString:function(){return"Test: "+this.name},start:function(){O(this)}});function K(Z){P(Z,function(a){clearTimeout(a.startTimer)})}return N});