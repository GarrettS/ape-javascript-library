APE.namespace("APE.test").defineCustomFactory("TestRunner",function(E){E.newInstance=function(){return E.getById(new Date)};E.runTests=X;function N(c){return b}function X(d){var f=TestRunnerFactory.getById("Test Runner"),c;f.addTestCase(d);F.add(f,"oncomplete",e);function e(){if(d.oncomplete){d.oncomplete()}else{c=new APE.test.TestReporter(f,document.body)}}f.start()}var F=APE.EventPublisher,D=Function.prototype,M={add:function(c){return A(this,c)},start:function(){Y(this)},toString:function(){return this.name}};function A(e,d,c){if(typeof d=="string"){a(e,d,d)}else{c=c||d.name||e.name+"."+e.testableList.length;if(typeof d=="function"){d=new B(c,d,e)}e.testableList.push(d)}return e}function I(c){this.oncomplete=D;this.onload=D;this.onfail=null;this.name="";this.id="";this.add=M.add;this.start=M.start;this.toString=M.toString;this.addCallback=L}function V(d){var c=/[^A-Za-z0-9\-_:\.]+/g;return d.replace(c,":")}function L(c,d){F.add(this,c,d)}function b(){this.name="Test Runner";this.id=V(name);this.testableList=[];this.queuedTestLoads=[];this.errorList=[]}b.prototype=APE.createMixin(new I(),{addSuite:function(c){this.add(new T(c,this));return this},addTestCase:function(c){return this.add(new W(c,this))}});T.prototype=new I();W.prototype=new I();function Y(e,d){d=d||0;var c=e.testableList[d];if(c){F.add(c,"oncomplete",f);if(e.setUp){U(e)}c.start()}else{e.oncomplete()}function f(){if(e.tearDown){G(e)}if(this.errorList.length>0){e.errorList.push(new Q({name:"TestError",message:""},this))}if(++d in e.testableList){Y(e,d)}else{e.oncomplete()}}}function U(c){try{c.setUp()}catch(d){e(c,d)}function e(f,g){f.errorList.push(new Q({name:"TestError",message:"setUp for testcase '"+f.name+"' threw "+g.name+" "+g.message},this));f.oncomplete()}}function G(c){try{c.tearDown()}catch(d){e(c,d)}function e(f,g){f.errorList.push(new Q({name:"TestError",message:"tearDown for testcase '"+f.name+"' threw "+g.name+" "+g.message},this));f.oncomplete()}}function T(){this.testableList=[]}function W(c,d){this.testableList=[];this.queuedTestLoads=[];H(this,c);this.name=c.name||("TestCase:"+d.testableList.length);this.setUp=c.setUp;this.tearDown=c.tearDown;this.id=V(name);this.parent=d;this.errorList=[]}function H(d,e){var c,f;for(c in e){if(c.indexOf("test")===0){A(d,e[c],c)}}}function a(d,c,e){var g={method:"GET",action:e},i=APE.ajax.AsyncRequest.getById(e,g),h=d.testableList.length;d.queuedTestLoads.push(i);F.add(i,"oncomplete",f);i.send();function f(){var m=i.req.responseText,l=i.id,k,j;if(m){k=Function("return ("+m+")")}else{k={};k["test "+l]=function(){return"Remote TestCase did not load. "+l}}d.add(k);if(d.queuedTestLoads.length==0){}}}function Z(g,e,f){var d=g.slice(f);var c=g.slice(0,f);c=c.concat(e,d);return c}var C=/@throws\s+([a-zA-Z_$]+[a-zA-Z_$]|$)/;function B(d,f,e){this.name=d||f.name||e.testableList.length;this.parent=e;this.id=V(d);this.func=f;this.shouldThrow=C.test(d);if(this.shouldThrow){var c=C.exec(d);this.expectedErrorName=c&&c[1]||""}this.testableList=[];this.errorList=[]}function O(g){var d,f,c="";if(g.func){try{g.func()}catch(e){f=true;J(g,e);c=e.stack||""}if(g.shouldThrow&&!f){d=g.expectedErrorName||"Some error";g.errorList.push(new Q({name:"TestFailure",message:d+" expected but not thrown",stack:c},g))}}R(g)}function J(d,c){if(d.shouldThrow){if(d.expectedErrorName&&d.expectedErrorName!==c.name){d.errorList.push(c)}}else{d.errorList.push(c)}}function R(d){if(d.testableList.length){P(d,function(e){if(!e.done){F.add(e,"oncomplete",c)}else{if(S(d)){d.oncomplete()}}})}else{d.oncomplete()}function c(e){this.done=true;if(e){e=new Q(e,this);d.errorList.push(e);d.oncomplete(e)}else{if(S(d)){d.oncomplete()}}}}function S(f){var d,e=f.testableList,c=e.length;for(d=0;d<c;d++){if(!e[d].done){return false}}return true}function P(g,f){var d,e=g.testableList,c=e.length;for(d=0;d<c;d++){f.call(g,e[d])}}function Q(c,d){this.name=c.name;this.message=c.message;this.stack=c.stack||"(not available)"}B.prototype=APE.createMixin(new I(),{wait:function(h,e){var d="Wait "+this.testableList.length,c=new B(d,h),g=this;this.testableList.push(c);F.add(c,"oncomplete",f);c.startTimer=setTimeout(function(){c.start()},e);function f(i){if(i){g.errorList.push(i);g.oncomplete()}K(g)}},toString:function(){return"Test: "+this.name},start:function(){O(this)}});function K(c){P(c,function(d){clearTimeout(d.startTimer)})}return N});