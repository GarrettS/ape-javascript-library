APE.namespace("APE.test").defineCustomFactory("TestRunner",function(E){E.runTests=c;E.wait=function(h,g){if(J&&J.wait){J.wait(h,g)}};E.waitForCondition=function(l,k,g){if(J&&J.wait){var h=g||4000,i,j=setInterval(function(){if(l()){i=true;clearInterval(j);k()}},100);J.wait(function(){clearInterval(j);if(i){return}R.fail("Condition not met after "+h+"ms")},h)}};function P(g){return f}function c(g){var h=E.getById("Test Runner");G(h,g);new APE.test.TestReporter(h,document.body);h.start()}function G(j,g){if(typeof g[0]=="object"){for(var h=0;h<g.length;h++){j.addTestCase(g[h])}}else{j.addTestCase(g)}}var J,R=APE.test.Assert,F=APE.EventPublisher,D=Function.prototype,O={add:function(g){return A(this,g)},start:function(){d(this)},toString:function(){return this.name}};function A(i,h,g){g=g||h.name||i.name+"."+i.testableList.length;if(typeof h=="function"){h=new B(g,h,i)}i.testableList.push(h);return i}function K(g){this.oncomplete=D;this.onload=D;this.onfail=null;this.name="";this.id="";this.add=O.add;this.start=O.start;this.toString=O.toString;this.addCallback=N}function Y(h){var g=/[^A-Za-z0-9\-_:\.]+/g;return h.replace(g,":")}function N(g,h){F.add(this,g,h)}function f(){this.name="Test Runner";this.id=Y(this.name);this.testableList=[];this.queuedTestLoads=[];this.errorList=[]}f.prototype=APE.createMixin(new K(),{addSuite:function(g){this.add(new W(g,this));return this},addTestCase:function(g){return this.add(new a(g,this))},addRemoteTestCase:function(g){b(this,g)}});W.prototype=new K();a.prototype=new K();function d(i,h){h=h||0;var g=i.testableList[h];if(g){F.add(g,"oncomplete",j);if(i.setUp){X(i)}g.start();J=g}else{i.oncomplete()}function j(){if(i.tearDown){H(i)}if(this.errorList.length>0){i.errorList.push(new T({name:"TestError",message:""},this))}if(++h in i.testableList){d(i,h)}else{i.oncomplete()}}}function X(g){try{g.setUp()}catch(h){i(g,h)}function i(j,k){j.errorList.push(new T({name:"TestError",message:"setUp for testcase '"+j.name+"' threw "+k.name+" "+k.message},this));j.oncomplete()}}function H(g){try{g.tearDown()}catch(h){i(g,h)}function i(j,k){j.errorList.push(new T({name:"TestError",message:"tearDown for testcase '"+j.name+"' threw "+k.name+" "+k.message},this));j.oncomplete()}}function W(){this.testableList=[]}function a(g,h){this.testableList=[];this.queuedTestLoads=[];I(this,g);this.name=g.name||("TestCase:"+h.testableList.length);this.setUp=g.setUp;this.tearDown=g.tearDown;this.id=Y(this.name);this.parent=h;this.errorList=[]}function I(h,i){var g;for(g in i){if(g.indexOf("test")===0){A(h,i[g],g)}}}function b(g,h){var j={method:"GET",action:h},l=APE.ajax.AsyncRequest.getById(h,j),k=g.testableList.length;g.queuedTestLoads.push(l);F.add(l,"oncomplete",i);l.send();function i(){var q=l.req.responseText,p=l.id,o,m;if(q){try{o=Function("return ("+q+")")()}catch(n){o=Z(p)}}else{o=Z()}g.add(o);if(g.queuedTestLoads.length==0){g.onload()}}}function Z(h){h=h||"";var g={};g["test "+h]=function(){return"Remote TestCase did not load. "+h};return g}function e(k,i,j){var h=k.slice(j);var g=k.slice(0,j);g=g.concat(i,h);return g}var C=/@throws\s+([a-zA-Z_$]+[a-zA-Z_$]|$)/;function B(h,j,i){this.name=h||j.name||i.testableList.length;this.parent=i;this.id=Y(h);this.func=j;this.shouldThrow=C.test(h);if(this.shouldThrow){var g=C.exec(h);this.expectedErrorName=g&&g[1]||""}this.testableList=[];this.errorList=[]}function Q(k){var h,j,g="";if(k.func){try{k.func()}catch(i){j=true;L(k,i);g=i.stack||""}if(k.shouldThrow&&!j){h=k.expectedErrorName||"Some error";k.errorList.push(new T({name:"TestFailure",message:h+" expected but not thrown",stack:g},k))}}U(k)}function L(h,g){if(h.shouldThrow){if(h.expectedErrorName&&h.expectedErrorName!==g.name){h.errorList.push(g)}}else{h.errorList.push(g)}}function U(h){if(h.testableList.length){S(h,function(i){if(!i.done){F.add(i,"oncomplete",g)}else{if(V(h)){h.oncomplete()}}})}else{h.oncomplete()}function g(i){this.done=true;if(i){i=new T(i,this);h.errorList.push(i);h.oncomplete(i)}else{if(V(h)){h.oncomplete()}}}}function V(k){var h,j=k.testableList,g=j.length;for(h=0;h<g;h++){if(!j[h].done){return false}}return true}function S(l,k){var h,j=l.testableList,g=j.length;for(h=0;h<g;h++){k.call(l,j[h])}}function T(g,h){this.name=g.name;this.message=g.message;this.stack=g.stack||"(not available)"}B.prototype=APE.createMixin(new K(),{wait:function(l,i){var h="Wait "+this.testableList.length,g=new B(h,l),k=this;this.testableList.push(g);F.add(g,"oncomplete",j);g.startTimer=setTimeout(function(){g.start()},i);function j(m){if(m){k.errorList.push(m);k.oncomplete()}M(k)}},toString:function(){return"Test: "+this.name},start:function(){Q(this)}});function M(g){S(g,function(h){clearTimeout(h.startTimer)})}return P});