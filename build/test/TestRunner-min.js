APE.namespace("APE.test").defineCustomFactory("TestRunner",function(E){E.newInstance=function(){return E.getById(new Date)};E.runTests=Z;function N(d){return c}function Z(e){var g=TestRunnerFactory.getById("Test Runner"),d;g.addTestCase(e);F.add(g,"oncomplete",f);function f(){if(e.oncomplete){e.oncomplete()}else{d=new APE.test.TestReporter(g,document.body)}}g.start()}var F=APE.EventPublisher,D=Function.prototype,M={add:function(d){return A(this,d)},start:function(){a(this)},toString:function(){return this.name}};function A(f,e,d){d=d||e.name||f.name+"."+f.testableList.length;if(typeof e=="function"){e=new B(d,e,f)}f.testableList.push(e);return f}function I(d){this.oncomplete=D;this.onload=D;this.onfail=null;this.name="";this.id="";this.add=M.add;this.start=M.start;this.toString=M.toString;this.addCallback=L}function V(e){var d=/[^A-Za-z0-9\-_:\.]+/g;return e.replace(d,":")}function L(d,e){F.add(this,d,e)}function c(){this.name="Test Runner";this.id=V(this.name);this.testableList=[];this.queuedTestLoads=[];this.errorList=[]}c.prototype=APE.createMixin(new I(),{addSuite:function(d){this.add(new T(d,this));return this},addTestCase:function(d){return this.add(new X(d,this))},addRemoteTestCase:function(d){Y(this,d)}});T.prototype=new I();X.prototype=new I();function a(f,e){e=e||0;var d=f.testableList[e];if(d){F.add(d,"oncomplete",g);if(f.setUp){U(f)}d.start()}else{f.oncomplete()}function g(){if(f.tearDown){G(f)}if(this.errorList.length>0){f.errorList.push(new Q({name:"TestError",message:""},this))}if(++e in f.testableList){a(f,e)}else{f.oncomplete()}}}function U(d){try{d.setUp()}catch(e){f(d,e)}function f(g,h){g.errorList.push(new Q({name:"TestError",message:"setUp for testcase '"+g.name+"' threw "+h.name+" "+h.message},this));g.oncomplete()}}function G(d){try{d.tearDown()}catch(e){f(d,e)}function f(g,h){g.errorList.push(new Q({name:"TestError",message:"tearDown for testcase '"+g.name+"' threw "+h.name+" "+h.message},this));g.oncomplete()}}function T(){this.testableList=[]}function X(d,e){this.testableList=[];this.queuedTestLoads=[];H(this,d);this.name=d.name||("TestCase:"+e.testableList.length);this.setUp=d.setUp;this.tearDown=d.tearDown;this.id=V(this.name);this.parent=e;this.errorList=[]}function H(e,f){var d,g;for(d in f){if(d.indexOf("test")===0){A(e,f[d],d)}}}function Y(d,e){var g={method:"GET",action:e},i=APE.ajax.AsyncRequest.getById(e,g),h=d.testableList.length;d.queuedTestLoads.push(i);F.add(i,"oncomplete",f);i.send();function f(){var n=i.req.responseText,m=i.id,l,j;if(n){try{l=Function("return ("+n+")")()}catch(k){l=W(m)}}else{l=W()}d.add(l);if(d.queuedTestLoads.length==0){d.onload()}}}function W(e){e=e||"";var d={};d["test "+e]=function(){return"Remote TestCase did not load. "+e};return d}function b(h,f,g){var e=h.slice(g);var d=h.slice(0,g);d=d.concat(f,e);return d}var C=/@throws\s+([a-zA-Z_$]+[a-zA-Z_$]|$)/;function B(e,g,f){this.name=e||g.name||f.testableList.length;this.parent=f;this.id=V(e);this.func=g;this.shouldThrow=C.test(e);if(this.shouldThrow){var d=C.exec(e);this.expectedErrorName=d&&d[1]||""}this.testableList=[];this.errorList=[]}function O(h){var e,g,d="";if(h.func){try{h.func()}catch(f){g=true;J(h,f);d=f.stack||""}if(h.shouldThrow&&!g){e=h.expectedErrorName||"Some error";h.errorList.push(new Q({name:"TestFailure",message:e+" expected but not thrown",stack:d},h))}}R(h)}function J(e,d){if(e.shouldThrow){if(e.expectedErrorName&&e.expectedErrorName!==d.name){e.errorList.push(d)}}else{e.errorList.push(d)}}function R(e){if(e.testableList.length){P(e,function(f){if(!f.done){F.add(f,"oncomplete",d)}else{if(S(e)){e.oncomplete()}}})}else{e.oncomplete()}function d(f){this.done=true;if(f){f=new Q(f,this);e.errorList.push(f);e.oncomplete(f)}else{if(S(e)){e.oncomplete()}}}}function S(g){var e,f=g.testableList,d=f.length;for(e=0;e<d;e++){if(!f[e].done){return false}}return true}function P(h,g){var e,f=h.testableList,d=f.length;for(e=0;e<d;e++){g.call(h,f[e])}}function Q(d,e){this.name=d.name;this.message=d.message;this.stack=d.stack||"(not available)"}B.prototype=APE.createMixin(new I(),{wait:function(i,f){var e="Wait "+this.testableList.length,d=new B(e,i),h=this;this.testableList.push(d);F.add(d,"oncomplete",g);d.startTimer=setTimeout(function(){d.start()},f);function g(j){if(j){h.errorList.push(j);h.oncomplete()}K(h)}},toString:function(){return"Test: "+this.name},start:function(){O(this)}});function K(d){P(d,function(e){clearTimeout(e.startTimer)})}return N});