APE.namespace("APE.test").TestRunner=(function(){var Y=APE.test,Q=Y.Assert,K,H=APE.EventPublisher,F=Function.prototype,O={add:function(c,b){b=b||c.name||this.name;if(typeof c=="function"){c=new B(b,c,this)}this.testableList.push(c);return c},start:function(){X(this)},toString:function(){return this.name}};function L(b){this.oncomplete=F;this.onfail=null;this.name="";this.id="";this.add=O.add;this.start=O.start;this.toString=O.toString}function a(){this.name="Test Runner";this.id=T(this.name+" "+(+new Date));this.testableList=[];this.queuedTestLoads=[];this.errorList=[];this.addTestCase=function(b){return this.add(new V(b,this))}}a.prototype=new L;var G=APE.createMixin(new a,{assert:function(c,b){K.hasAssert=true;Q.that(c,b)},fail:function(b){Q.fail(b)},runTests:function(b){var c=new a;I(c,b);new Y.TestReporter(c,document.body);c.start()},wait:function(c,b){if(K&&K.wait){K.wait(c,b)}},exitEarly:function(c){if(!c){throw TypeError("TestRunner.exitEarly(msg) called with no message")}var b=new D(c);this.earlyExitMessage=b.message;throw b},waitForCondition:function(g,f,b){if(K&&K.wait){var c=b||4000,d,e=setInterval(function(){if(g()){d=true;clearInterval(e);f()}},100);K.wait(function(){clearInterval(e);if(d){return}Q.fail("Condition not met after "+c+"ms")},c)}}});function D(b){this.reason=b}function I(f,c){var d,e,b;if(typeof c[0]=="object"){for(d=0;d<c.length;d++){b=f.addTestCase(c[d]);if(e){e.nextSibling=b}e=b}}else{f.addTestCase(c)}}function T(c){var b=/[^A-Za-z0-9\-_:\.]+/g;return c.replace(b,":")}V.prototype=APE.createMixin(new L,{buildTestableList:function(c){var e,b,d;for(b in c){if(b.indexOf("test")===0){e=this.add(c[b],b);if(d){d.nextSibling=e}d=e}}},toString:function(){return"TestCase: "+this.name}});function X(c,b){b=b||c.testableList[0];if(b){H.addCallback(b,"oncomplete",N);if(c.setUp){S(c)}if(b instanceof B){K=b}b.start()}else{c.oncomplete()}}function N(){var b=this.parent;if(b.tearDown){b.tearDownError=J(b);if(b.tearDownError){return}}if(this.nextSibling){X(b,this.nextSibling)}else{if(this instanceof B){C(this)}b.oncomplete()}}function C(b){if(!b.hasAssert&&!b.earlyExitMessage&&!b.errorList.length){W(b,new Z(b))}}function S(b){try{b.setUp()}catch(c){d(b,c)}function d(e,f){W(e,new R({name:"TestError",message:"setUp for testcase '"+e.name+"' threw "+f.name+" "+f.message}));e.oncomplete()}}function J(b){var d;try{b.tearDown()}catch(e){return c(b,e)}function c(f,g){d=new R({name:"TestError",message:"tearDown for testcase '"+f.name+"' threw "+g.name+" "+g.message});W(f,d);f.oncomplete();return d}}function V(b,c){this.testableList=[];this.queuedTestLoads=[];this.buildTestableList(b);this.name=b.name;this.setUp=b.setUp;this.tearDown=b.tearDown;this.id=T(this.name||"unnamed");this.parent=c;this.errorList=[]}function U(c){c=c||"";var b={};b["test "+c]=function(){return"Remote TestCase did not load. "+c};return b}var E=/@throws\s+([a-zA-Z_$]+[a-zA-Z_$]|$)/;function B(c,e,d){this.name=c||e.name||d.testableList.length;this.parent=d;this.rootTest=(d instanceof V)?this:d.rootTest;this.id=T(c);this.func=e;this.shouldThrow=E.test(c);if(this.shouldThrow){var b=E.exec(c);this.expectedErrorName=b&&b[1]||""}this.errorList=[]}function P(g){var f,c,e,b="";if(g.func){try{g.func()}catch(d){if(d instanceof D){g.earlyExit=D.message;g.oncomplete();return}else{if(d instanceof A){return}}e=true;M(g,d);b=d.stack||""}if(g.shouldThrow&&!e){f=g.expectedErrorName||"Some error";c=new R({name:"TestFailure",message:f+" expected but not thrown",stack:b});W(g,c)}g.oncomplete()}}function W(c,b){for(;c;c=c.parent){c.errorList.push(b)}}function M(c,b){if(c.shouldThrow){if(c.expectedErrorName&&c.expectedErrorName!==b.name){W(c,b)}}else{W(c,b)}}function R(b){this.name=b.name;this.message=b.message;this.stack=b.stack||"(not available)"}(R.prototype=new Error).constructor=R;function Z(b){this.name="NoAssertionMadeError";this.message='"'+b.toString()+'". Expected a call to TestRunner.assert.'}(Z.prototype=new Error).constructor=Z;B.prototype=APE.createMixin(new L(),{wait:function(g,d){var c="Wait",b=new B(c,g,this),f=this;H.addCallback(b,"oncomplete",e);b.startTimer=setTimeout(function(){b.start()},d);function e(h){if(h){W(f,h)}f.oncomplete()}throw new A()},toString:function(){return"Test: "+this.name},start:function(){P(this)}});function A(){}(A.prototype=new Error).constructor=A;return G}());