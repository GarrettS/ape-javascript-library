APE.namespace("APE.ajax");(function(){APE.ajax.AsyncRequest=APE.createFactory(K,G);function K(N,L){this.id=N;this.httpMethod=L.method&&L.method.toLowerCase()||"get";this.uri=L.action;if(!this.uri){throw URIError("formConfig.action = undefined")}this.enctype=L.enctype;if(!this.enctype&&this.httpMethod=="post"){this.enctype=A}this.req=J();this.config={};for(var M in L){this.config[M]=L[M]}}var A="application/x-www-form-urlencoded",E="XMLHttpRequest",H="ActiveXObject",I=(E in self)?E:H,F=0,B=E==I,D=[];function J(){var M,N,L;for(N=0;N<4;N++){M=D[N];if(!M){return D[N]=C()}else{L=M.readyState;if(L===4){M.abort()}if(L===0){return M}}}return C()}function C(){return B?new self[I]:new self[I]("Microsoft.XMLHTTP")}function G(){var M=Function.prototype;function O(R){R.timerId=setInterval(P,50);if(R.timeoutMillis>0){var Q=function(){R.ontimeout();R.req.abort();L(R);R.req.onreadystatechange=M};R.timeoutID=setTimeout(Q,R.timeoutMillis)}function P(){if(R.req.readyState===4){N(R)}}}function N(P){var R=P.req,Q=R.status,S=Q>=200&&Q<300||Q==304||Q==1223;if(S){L(P,true);P.onsucceed(R)}else{L(P,false);P.onfail(R)}P.timerId=clearInterval(P.timerId)}function L(P,Q){P.oncomplete({successful:Q})}return{onabort:M,oncomplete:M,onsucceed:M,onfail:M,ontimeout:M,onsend:M,timeoutMillis:0,send:function(R,S){var Q=this.uri,T;this.timeoutMillis=S|0||4000;if(this.httpMethod=="get"&&typeof R=="string"){Q+=R}this.req.open(this.httpMethod,Q,true);O(this);if("setRequestHeader" in this.req){this.req.setRequestHeader("X-REQUESTED-WITH","XMLHttpRequest");if(this.httpMethod=="post"){if(typeof R=="string"){this.req.setRequestHeader("Content-Type",this.enctype)}else{if(R&&typeof R.unshift=="function"&&this.enctype=="multipart/form-data"){T="---------------------------DATA_"+(++F)+"\n";R=T+R.join(T)+T;this.req.setRequestHeader("Content-Type",this.enctype+"; "+T)}}}}try{this.onsend();this.req.send(R||null)}catch(P){this.onfail(P)}return this},abort:function(){this.req.abort();clearTimeout(this.timeoutID);this.onabort(this.req);L(this,false)},toString:function(){var Q="AsyncRequest: \nuri: "+this.uri+"\nmethod: "+this.httpMethod+"\n----------------------\nreq: \n",R;for(R in this.req){try{if(typeof this.req[R]=="string"){Q.concat(R+": "+this.req[R]+"\n")}}catch(P){}}return Q}}}})();